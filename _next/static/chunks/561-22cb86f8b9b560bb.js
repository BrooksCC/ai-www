"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[561],{3315:(e,t,r)=>{r.d(t,{L:()=>m});var n=r(2115),a=r(822),l=r(9161),s=r.n(l),i=function(e){return e.ENGLISH="ENGLISH",e.CURLY="CURLY",e.GUILLEMETS="GUILLEMETS",e.CORNER="CORNER",e.WHITE_CORNER="WHITE_CORNER",e.FULLWIDTH="FULLWIDTH",e}(i||{}),o=function(e){return e[e.USER_INPUT=0]="USER_INPUT",e[e.AI_OUTPUT=1]="AI_OUTPUT",e[e.SLASH_COMMAND=2]="SLASH_COMMAND",e[e.WORLD_INFO=3]="WORLD_INFO",e[e.AUTHOR_NOTE=4]="AUTHOR_NOTE",e[e.INSTRUCT=5]="INSTRUCT",e[e.RAW_INPUT=6]="RAW_INPUT",e[e.REPLACEMENT=7]="REPLACEMENT",e[e.REASONING=8]="REASONING",e}({});class c{setVariable(e,t){this.environment[e]=t}addRegexRule(e){this.regexRules.push(e)}format(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return"";let r=this.substituteVariables(e);if(r=this.applyRegexRules(r,1,t),r=this.processQuotes(r),!1!==t.isMarkdown&&(r=this.convertMarkdown(r)),r=this.encodeStyleTags(r),!t.skipSanitize){let e={ALLOWED_TAGS:["div","span","a","p","br","strong","em","b","i","ul","ol","li","code","pre","blockquote","q","img","h1","h2","h3","h4","h5","h6","table","thead","tbody","tr","th","td","hr","del","ins","mark","custom-style","sup","sub"],ALLOWED_ATTR:["href","src","class","style","title","alt","target","rel","id","width","height"],ADD_TAGS:["custom-style"],ADD_ATTR:["target","rel"],FORBID_TAGS:["style","script"],FORBID_ATTR:["onerror","onload","onclick"]};t.allowUnsafeHTML&&(e.ALLOW_UNKNOWN_PROTOCOLS=!0,e.ALLOW_ARIA_ATTR=!0);let n=a.A.sanitize(r,e);r="string"==typeof n?n:String(n)}return r=this.decodeStyleTags(r),r=this.cleanupEmptyElements(r)}substituteVariables(e){var t,r;if(!e)return"";let n=e;for(let e in this.environment)if(Object.prototype.hasOwnProperty.call(this.environment,e)){let t=this.environment[e],r=RegExp("{{".concat(this.escapeRegex(e),"}}"),"gi");n=n.replace(r,"function"==typeof t?t():t.toString())}return(n=n.replace(/<USER>/gi,(null==(t=this.environment.user)?void 0:t.toString())||"")).replace(/<CHAR>/gi,(null==(r=this.environment.char)?void 0:r.toString())||"")}applyRegexRules(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e||0===this.regexRules.length)return e;let n=e;for(let e of this.regexRules.filter(e=>!e.disabled&&e.placement.includes(t)&&(!e.markdownOnly&&!e.promptOnly||e.markdownOnly&&r.isMarkdown||e.promptOnly&&r.isPrompt)&&(!r.isEdit||!1!==e.runOnEdit)&&(void 0===r.depth||void 0===e.minDepth||r.depth>=e.minDepth)&&(void 0===r.depth||void 0===e.maxDepth||r.depth<=e.maxDepth)))try{let t=RegExp(e.find,"g");n="string"==typeof e.replace?n.replace(t,e.replace):n.replace(t,function(t){for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return(0,e.replace)(t,...n)})}catch(t){console.error('正则表达式规则 "'.concat(e.name,'" 应用失败:'),t)}return n}processQuotes(e){return e?e=(e=(e=e.replace(/<([^>]+)>/g,(e,t)=>"<"+t.replace(/"/g,"￾")+">")).replace(/```[\s\S]*?```|``[\s\S]*?``|`[\s\S]*?`|(".*?")|(\u201C.*?\u201D)|(\u00AB.*?\u00BB)|(\u300C.*?\u300D)|(\u300E.*?\u300F)|(\uFF02.*?\uFF02)/gm,(e,t,r,n,a,l,s)=>{if(t)return'<q>"'.concat(t.slice(1,-1),'"</q>');if(r)return'<q>"'.concat(r.slice(1,-1),'"</q>');if(n)return"<q>\xab".concat(n.slice(1,-1),"\xbb</q>");if(a)return"<q>「".concat(a.slice(1,-1),"」</q>");if(l)return"<q>『".concat(l.slice(1,-1),"』</q>");else if(s)return"<q>＂".concat(s.slice(1,-1),"＂</q>");else return e})).replace(/\ufffe/g,'"'):""}convertMarkdown(e){if(!e)return"";e=(e=e.replaceAll("\\begin{align*}","$$")).replaceAll("\\end{align*}","$$");let t=this.converter.makeHtml(e);return(t=(t=(t=(t=(t=t.replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/\n/gm,"\0"))).replace(/\u0000/g,"\n")).replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/&amp;/g,"&"))).replace(/<pre><code(.*?)>([\s\S]*?)<\/code><\/pre>/g,(e,t,r)=>'<pre style="overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code'.concat(t,">").concat(r,"</code></pre>"))).replace(/<p>\s*<\/p>/g,"")).trim()}encodeStyleTags(e){return e?e.replace(/<style>([^]*?)<\/style>/g,(e,t)=>"<custom-style>".concat(escape(t),"</custom-style>")):""}decodeStyleTags(e){return e?e.replace(/<custom-style>([^]*?)<\/custom-style>/g,(e,t)=>{try{let e=unescape(t).replace(/<br\/>/g,"");return"<style>".concat(e,"</style>")}catch(e){return"CSS ERROR: ".concat(e)}}):""}cleanupEmptyElements(e){return e?e=(e=e.replace(/<p[^>]*>(\s|&nbsp;|&#160;|<br\s*\/?>)*<\/p>/gi,"")).replace(/<div[^>]*>(\s|&nbsp;|&#160;|<br\s*\/?>)*<\/div>/gi,""):""}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}formatWithRegexOnly(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.applyRegexRules(e,t,r)}substituteOnly(e){return this.substituteVariables(e)}processQuotesOnly(e){return this.processQuotes(e)}markdownOnly(e){return this.convertMarkdown(e)}constructor(e={},t=[]){this.regexRules=[],this.environment={},this.environment=e,this.regexRules=t,this.converter=new(s()).Converter({tables:!0,simpleLineBreaks:!0,strikethrough:!0,literalMidWordUnderscores:!0,tasklists:!0,smoothLivePreview:!0,smartIndentationFix:!0}),this.converter.setOption("openLinksInNewWindow",!0),this.converter.setOption("ghMentions",!1),this.converter.setOption("emoji",!0)}}new c;let u=new c;function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))u.setVariable(e,r);return u.format(e)}u.addRegexRule({name:"表情符号替换",find:":(smile|grin|laugh|wink|heart|cry|sob|angry):",replace:(e,t)=>({smile:"\uD83D\uDE0A",grin:"\uD83D\uDE01",laugh:"\uD83D\uDE02",wink:"\uD83D\uDE09",heart:"❤️",cry:"\uD83D\uDE22",sob:"\uD83D\uDE2D",angry:"\uD83D\uDE20"})[t]||e,placement:[o.AI_OUTPUT,o.USER_INPUT]}),u.addRegexRule({name:"强调内容",find:"\\*\\*([^*]+)\\*\\*",replace:"<strong>$1</strong>",placement:[o.AI_OUTPUT,o.USER_INPUT]}),u.addRegexRule({name:"斜体内容",find:"\\*([^*]+)\\*",replace:"<em>$1</em>",placement:[o.AI_OUTPUT,o.USER_INPUT]});var p=r(2045);function m(){let e=(0,p.G)(e=>e.user.currentUser),t=(null==e?void 0:e.nickname)||"User",r=(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return d(e,t)},[]),a=(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))u.setVariable(e,r);return u.substituteOnly(e)}(e,t)},[]);return{format:r,substitute:a,formatChat:(0,n.useCallback)(function(e,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return d(e,{user:t,char:r,...n})}(e,t,r,n)},[t]),formatWithDateTime:(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return d(e,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString(),...t})},[])}}},5175:(e,t,r)=>{r.d(t,{q:()=>v});var n=r(5155),a=r(2045),l=r(7374),s=r(3096),i=r(9255),o=r(1394),c=r(4662),u=r(2115),d=r(2085),p=r(9434),m=r(285);let h=(0,d.F)("flex items-center justify-center gap-1 rounded-md bg-[var(--bg-secondary)] border border-[var(--border-color)] p-1",{variants:{size:{sm:"h-8",default:"h-10",lg:"h-12"},orientation:{horizontal:"flex-row",vertical:"flex-col"}},defaultVariants:{size:"default",orientation:"horizontal"}}),g=[{icon:(0,n.jsx)(s.TdU,{}),label:"复制"},{icon:(0,n.jsx)(s.WhT,{}),label:"编辑"},{icon:(0,n.jsx)(s.jfu,{}),label:"刷新"},{icon:(0,n.jsx)(s.ucK,{}),label:"删除"},{icon:(0,n.jsx)(s.JT8,{}),label:"声音"},{icon:(0,n.jsx)(s.xfq,{}),label:"图片"}],f=u.forwardRef((e,t)=>{let{className:r,size:a,orientation:l,tools:s=g,...i}=e;return(0,n.jsx)("div",{className:(0,p.cn)(h({size:a,orientation:l,className:r})),ref:t,...i,children:s.map((e,t)=>(0,n.jsx)(m.$,{variant:"ghost",size:"icon",className:(0,p.cn)("rounded-md h-auto w-auto p-2","sm"===a&&"p-1","lg"===a&&"p-3"),onClick:e.action,disabled:e.disabled,title:e.label,children:e.icon},t))})});function v(e){var t,r,u,d,p,m,h;let{message:g,isUserMessage:v,characterAppearance:x,userAppearance:b,formatChatContent:y,hoveredMessageId:w,onHover:R,isTempContext:T,selectedGreetingIndex:N,onGreetingChange:O,storyId:S,onDelete:A,onUpdate:j,onRegenerate:U}=e,{isRegeneratingMessageId:E,isDeletingMessageId:_}=(0,a.G)(e=>{var t,r;return{isRegeneratingMessageId:null==(t=e.story.current)?void 0:t.regeneratingMessageId,isDeletingMessageId:null==(r=e.story.current)?void 0:r.deletingMessageId}}),L="string"==typeof g.createdAt?new Date(g.createdAt).toLocaleTimeString():null!=(m=null==(t=g.createdAt)?void 0:t.toLocaleTimeString())?m:"",k=null!=(h=null==(r=x.greetings)?void 0:r.length)?h:0,I=async()=>{let e=await (0,l.J1)({title:"编辑消息",input:"textarea",inputValue:g.content});e.isConfirmed&&e.value&&j(g.id,e.value)},C=E===g.id,D=_===g.id,M=[{icon:(0,n.jsx)(s.TdU,{className:"h-3 w-3"}),label:"复制",action:()=>{navigator.clipboard.writeText(g.content),l.oR.success("已复制到剪贴板")},disabled:T},{icon:(0,n.jsx)(s.WhT,{className:"h-3 w-3"}),label:"编辑",action:I,disabled:T||C||D},{icon:(0,n.jsx)(i.A,{className:"h-3 w-3 ".concat(C?"animate-spin":"")}),label:"重新生成",action:()=>{U(g.id)},disabled:T||C||D},{icon:(0,n.jsx)(s.ucK,{className:"h-4 w-4 ".concat(D?"animate-pulse":"")}),label:"删除",action:()=>{A(g.id)},disabled:T||C||D}];return(0,n.jsxs)("div",{className:"flex ".concat(v?"justify-end":"justify-start"),onMouseEnter:()=>null==R?void 0:R(g.id.toString()),onMouseLeave:()=>null==R?void 0:R(null),children:[!v&&(0,n.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,n.jsxs)(o.eu,{className:"h-full w-full",children:[(0,n.jsx)(o.BK,{src:x.avatarUrl,alt:x.name,className:"object-cover",shouldBlur:x.shouldBlurAvatar}),(0,n.jsx)(o.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(u=x.name)?void 0:u.charAt(0).toUpperCase())||"C"})]})}),(0,n.jsxs)("div",{className:"max-w-[80%] sm:max-w-[70%] rounded-lg p-2 sm:p-3 flex flex-col relative ".concat(v?"border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)]":"border bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]"),children:[(0,n.jsx)("div",{className:"whitespace-pre-wrap text-sm sm:text-base [&_pre]:overflow-x-auto [&_pre]:whitespace-pre-wrap [&_pre]:word-wrap-break-word [&_code]:break-words [&_pre]:mb-0 [&_*:last-child]:mb-0 mb-0",dangerouslySetInnerHTML:{__html:y(g.content,x.name,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString()})}}),(0,n.jsxs)("div",{className:"flex justify-between items-center mt-0.5 w-full",children:[(0,n.jsx)("div",{className:"z-10 transition-opacity duration-150 ".concat(w===(null==(d=g.id)?void 0:d.toString())||C||D?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"),children:(0,n.jsx)(f,{size:"sm",tools:M})}),(0,n.jsx)("p",{className:"text-[10px] sm:text-xs opacity-70",children:L})]}),!v&&T&&k>1&&"number"==typeof N&&O&&(0,n.jsxs)("div",{className:"flex items-center mt-2 self-center space-x-1",children:[(0,n.jsx)("button",{onClick:()=>{O(0===N?k-1:N-1)},onTouchEnd:e=>{e.preventDefault(),O(0===N?k-1:N-1)},className:"p-2 sm:p-1 rounded-full hover:bg-muted transition-colors touch-manipulation min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto flex items-center justify-center","aria-label":"Previous greeting",children:(0,n.jsx)(c.A,{className:"h-4 w-4 text-foreground"})}),(0,n.jsx)("span",{className:"text-xs text-muted-foreground px-2",children:"".concat(N+1," / ").concat(k)},"greeting-counter-".concat(N)),(0,n.jsx)("button",{onClick:()=>{O(N===k-1?0:N+1)},onTouchEnd:e=>{e.preventDefault(),O(N===k-1?0:N+1)},className:"p-2 sm:p-1 rounded-full hover:bg-muted transition-colors touch-manipulation min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto flex items-center justify-center","aria-label":"Next greeting",children:(0,n.jsx)(c.A,{className:"h-4 w-4 text-foreground transform rotate-180"})})]})]}),v&&(0,n.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 ml-2",children:(0,n.jsxs)(o.eu,{className:"h-full w-full",children:[(0,n.jsx)(o.BK,{src:b.avatarUrl,alt:b.name||"User",className:"object-cover"}),(0,n.jsx)(o.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(p=b.name)?void 0:p.charAt(0).toUpperCase())||"U"})]})})]})}f.displayName="Toolbar"}}]);