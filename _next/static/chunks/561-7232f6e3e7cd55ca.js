"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[561],{3315:(e,t,r)=>{r.d(t,{L:()=>m});var n=r(2115),a=r(822),o=r(9161),s=r.n(o),i=function(e){return e.ENGLISH="ENGLISH",e.CURLY="CURLY",e.GUILLEMETS="GUILLEMETS",e.CORNER="CORNER",e.WHITE_CORNER="WHITE_CORNER",e.FULLWIDTH="FULLWIDTH",e}(i||{}),l=function(e){return e[e.USER_INPUT=0]="USER_INPUT",e[e.AI_OUTPUT=1]="AI_OUTPUT",e[e.SLASH_COMMAND=2]="SLASH_COMMAND",e[e.WORLD_INFO=3]="WORLD_INFO",e[e.AUTHOR_NOTE=4]="AUTHOR_NOTE",e[e.INSTRUCT=5]="INSTRUCT",e[e.RAW_INPUT=6]="RAW_INPUT",e[e.REPLACEMENT=7]="REPLACEMENT",e[e.REASONING=8]="REASONING",e}({});class c{setVariable(e,t){this.environment[e]=t}addRegexRule(e){this.regexRules.push(e)}format(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return"";let r=this.substituteVariables(e);if(r=this.applyRegexRules(r,1,t),r=this.processQuotes(r),!1!==t.isMarkdown&&(r=this.convertMarkdown(r)),r=this.encodeStyleTags(r),!t.skipSanitize){let e={ALLOWED_TAGS:["div","span","a","p","br","strong","em","b","i","ul","ol","li","code","pre","blockquote","q","img","h1","h2","h3","h4","h5","h6","table","thead","tbody","tr","th","td","hr","del","ins","mark","custom-style","sup","sub"],ALLOWED_ATTR:["href","src","class","style","title","alt","target","rel","id","width","height"],ADD_TAGS:["custom-style"],ADD_ATTR:["target","rel"],FORBID_TAGS:["style","script"],FORBID_ATTR:["onerror","onload","onclick"]};t.allowUnsafeHTML&&(e.ALLOW_UNKNOWN_PROTOCOLS=!0,e.ALLOW_ARIA_ATTR=!0);let n=a.A.sanitize(r,e);r="string"==typeof n?n:String(n)}return r=this.decodeStyleTags(r),r=this.cleanupEmptyElements(r)}substituteVariables(e){var t,r;if(!e)return"";let n=e;for(let e in this.environment)if(Object.prototype.hasOwnProperty.call(this.environment,e)){let t=this.environment[e],r=RegExp("{{".concat(this.escapeRegex(e),"}}"),"gi");n=n.replace(r,"function"==typeof t?t():t.toString())}return(n=n.replace(/<USER>/gi,(null==(t=this.environment.user)?void 0:t.toString())||"")).replace(/<CHAR>/gi,(null==(r=this.environment.char)?void 0:r.toString())||"")}applyRegexRules(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e||0===this.regexRules.length)return e;let n=e;for(let e of this.regexRules.filter(e=>!e.disabled&&e.placement.includes(t)&&(!e.markdownOnly&&!e.promptOnly||e.markdownOnly&&r.isMarkdown||e.promptOnly&&r.isPrompt)&&(!r.isEdit||!1!==e.runOnEdit)&&(void 0===r.depth||void 0===e.minDepth||r.depth>=e.minDepth)&&(void 0===r.depth||void 0===e.maxDepth||r.depth<=e.maxDepth)))try{let t=RegExp(e.find,"g");n="string"==typeof e.replace?n.replace(t,e.replace):n.replace(t,function(t){for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return(0,e.replace)(t,...n)})}catch(t){console.error('正则表达式规则 "'.concat(e.name,'" 应用失败:'),t)}return n}processQuotes(e){return e?e=(e=(e=e.replace(/<([^>]+)>/g,(e,t)=>"<"+t.replace(/"/g,"￾")+">")).replace(/```[\s\S]*?```|``[\s\S]*?``|`[\s\S]*?`|(".*?")|(\u201C.*?\u201D)|(\u00AB.*?\u00BB)|(\u300C.*?\u300D)|(\u300E.*?\u300F)|(\uFF02.*?\uFF02)/gm,(e,t,r,n,a,o,s)=>{if(t)return'<q>"'.concat(t.slice(1,-1),'"</q>');if(r)return'<q>"'.concat(r.slice(1,-1),'"</q>');if(n)return"<q>\xab".concat(n.slice(1,-1),"\xbb</q>");if(a)return"<q>「".concat(a.slice(1,-1),"」</q>");if(o)return"<q>『".concat(o.slice(1,-1),"』</q>");else if(s)return"<q>＂".concat(s.slice(1,-1),"＂</q>");else return e})).replace(/\ufffe/g,'"'):""}convertMarkdown(e){if(!e)return"";e=(e=e.replaceAll("\\begin{align*}","$$")).replaceAll("\\end{align*}","$$");let t=this.converter.makeHtml(e);return(t=(t=(t=(t=(t=t.replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/\n/gm,"\0"))).replace(/\u0000/g,"\n")).replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/&amp;/g,"&"))).replace(/<pre><code(.*?)>([\s\S]*?)<\/code><\/pre>/g,(e,t,r)=>'<pre style="overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code'.concat(t,">").concat(r,"</code></pre>"))).replace(/<p>\s*<\/p>/g,"")).trim()}encodeStyleTags(e){return e?e.replace(/<style>([^]*?)<\/style>/g,(e,t)=>"<custom-style>".concat(escape(t),"</custom-style>")):""}decodeStyleTags(e){return e?e.replace(/<custom-style>([^]*?)<\/custom-style>/g,(e,t)=>{try{let e=unescape(t).replace(/<br\/>/g,"");return"<style>".concat(e,"</style>")}catch(e){return"CSS ERROR: ".concat(e)}}):""}cleanupEmptyElements(e){return e?e=(e=e.replace(/<p[^>]*>(\s|&nbsp;|&#160;|<br\s*\/?>)*<\/p>/gi,"")).replace(/<div[^>]*>(\s|&nbsp;|&#160;|<br\s*\/?>)*<\/div>/gi,""):""}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}formatWithRegexOnly(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.applyRegexRules(e,t,r)}substituteOnly(e){return this.substituteVariables(e)}processQuotesOnly(e){return this.processQuotes(e)}markdownOnly(e){return this.convertMarkdown(e)}constructor(e={},t=[]){this.regexRules=[],this.environment={},this.environment=e,this.regexRules=t,this.converter=new(s()).Converter({tables:!0,simpleLineBreaks:!0,strikethrough:!0,literalMidWordUnderscores:!0,tasklists:!0,smoothLivePreview:!0,smartIndentationFix:!0}),this.converter.setOption("openLinksInNewWindow",!0),this.converter.setOption("ghMentions",!1),this.converter.setOption("emoji",!0)}}new c;let u=new c;function d(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))u.setVariable(e,r);return u.format(e)}u.addRegexRule({name:"表情符号替换",find:":(smile|grin|laugh|wink|heart|cry|sob|angry):",replace:(e,t)=>({smile:"\uD83D\uDE0A",grin:"\uD83D\uDE01",laugh:"\uD83D\uDE02",wink:"\uD83D\uDE09",heart:"❤️",cry:"\uD83D\uDE22",sob:"\uD83D\uDE2D",angry:"\uD83D\uDE20"})[t]||e,placement:[l.AI_OUTPUT,l.USER_INPUT]}),u.addRegexRule({name:"强调内容",find:"\\*\\*([^*]+)\\*\\*",replace:"<strong>$1</strong>",placement:[l.AI_OUTPUT,l.USER_INPUT]}),u.addRegexRule({name:"斜体内容",find:"\\*([^*]+)\\*",replace:"<em>$1</em>",placement:[l.AI_OUTPUT,l.USER_INPUT]});var p=r(2045);function m(){let e=(0,p.G)(e=>e.user.currentUser),t=(null==e?void 0:e.nickname)||"User",r=(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return d(e,t)},[]),a=(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))u.setVariable(e,r);return u.substituteOnly(e)}(e,t)},[]);return{format:r,substitute:a,formatChat:(0,n.useCallback)(function(e,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return d(e,{user:t,char:r,...n})}(e,t,r,n)},[t]),formatWithDateTime:(0,n.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return d(e,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString(),...t})},[])}}},5175:(e,t,r)=>{r.d(t,{q:()=>b});var n=r(5155),a=r(1394),o=r(2115),s=r(2085),i=r(3096),l=r(9434),c=r(285);let u=(0,s.F)("flex items-center justify-center gap-1 rounded-md bg-[var(--bg-secondary)] border border-[var(--border-color)] p-1",{variants:{size:{sm:"h-8",default:"h-10",lg:"h-12"},orientation:{horizontal:"flex-row",vertical:"flex-col"}},defaultVariants:{size:"default",orientation:"horizontal"}}),d=[{icon:(0,n.jsx)(i.TdU,{}),label:"复制"},{icon:(0,n.jsx)(i.WhT,{}),label:"编辑"},{icon:(0,n.jsx)(i.jfu,{}),label:"刷新"},{icon:(0,n.jsx)(i.ucK,{}),label:"删除"},{icon:(0,n.jsx)(i.JT8,{}),label:"声音"},{icon:(0,n.jsx)(i.xfq,{}),label:"图片"}],p=o.forwardRef((e,t)=>{let{className:r,size:a,orientation:o,tools:s=d,...i}=e;return(0,n.jsx)("div",{className:(0,l.cn)(u({size:a,orientation:o,className:r})),ref:t,...i,children:s.map((e,t)=>(0,n.jsx)(c.$,{variant:"ghost",size:"icon",className:(0,l.cn)("rounded-md h-auto w-auto p-2","sm"===a&&"p-1","lg"===a&&"p-3"),onClick:e.action,disabled:e.disabled,title:e.label,children:e.icon},t))})});p.displayName="Toolbar";var m=r(4662),h=r(7209),g=r(7374),f=r(4421),v=r(3500),x=r(9255);function b(e){var t,r,o,s,l;let{message:c,isUserMessage:u,characterAppearance:d,userAppearance:b,formatChatContent:R,hoveredMessageId:y,onHover:w,isTempContext:T,selectedGreetingIndex:N,onGreetingChange:E,storyId:O}=e,{updateMessage:S,currentStory:U,regenerateResponse:j,isRegeneratingMessageId:A,deleteMessage:_,isDeletingMessageId:k}=(0,v.Z3)(),L=new Date(c.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),I=null!=(l=null==(t=d.greetings)?void 0:t.length)?l:0,D=async()=>{if(!c.id)return void g.oR.error("无法重新生成此消息，消息ID缺失");try{await j(c.id)?g.oR.success("消息重新生成成功"):g.oR.error("消息重新生成失败")}catch(e){console.error("Error during updateMessage hook execution:",e),g.oR.error("消息更新失败")}},C=async()=>{if(!c.id)return void g.oR.error("无法删除此消息，消息ID缺失");try{await _(c.id)?g.oR.success("消息删除成功"):g.oR.error("消息删除失败")}catch(e){console.error("Error during deleteMessage hook execution:",e),g.oR.error("消息删除失败")}},M=async()=>{if(!c.id)return void g.oR.error("无法编辑此消息，消息ID缺失");if(!O&&(!U||!U.id))return void g.oR.error("无法编辑此消息，故事ID缺失");let e=await (0,g.J1)({title:"编辑消息",input:"textarea",inputValue:c.content,confirmButtonText:"确认",cancelButtonText:"取消"});if(e.isConfirmed&&null!==e.value&&void 0!==e.value){let t=e.value;if(t.trim()===c.content.trim())return;let r=f.oL.TEXT;if(!U||!U.id)return void g.oR.error("无法更新消息，当前故事上下文不存在");O!==U.id&&console.warn("ChatMessageBubble storyId ('".concat(O,"') does not match currentStory.id ('").concat(U.id,"'). Using currentStory.id for update."));try{let e=await S({messageId:c.id,content:t,contentType:r});e?(console.log("Message updated successfully via hook. New content:",t,"Updated message from API:",e),g.oR.success("消息更新成功")):(console.warn("Update message via hook returned null, indicating an issue."),g.oR.error("消息更新失败"))}catch(e){console.error("Error during updateMessage hook execution:",e),g.oR.error("消息更新失败")}}},P=A===c.id,W=k===c.id,q=[{icon:(0,n.jsx)(i.TdU,{className:"h-3 w-3"}),label:"复制",action:()=>{c.content&&navigator.clipboard.writeText(c.content).then(()=>{g.oR.success("已复制到剪贴板")}).catch(e=>{console.error("无法复制文本: ",e),g.oR.error("复制失败")})},disabled:T||!c.id||P||W},{icon:(0,n.jsx)(i.WhT,{className:"h-3 w-3"}),label:"编辑",action:M,disabled:T||!c.id||!O||P||W},{icon:(0,n.jsx)(x.A,{className:"h-3 w-3 ".concat(P?"animate-spin":"")}),label:"重新生成",action:D,disabled:T||!c.id||!O||P||W},{icon:(0,n.jsx)(i.ucK,{className:"h-4 w-4 ".concat(W?"animate-pulse":"")}),label:"删除",action:C,disabled:T||!c.id||!O||P||W}];return(0,n.jsxs)("div",{className:"flex ".concat(u?"justify-end":"justify-start"),onMouseEnter:()=>{w&&void 0!==c.id&&w(c.id.toString())},onMouseLeave:()=>{w&&w(null)},children:[!u&&(0,n.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,n.jsxs)(a.eu,{className:"h-full w-full",children:[(0,n.jsx)(a.BK,{src:d.avatarUrl,alt:d.name,className:"object-cover",shouldBlur:d.shouldBlurAvatar}),(0,n.jsx)(a.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(r=d.name)?void 0:r.charAt(0).toUpperCase())||"C"})]})}),(0,n.jsxs)("div",{className:"max-w-[80%] sm:max-w-[70%] rounded-lg p-2 sm:p-3 flex flex-col relative ".concat(u?"border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)]":"border bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]"),children:[(0,n.jsx)("div",{className:"whitespace-pre-wrap text-sm sm:text-base [&_pre]:overflow-x-auto [&_pre]:whitespace-pre-wrap [&_pre]:word-wrap-break-word [&_code]:break-words [&_pre]:mb-0 [&_*:last-child]:mb-0 mb-0",dangerouslySetInnerHTML:{__html:R(c.content,d.name,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString()})}}),(0,n.jsxs)("div",{className:"flex justify-between items-center mt-0.5 w-full",children:[(0,n.jsx)("div",{className:"z-10 transition-opacity duration-150 ".concat(y===(null==(o=c.id)?void 0:o.toString())||P||W?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"),children:(0,n.jsx)(p,{size:"sm",tools:q})}),(0,n.jsx)("p",{className:"text-[10px] sm:text-xs opacity-70",children:L})]}),!u&&T&&I>1&&"number"==typeof N&&E&&(0,n.jsxs)("div",{className:"flex items-center mt-2 self-center space-x-1",children:[(0,n.jsx)("button",{onClick:()=>{E(0===N?I-1:N-1)},onTouchEnd:e=>{e.preventDefault(),E(0===N?I-1:N-1)},className:"p-2 sm:p-1 rounded-full hover:bg-muted transition-colors touch-manipulation min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto flex items-center justify-center","aria-label":"Previous greeting",children:(0,n.jsx)(m.A,{className:"h-4 w-4 text-foreground"})}),(0,n.jsx)("span",{className:"text-xs text-muted-foreground px-2",children:"".concat(N+1," / ").concat(I)},"greeting-counter-".concat(N)),(0,n.jsx)("button",{onClick:()=>{E(N===I-1?0:N+1)},onTouchEnd:e=>{e.preventDefault(),E(N===I-1?0:N+1)},className:"p-2 sm:p-1 rounded-full hover:bg-muted transition-colors touch-manipulation min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto flex items-center justify-center","aria-label":"Next greeting",children:(0,n.jsx)(h.A,{className:"h-4 w-4 text-foreground"})})]})]}),u&&(0,n.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 ml-2",children:(0,n.jsxs)(a.eu,{className:"h-full w-full",children:[(0,n.jsx)(a.BK,{src:b.avatarUrl,alt:b.name||"User",className:"object-cover"}),(0,n.jsx)(a.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(s=b.name)?void 0:s.charAt(0).toUpperCase())||"U"})]})})]})}}}]);