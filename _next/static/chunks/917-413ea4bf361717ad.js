"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[917],{285:(e,t,r)=>{r.d(t,{$:()=>i});var a=r(5155),s=r(2115),o=r(9708),n=r(2085),l=r(9434);let c=(0,n.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-[var(--bg-secondary)] border border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive",outline:"bg-[var(--bg-secondary)] border border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),i=s.forwardRef((e,t)=>{let{className:r,variant:s,size:n,asChild:i=!1,...d}=e,h=i?o.DX:"button";return(0,a.jsx)(h,{className:(0,l.cn)(c({variant:s,size:n,className:r})),ref:t,...d})});i.displayName="Button"},298:(e,t,r)=>{r.d(t,{Di:()=>d,LK:()=>l,V4:()=>c,d4:()=>h,ib:()=>o,jQ:()=>i,nT:()=>u,qi:()=>n});var a=r(8924);let s=e=>e.chat,o=(0,a.Mz)([e=>e.chat.currentStoryContext],e=>(null==e?void 0:e.id)||null),n=(0,a.Mz)([e=>e.character.currentCharacter],e=>(null==e?void 0:e.id)||null),l=(0,a.Mz)([s],e=>e.curMessages||[]),c=(0,a.Mz)([s],e=>Object.values(e.storyContexts).sort((e,t)=>{let r=e.lastMessageAt?new Date(e.lastMessageAt).getTime():0;return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():0)-r})),i=(0,a.Mz)([s],e=>e.currentStoryContext),d=e=>e.chat.isLoading,h=e=>e.chat.isSending,u=e=>e.chat.error;(0,a.Mz)([e=>e.chat,(e,t)=>t],(e,t)=>{if(e.currentStoryContext&&e.currentStoryContext.id===t)return e.currentStoryContext.messages||[];if("temp"===t){var r;return(null==(r=e.tempContext)?void 0:r.messages)||[]}let a=e.storyContexts[t];return a?a.messages:[]}),(0,a.Mz)([s,(e,t)=>t],(e,t)=>e.currentStoryContext&&e.currentStoryContext.id===t?e.currentStoryContext:t&&e.storyContexts[t]?e.storyContexts[t]:null),(0,a.Mz)([c],e=>[...e].sort((e,t)=>{let r=e.lastMessageAt?new Date(e.lastMessageAt).getTime():0;return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():0)-r}))},971:(e,t,r)=>{r.d(t,{py:()=>h,ji:()=>f,oA:()=>p,Xi:()=>x,d:()=>v,bn:()=>g,pc:()=>y,yn:()=>b,PS:()=>w,s_:()=>u,Gz:()=>m});var a=r(6439),s=r(8578),o=r(9249),n=r(6168),l=r(4421),c=r(3299);class i{async sendMessage(e){try{let t={content:e.content,contentType:e.contentType||l.oL.TEXT,index:e.index||0};return(await n.o.chat.sendMessage({id:e.storyId,sendMessageRequestDto:t})).data}catch(e){throw console.error("Failed to send message:",e),e}}async sendStreamMessage(e,t){try{let r=await n.o.chat.streamResponse({id:e.storyId,message:e.content});console.warn("Stream handling in sendStreamMessage needs proper implementation based on SDK behavior.",r);let a={messageId:"temp-id-".concat(Date.now()),content:"[Streaming mock chunk]",metadata:{},storyId:e.storyId,isLast:!0};t(a)}catch(e){throw console.error("Failed to send streaming message:",e),e}}async getHistory(e){try{let t={page:e.page||1,limit:e.limit||20,role:e.role,startTime:e.from,endTime:e.to},{data:r}=await n.o.chat.getStoryMessages({id:e.storyId,limit:t.limit,page:t.page});return{messages:r.items||[],totalCount:r.total,currentPage:r.page,totalPages:Math.ceil(r.total/r.limit)}}catch(e){throw console.error("Failed to fetch chat history:",e),e}}async getAllMessages(e){try{let e=1,t=[],r=0,a=1;for(;;){let{data:s}=await n.o.chat.getAllMessages({page:e,limit:100}),o=s.items||[];if(t=t.concat(o),r=s.total,a=Math.ceil(s.total/(s.limit||100)),e>=a)break;e++}return{messages:t,totalCount:r,currentPage:a,totalPages:a}}catch(e){throw console.error("Failed to fetch all messages:",e),e}}async deleteMessage(e){console.warn("deleteMessage is not implemented in the SDK")}async clearHistory(e){try{await n.o.chat.clearStoryMessages({id:e})}catch(t){throw console.error("Failed to clear history for story ".concat(e,":"),t),t}}async createStory(e){try{return(await n.o.chat.createStory({createStoryRequestDto:e})).data}catch(e){throw console.error("Failed to create story:",e),e}}async deleteStory(e){try{await n.o.chat.deleteStory({id:e})}catch(t){throw console.error("Failed to delete story ".concat(e,":"),t),t}}async exportStoryHistory(e){try{let t=await n.o.chat.exportStoryHistory({id:e});console.log("Export requested, handle response:",t)}catch(t){throw console.error("Failed to export history for story ".concat(e,":"),t),t}}async getContextTips(e){try{let t=await n.o.chat.getContextTips({id:e.storyId});console.log("Context tips response:",t)}catch(e){throw console.error("Failed to get context tips:",e),e}}async getStory(e){try{return(await n.o.chat.getStory({id:e})).data}catch(t){throw console.error("Failed to get story details for ".concat(e,":"),t),t}}async getUserStories(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;try{return(await n.o.chat.getUserStories({page:t,limit:r})).data}catch(t){throw console.error("Failed to get user stories for user ".concat(e,":"),t),t}}async regenerateResponse(e,t,r){try{return(await n.o.chat.regenerateResponse({id:e})).data}catch(r){throw console.error("Failed to regenerate response for message ".concat(t," in story ").concat(e,":"),r),r}}async stopGeneration(e){try{await n.o.chat.stopGeneration({id:e})}catch(t){throw console.error("Failed to stop generation for story ".concat(e,":"),t),t}}}let d=new(i=(0,o.Cg)([c.A.Singleton],i)),h=(0,a.zD)("chat/addMessageLocal",async(e,t)=>{let{dispatch:r,getState:a}=t,o=a().chat.curMessages,n=o.length>0?Math.max(...o.map(e=>{var t;return null!=(t=e.index)?t:0}))+1:0,c={id:"user-".concat(Date.now()),role:l.hE.USER,content:e.content,contentType:e.contentType||l._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:n,metadata:e.parentMessageId?{parentMessageId:e.parentMessageId}:{}};return r((0,s.tj)(c)),c}),u=(0,a.zD)("chat/sendMessage",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.$c)(!0));let t=await d.sendMessage({...e});r((0,s.tj)(t))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to send message:",t)}finally{r((0,s.$c)(!1))}}),m=(0,a.zD)("chat/sendStreamMessage",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.$c)(!0));let t=a(),o=[],n=t.chat.currentStoryContext;n&&n.id===e.storyId?o=n.messages||[]:console.warn("Current story context id (".concat(null==n?void 0:n.id,") does not match the provided storyId (").concat(e.storyId,")"));let c=o.length>0?Math.max(...o.map(e=>{var t;return null!=(t=e.index)?t:0}))+1:0,i={id:"user-".concat(Date.now()),role:l.hE.USER,content:e.content,contentType:e.contentType||l._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:c,metadata:e.parentMessageId?{parentMessageId:e.parentMessageId}:{}};r((0,s.tj)(i));let h="char-".concat(Date.now()),u="",m="",y={id:h,role:l.hE.ASSISTANT,content:"",contentType:l._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:c+1,metadata:{parentMessageId:i.id}};r((0,s.tj)(y)),await d.sendStreamMessage({...e,parentMessageId:i.id,index:c},t=>{u+=t.content,t.messageId&&t.messageId!==h&&(m=t.messageId),r((0,s.tj)({id:m||h,role:l.hE.ASSISTANT,content:u,contentType:l._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:c+1,metadata:{parentMessageId:i.id}})),t.isLast&&console.log("Stream message completed")})}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to send stream message:",t)}finally{r((0,s.$c)(!1))}}),y=(0,a.zD)("chat/fetchStoryHistory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{if(!e.storyId||!e.characterId)return void console.error("Cannot fetch history: missing storyId or characterId");console.log("Fetching chat history for story ".concat(e.storyId)),r((0,s.r1)(!0));let{page:t,limit:a}=e;try{let o=await d.getHistory({storyId:e.storyId,characterId:e.characterId,page:t,limit:a});if(o&&o.messages){let t=o.messages.map(t=>({...t,storyId:e.storyId}));r((0,s.FB)({storyId:e.storyId,messages:t}))}}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("API error when fetching story history:",t)}}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to fetch story history:",t)}finally{r((0,s.r1)(!1))}}),g=(0,a.zD)("chat/fetchAllStory",async(e,t)=>{let{page:r=1,limit:a=20}=e,{dispatch:o,getState:n}=t;try{console.log("Fetching all stories"),o((0,s.r1)(!0));try{var l;let e=(null==(l=n().user.currentUser)?void 0:l.id)||"",t=await d.getUserStories(e,r,a);if(t&&t.items){let e=t.items.map(e=>({...e,messages:[]}));o((0,s.iY)(e))}}catch(t){let e=t instanceof Error?t.message:String(t);o((0,s.Nh)(e)),console.error("API error when fetching stories:",t)}}catch(t){let e=t instanceof Error?t.message:String(t);o((0,s.Nh)(e)),console.error("Failed to fetch stories:",t)}finally{o((0,s.r1)(!1))}}),x=(0,a.zD)("chat/deleteMessage",async(e,t)=>{let{messageId:r,storyId:a}=e,{dispatch:o,getState:n}=t;try{let{chat:e}=n(),t=e.storyContexts[a];if(t){let e=t.messages.filter(e=>e.id!==r);o((0,s.FB)({storyId:a,messages:e})),console.warn("Message deleted locally, backend deletion not implemented in SDK.")}else console.error("Story context not found for ID: ".concat(a))}catch(t){let e=t instanceof Error?t.message:String(t);o((0,s.Nh)(e)),console.error("Failed to delete message:",t)}}),f=(0,a.zD)("chat/clearStoryHistory",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0)),await d.clearHistory(e),r((0,s.oI)(e))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to clear chat history:",t)}finally{r((0,s.r1)(!1))}}),p=(0,a.zD)("chat/createStory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.r1)(!0));let t={...await d.createStory(e),messages:[]};return r((0,s.LD)(t)),r((0,s.SU)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to create chat story:",t),null}finally{r((0,s.r1)(!1))}}),v=(0,a.zD)("chat/deleteStory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.r1)(!0));let{chat:t}=a();if(t.storyContexts[e]){try{await d.deleteStory(e)}catch(t){console.warn("Failed to delete story ".concat(e," via ChatService:"),t)}r((0,s.Ob)(e))}else console.warn("Story with ID ".concat(e," not found for deletion."))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to delete chat story:",t)}finally{r((0,s.r1)(!1))}}),b=(0,a.zD)("chat/fetchStoryDetails",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await d.getStory(e);return console.log("storyDetails",JSON.stringify(t)),t&&r((0,s.f5)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to fetch story details:",t),null}finally{r((0,s.r1)(!1))}}),w=(0,a.zD)("chat/fetchStoryToCurStoryContext",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await d.getStory(e);return console.log("fetchStoryToCurStoryContext storyDetails",JSON.stringify(t)),t&&r((0,s.Uw)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to fetch story to current story context:",t),null}finally{r((0,s.r1)(!1))}})},1394:(e,t,r)=>{r.d(t,{BK:()=>i,bg:()=>c,eu:()=>l,q5:()=>d,xK:()=>h});var a=r(5155),s=r(2115),o=r(4011),n=r(9434);let l=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.bL,{ref:t,className:(0,n.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",r),...s})});l.displayName=o.bL.displayName;let c=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.bL,{ref:t,className:(0,n.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-lg",r),...s})});c.displayName="SquareAvatar";let i=s.forwardRef((e,t)=>{let{className:r,shouldBlur:s,...l}=e;return(0,a.jsx)(o._V,{ref:t,className:(0,n.cn)("aspect-square h-full w-full",s&&"blur-md",r),...l})});i.displayName=o._V.displayName;let d=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.H4,{ref:t,className:(0,n.cn)("flex h-full w-full items-center justify-center rounded-full bg-muted",r),...s})});d.displayName=o.H4.displayName;let h=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.H4,{ref:t,className:(0,n.cn)("flex h-full w-full items-center justify-center rounded-lg bg-muted",r),...s})});h.displayName="SquareAvatarFallback"},2847:(e,t,r)=>{r.d(t,{Ib:()=>c,MM:()=>d,OE:()=>i});var a=r(2115),s=r(2045),o=r(6305),n=r(3525),l=r(5055);let c=()=>{let e=(0,s.G)(o.xk),t=(0,s.G)(o.HC),r=(0,s.G)(o.QB),a=(0,s.G)(o.Im),n=(0,s.G)(o.yw),l=(0,s.G)(o.ov),c=(0,s.G)(o.Vs),i=(0,s.G)(o.TG),d=(0,s.G)(e=>e.character.categories),h={totalCount:l,currentPage:c,totalPages:i,limit:n.limit};return{characters:e,featuredCharacters:t,isLoading:r,error:a,filters:n,pagination:h,categories:d}},i=()=>{let e=(0,s.G)(o.TB);return{currentCharacter:e,isLoading:(0,s.G)(o.QB),error:(0,s.G)(o.Im)}},d=()=>{let e=(0,s.j)();(0,s.G)(o.yw);let t=(0,a.useCallback)(t=>(t&&e((0,n._F)(t)),e((0,l.Cb)())),[e]),r=(0,a.useCallback)(t=>e((0,l.UG)(t)),[e]),c=(0,a.useCallback)(t=>e((0,l.kN)(t)),[e]),i=(0,a.useCallback)((t,r)=>e((0,l.xi)({id:t,updateData:r})),[e]),d=(0,a.useCallback)(t=>e((0,l.jQ)(t)),[e]),h=(0,a.useCallback)(t=>e((0,l.T8)(t)),[e]),u=(0,a.useCallback)(()=>{e((0,n.ET)())},[e]),m=(0,a.useCallback)(t=>{e((0,n._F)(t))},[e]);return{searchCharacters:t,fetchCharacterById:r,createCharacter:c,updateCharacter:i,deleteCharacter:d,toggleFavorite:h,clearErrors:u,setFilter:m,fetchCategories:(0,a.useCallback)(()=>e((0,l.zN)()),[e]),fetchFeatured:(0,a.useCallback)(()=>e((0,l.RV)()),[e])}}},3500:(e,t,r)=>{r.d(t,{R7:()=>h,Z3:()=>c,ki:()=>d,w0:()=>i});var a=r(2115),s=r(2045),o=r(298),n=r(971),l=r(8578);let c=()=>{let e=(0,s.j)(),t=(0,s.G)(o.ib),r=(0,s.G)(o.LK),c=(0,s.G)(o.jQ),i=(0,s.G)(o.qi),d=(0,s.G)(o.Di),h=(0,s.G)(o.d4),u=(0,s.G)(o.nT),m=(0,a.useCallback)(t=>{if(!t)return void console.error("Cannot send message null");e((0,n.s_)(t))},[e]),y=(0,a.useCallback)(async t=>{if(!t.storyId)return console.error("Cannot add message without a current story selected"),null;if(!t.characterId)return console.error("Cannot add message without characterId"),null;let r=t.storyId,a=await e((0,n.py)({...t,storyId:r}));return n.py.fulfilled.match(a)?a.payload:null},[e]),g=(0,a.useCallback)(t=>c?t.characterId||i?void e((0,n.Gz)({...t,storyId:c.id})):void console.error("Cannot send stream message without characterId"):void console.error("Cannot send stream message without a current story selected"),[e,c,i]),x=(0,a.useCallback)((t,r)=>{if(!c||!c.characterId)return void console.warn("Cannot fetch history without current story and character ID");let a={storyId:c.id,characterId:c.characterId,page:t,limit:r};e((0,n.pc)(a))},[e,c]),f=(0,a.useCallback)(t=>{if(!c)return void console.error("Cannot delete message without current story");e((0,n.Xi)({messageId:t,storyId:c.id}))},[e,c]),p=(0,a.useCallback)(()=>{if(!c)return void console.error("Cannot clear history without current story");e((0,n.ji)(c.id))},[e,c]);return{currentStoryId:t,currentCharacterId:i,messages:r,currentStory:c,isLoading:d,isSending:h,error:u,sendMessage:m,addMessage:y,sendStreamMessage:g,fetchCurStoryHistory:x,deleteMessage:f,clearHistory:p,clearErrors:(0,a.useCallback)(()=>{e((0,l.ET)())},[e])}},i=()=>{let e=(0,s.j)();return{clearCurrentStoryContext:(0,a.useCallback)(()=>{e((0,l.SU)(null))},[e])}},d=()=>{let e=(0,s.j)(),t=(0,s.G)(l.JQ),r=(0,s.G)(e=>e.chat.tempContext),o=(0,a.useCallback)(a=>{let s=!t||r&&r.characterId!==a.id;return s&&e((0,l.tM)({character:a})),{contextExists:!!r,isNewlyCreated:s,characterChanged:r&&r.characterId!==a.id}},[e,t,r]);return{hasTempContext:t,tempContext:r,initTempContext:o}},h=()=>{let e=(0,s.j)(),t=(0,s.G)(o.V4),r=(0,s.G)(o.Di),l=(0,s.G)(o.nT),c=(0,s.G)(e=>e.chat.storyContexts),i=(0,s.G)(o.ib),d=(0,a.useCallback)(()=>{console.log("Dispatching fetchAllStoryAsync"),e((0,n.bn)({}))},[e]),h=(0,a.useCallback)(()=>{console.log("Forcing refresh of stories"),e((0,n.bn)({}))},[e]),u=(0,a.useCallback)(e=>e&&c[e]||null,[c]),m=(0,a.useCallback)(async t=>{if(!t)return console.error("Cannot fetch story details without storyId"),null;let r=c[t];if(r)return r;let a=await e((0,n.yn)(t));return n.yn.fulfilled.match(a)&&a.payload?c[t]||a.payload:null},[e,c]),y=(0,a.useCallback)(async t=>{if(!t)return console.error("Cannot fetch story to current context without storyId"),null;let r=await e((0,n.PS)(t));return n.PS.fulfilled.match(r)&&r.payload?r.payload:null},[e]);return{stories:t,isLoading:r,error:l,fetchStories:d,fetchStoryDetails:m,fetchStoryToCurStoryContext:y,getStoryById:u,refreshStories:h,createStory:(0,a.useCallback)(async t=>{let r=await e((0,n.oA)(t));return n.oA.fulfilled.match(r)?r.payload:null},[e]),deleteStory:(0,a.useCallback)(t=>{e((0,n.d)(t))},[e]),currentStoryId:i}}},3525:(e,t,r)=>{r.d(t,{Ay:()=>v,ET:()=>x,Nh:()=>y,_F:()=>u,dw:()=>h,jO:()=>d,r1:()=>m,zw:()=>p});var a=r(6439),s=r(4421),o=r(5055);let n={search:"",categoryId:"",sortBy:s.Qi.createdAt,tags:[],page:1,limit:20,visibility:s.HQ.public,status:s.h4.published},l=(0,a.Z0)({name:"character",initialState:{characters:[],featuredCharacters:[],currentCharacter:null,favorites:[],recentlyViewed:[],isLoading:!1,error:null,totalCount:0,currentPage:1,totalPages:1,filters:n,categories:[]},reducers:{setCharacters:(e,t)=>{e.characters=t.payload},setFeaturedCharacters:(e,t)=>{e.featuredCharacters=t.payload},setCurrentCharacter:(e,t)=>{e.currentCharacter=t.payload,t.payload&&!e.recentlyViewed.includes(t.payload.id)&&(e.recentlyViewed.length>=10&&e.recentlyViewed.pop(),e.recentlyViewed=[t.payload.id,...e.recentlyViewed])},toggleFavorite:(e,t)=>{let r=t.payload,a=e.favorites.indexOf(r);-1===a?e.favorites.push(r):e.favorites.splice(a,1)},setFilters:(e,t)=>{e.filters={...e.filters,...t.payload},("search"in t.payload||"categoryId"in t.payload||"tags"in t.payload)&&(e.filters.page=1)},setLoading:(e,t)=>{e.isLoading=t.payload},setError:(e,t)=>{e.error=t.payload},setPagination:(e,t)=>{e.totalCount=t.payload.totalCount,e.currentPage=t.payload.currentPage,e.totalPages=t.payload.totalPages},clearError:e=>{e.error=null},clearRecentlyViewed:e=>{e.recentlyViewed=[]},setCategories:(e,t)=>{e.categories=t.payload}},extraReducers:e=>{e.addCase(o.Cb.pending,e=>{e.isLoading=!0,e.error=null}).addCase(o.Cb.fulfilled,(e,t)=>{e.isLoading=!1,e.characters=t.payload.characters,e.totalCount=t.payload.totalCount,e.totalPages=t.payload.totalPages,e.currentPage=t.payload.currentPage}).addCase(o.Cb.rejected,(e,t)=>{e.isLoading=!1,e.error=t.error.message||"Failed to fetch characters"}).addCase(o.UG.pending,e=>{e.isLoading=!0,e.error=null}).addCase(o.UG.fulfilled,(e,t)=>{if(e.isLoading=!1,t.payload&&"object"==typeof t.payload&&t.payload.id){e.currentCharacter=t.payload;let r=e.characters.findIndex(e=>e.id===t.payload.id);-1!==r&&e.characters[r]&&(e.characters[r]={...e.characters[r],...t.payload}),e.recentlyViewed.includes(t.payload.id)||(e.recentlyViewed.length>=10&&e.recentlyViewed.pop(),e.recentlyViewed.unshift(t.payload.id))}else e.currentCharacter=null}).addCase(o.UG.rejected,(e,t)=>{e.isLoading=!1,e.error=t.error.message||"Failed to fetch character details",e.currentCharacter=null}).addCase(o.RV.pending,e=>{e.isLoading=!0,e.error=null}).addCase(o.RV.fulfilled,(e,t)=>{e.isLoading=!1,e.featuredCharacters=t.payload}).addCase(o.RV.rejected,(e,t)=>{e.isLoading=!1,e.error=t.error.message||"Failed to fetch featured characters"}).addCase(o.T8.fulfilled,(e,t)=>{var r;let{characterId:a,isFavorited:s}=t.payload,o=e.favorites.indexOf(a);s&&-1===o?e.favorites.push(a):s||-1===o||e.favorites.splice(o,1),(null==(r=e.currentCharacter)?void 0:r.id)===a&&(e.currentCharacter.isFavorited=s);let n=e.characters.findIndex(e=>e.id===a);-1!==n&&(e.characters[n].isFavorited=s)}).addCase(o.T8.rejected,(e,t)=>{console.error("Failed to toggle favorite:",t.error.message),e.error=t.error.message||"Failed to update favorite status"})}}),{setCharacters:c,setFeaturedCharacters:i,setCurrentCharacter:d,toggleFavorite:h,setFilters:u,setLoading:m,setError:y,setPagination:g,clearError:x,clearRecentlyViewed:f,setCategories:p}=l.actions,v=l.reducer},4165:(e,t,r)=>{r.d(t,{Cf:()=>h,Es:()=>m,L3:()=>y,c7:()=>u,lG:()=>c});var a=r(5155),s=r(2115),o=r(5452),n=r(5318),l=r(9434);let c=o.bL;o.l9;let i=o.ZL;o.bm;let d=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.hJ,{ref:t,className:(0,l.cn)("fixed inset-0 z-50 bg-background backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...s})});d.displayName=o.hJ.displayName;let h=s.forwardRef((e,t)=>{let{className:r,children:s,...c}=e;return(0,a.jsxs)(i,{children:[(0,a.jsx)(d,{}),(0,a.jsxs)(o.UC,{ref:t,className:(0,l.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-card p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",r),...c,children:[s,(0,a.jsxs)(o.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,a.jsx)(n.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});h.displayName=o.UC.displayName;let u=e=>{let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...r})};u.displayName="DialogHeader";let m=e=>{let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...r})};m.displayName="DialogFooter";let y=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.hE,{ref:t,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight text-foreground",r),...s})});y.displayName=o.hE.displayName,s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.VY,{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",r),...s})}).displayName=o.VY.displayName},5055:(e,t,r)=>{r.d(t,{kN:()=>y,jQ:()=>x,zN:()=>f,UG:()=>u,RV:()=>h,Cb:()=>d,T8:()=>m,xi:()=>g});var a=r(6439),s=r(3525),o=r(9249),n=r(6168),l=r(3299);class c{async create(e){try{return(await n.o.characters.create({createCharacterRequestDto:e})).data}catch(e){throw console.error("Failed to create character:",e),e}}async favoriteCharacter(e){try{await n.o.characters.favoriteCharacter({id:e})}catch(e){throw console.error("Failed to favorite character:",e),e}}async findUserFavorites(e,t,r){try{return(await n.o.characters.findUserFavorites({userId:e,page:t,limit:r})).data}catch(e){throw console.error("Failed to find user favorites:",e),e}}async getAllCategoriesWithPopularTags(){try{return(await n.o.characters.getAllCategoriesWithPopularTags()).data}catch(e){throw console.error("Failed to get all categories with popular tags:",e),e}}async getCharacterDetail(e){try{return(await n.o.characters.getCharacterDetail({id:e})).data}catch(e){throw console.error("Failed to get character detail:",e),e}}async getRatings(e,t,r){try{return(await n.o.characters.getRatings({id:e,page:t,limit:r})).data}catch(e){throw console.error("Failed to get ratings:",e),e}}async importCharacter(e,t){try{return(await n.o.characters.importCharacter({format:e,preservedFileName:t})).data}catch(e){throw console.error("Failed to import character:",e),e}}async incrementUseCount(e){try{await n.o.characters.incrementUseCount({id:e})}catch(e){throw console.error("Failed to increment use count:",e),e}}async rateCharacter(e,t){try{return(await n.o.characters.rateCharacter({id:e,rateCharacterRequestDto:t})).data}catch(e){throw console.error("Failed to rate character:",e),e}}async remove(e){try{await n.o.characters.remove({id:e})}catch(e){throw console.error("Failed to remove character:",e),e}}async searchCharacters(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{return(await n.o.characters.searchCharacters({page:e,limit:t,...r})).data}catch(e){throw console.error("Failed to search characters:",e),e}}async unfavoriteCharacter(e){try{await n.o.characters.unfavoriteCharacter({id:e})}catch(e){throw console.error("Failed to unfavorite character:",e),e}}async update(e,t){try{return(await n.o.characters.update({id:e,updateCharacterRequestDto:t})).data}catch(e){throw console.error("Failed to update character:",e),e}}}let i=new(c=(0,o.Cg)([l.A.Singleton],c)),d=(0,a.zD)("character/searchCharacters",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.r1)(!0));let{filters:e}=a().character;console.log("filters",JSON.stringify(e));let t=e.page||1,o=e.limit||20,{...n}=e,l=await i.searchCharacters(t,o,n);if(console.log("result",JSON.stringify(l)),l){let e=Math.ceil(l.total/(l.limit||o));return{characters:l.items||[],totalCount:l.total||0,currentPage:l.page||1,totalPages:e||1}}throw r((0,s.Nh)("failed to fetch characters")),Error("Failed to fetch characters")}catch(t){let e=t instanceof Error?t.message:String(t);throw r((0,s.Nh)(e)),console.error("Failed to fetch characters:",t),t}finally{r((0,s.r1)(!1))}}),h=(0,a.zD)("character/fetchFeaturedCharacters",async(e,t)=>{let{dispatch:r}=t;try{return r((0,s.r1)(!0)),[]}catch(t){let e=t instanceof Error?t.message:String(t);throw r((0,s.Nh)(e)),console.error("Failed to fetch featured characters:",t),t}finally{r((0,s.r1)(!1))}}),u=(0,a.zD)("character/fetchCharacterById",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.r1)(!0));let t=await i.getCharacterDetail(e);if(t)return t;return void console.warn("Character not found with ID ".concat(e))}catch(t){throw t instanceof Error?t.message:String(t),console.error("Failed to fetch character with ID ".concat(e,":"),t),t}finally{r((0,s.r1)(!1))}}),m=(0,a.zD)("character/toggleFavorite",async(e,t)=>{let{dispatch:r,getState:a}=t;try{let t=a().character.favorites.includes(e);return r((0,s.dw)(e)),{characterId:e,isFavorited:!t}}catch(a){let t=a instanceof Error?a.message:String(a);throw r((0,s.Nh)(t)),r((0,s.dw)(e)),console.error("Failed to toggle favorite status:",a),a}}),y=(0,a.zD)("character/createCharacter",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await i.create(e);return r(d()),t}catch(t){let e=t instanceof Error?t.message:String(t);throw r((0,s.Nh)(e)),console.error("Failed to create character:",t),t}finally{r((0,s.r1)(!1))}}),g=(0,a.zD)("character/updateCharacter",async(e,t)=>{let{id:r,updateData:a}=e,{dispatch:o}=t;try{o((0,s.r1)(!0)),await i.update(r,a);let e=await i.getCharacterDetail(r);if(!e)throw Error("Failed to fetch updated character details after update.");return o((0,s.jO)(e)),e}catch(t){let e=t instanceof Error?t.message:String(t);throw o((0,s.Nh)(e)),console.error("Failed to update character:",t),t}finally{o((0,s.r1)(!1))}}),x=(0,a.zD)("character/deleteCharacter",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0)),r(d())}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to delete character:",t)}finally{r((0,s.r1)(!1))}}),f=(0,a.zD)("character/fetchCategories",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let e=await i.getAllCategoriesWithPopularTags();return r((0,s.zw)(e.categories)),e}catch(t){let e=t instanceof Error?t.message:String(t);throw r((0,s.Nh)(e)),console.error("Failed to fetch categories and tags:",t),t}finally{r((0,s.r1)(!1))}})},5298:(e,t,r)=>{r.d(t,{default:()=>z});var a=r(5155),s=r(6874),o=r.n(s),n=r(6766),l=r(285),c=r(2115),i=r(4540),d=r(4165),h=r(704),u=r(9434);let m=h.bL,y=c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(h.B8,{ref:t,className:(0,u.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",r),...s})});y.displayName=h.B8.displayName;let g=c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(h.l9,{ref:t,className:(0,u.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",r),...s})});g.displayName=h.l9.displayName;let x=c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(h.UC,{ref:t,className:(0,u.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",r),...s})});x.displayName=h.UC.displayName;var f=r(8613);function p(e){let{isOpen:t,onClose:r,initialTab:s="login"}=e;(0,i.wA)();let{isLoading:o,error:h}=(0,i.d4)(e=>e.user),{login:u,register:p,clearErrors:v}=(0,f.As)(),[b,w]=(0,c.useState)(s),[C,N]=(0,c.useState)("add@1232163.com"),[j,S]=(0,c.useState)("12345678aA"),[I,k]=(0,c.useState)("add"),[F,M]=(0,c.useState)(t),[D,E]=(0,c.useState)(""),[T,A]=(0,c.useState)(!1),[z,L]=(0,c.useState)({}),[R,U]=(0,c.useState)({length:!1,uppercase:!1,lowercase:!1,numberOrSpecial:!1});(0,c.useEffect)(()=>{let e=localStorage.getItem("referralCode");console.log("LoginModal checking localStorage for referral code:",e),e?(E(e),A(!0)):D||A(!1)},[t,D]),(0,c.useEffect)(()=>{let e=e=>{let t=e.detail;t&&t.tab&&w(t.tab),M(!0)};return document.addEventListener("open-login-modal",e),()=>{document.removeEventListener("open-login-modal",e)}},[]),(0,c.useEffect)(()=>{w(s)},[s]),(0,c.useEffect)(()=>{M(t)},[t]);let G=()=>{M(!1),v(),L({}),r()},P=e=>{let t=/[A-Z]/.test(e),r=/[a-z]/.test(e);return(U({length:e.length>=6,uppercase:t,lowercase:r,numberOrSpecial:!1}),e.length<6)?(L(e=>({...e,password:"Password must be at least 6 characters long"})),!1):t&&r?(L(e=>({...e,password:void 0})),!0):(L(e=>({...e,password:"Password must contain at least one uppercase letter and one lowercase letter"})),!1)},B=e=>e.length<3?(L(e=>({...e,username:"Username must be at least 3 characters long"})),!1):e.length>20?(L(e=>({...e,username:"Username cannot exceed 20 characters"})),!1):/^[a-zA-Z0-9_-]+$/.test(e)?(L(e=>({...e,username:void 0})),!0):(L(e=>({...e,username:"Username can only contain letters, numbers, underscores, and hyphens"})),!1),V=async e=>{e.preventDefault();try{await u({email:C,password:j})&&G()}catch(e){console.error("Login failed:",e)}},O=async e=>{e.preventDefault();let t=P(j),r=B(I);if(t&&r)try{await p({email:C,password:j,username:I,invitationCode:D||void 0})&&G()}catch(e){console.error("Registration failed:",e)}};return(0,c.useEffect)(()=>{L({})},[b]),(0,a.jsx)(d.lG,{open:F,onOpenChange:G,children:(0,a.jsxs)(d.Cf,{className:"sm:max-w-md bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]",children:[(0,a.jsx)(d.c7,{children:(0,a.jsx)(d.L3,{className:"text-center text-xl font-normal",children:"login"===b?"登录":"注册"})}),(0,a.jsxs)(m,{defaultValue:s,value:b,onValueChange:w,className:"w-full",children:[(0,a.jsxs)(y,{className:"grid w-full grid-cols-2 bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(g,{value:"login",className:"data-[state=active]:bg-[var(--bg-secondary)] data-[state=active]:text-[var(--text-primary)]",children:"登录"}),(0,a.jsx)(g,{value:"register",className:"data-[state=active]:bg-[var(--bg-secondary)] data-[state=active]:text-[var(--text-primary)]",children:"注册"})]}),(0,a.jsxs)(x,{value:"login",className:"mt-4",children:[(0,a.jsxs)("form",{onSubmit:V,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邮箱"}),(0,a.jsx)("input",{type:"email",placeholder:"邮箱地址",value:C,onChange:e=>N(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"密码"}),(0,a.jsx)("input",{type:"password",placeholder:"密码",value:j,onChange:e=>S(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"})]}),h&&(0,a.jsx)("div",{className:"text-[var(--error-text)] text-sm",children:h}),(0,a.jsx)(l.$,{type:"submit",variant:"outline",className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:o,children:o?"登录中...":"登录"})]}),(0,a.jsxs)("div",{className:"relative flex items-center py-4",children:[(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"}),(0,a.jsx)("span",{className:"flex-shrink mx-4 text-[var(--text-secondary)] text-sm",children:"或"}),(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"})]}),(0,a.jsxs)(l.$,{variant:"outline",className:"w-full flex items-center justify-center gap-2 bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(n.default,{src:"https://ext.same-assets.com/1551878970/904099674.svg+xml",alt:"Discord",width:20,height:20}),(0,a.jsx)("span",{children:"使用 Discord 登录"})]})]}),(0,a.jsxs)(x,{value:"register",className:"mt-4",children:[(0,a.jsxs)("form",{onSubmit:O,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"用户名"}),(0,a.jsx)("input",{type:"text",placeholder:"用户名",value:I,onChange:e=>{let t=e.target.value;k(t),"register"===b&&t?B(t):L(e=>({...e,username:void 0}))},required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus ".concat(z.username?"border-[var(--error-border)] focus:ring-[var(--error-text)]":"focus:ring-[var(--primary)]")}),z.username&&(0,a.jsx)("div",{className:"text-[var(--error-text)] text-xs mt-1",children:z.username})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邮箱"}),(0,a.jsx)("input",{type:"email",placeholder:"邮箱地址",value:C,onChange:e=>N(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"密码"}),(0,a.jsx)("input",{type:"password",placeholder:"密码 (至少6个字符)",value:j,onChange:e=>{let t=e.target.value;S(t),"register"===b&&t?P(t):(L(e=>({...e,password:void 0})),U({length:!1,uppercase:!1,lowercase:!1,numberOrSpecial:!1}))},required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"}),"register"===b&&(0,a.jsxs)("div",{className:"mt-2",children:[(0,a.jsx)("p",{className:"text-xs text-[var(--text-secondary)] mb-1",children:"密码必须满足："}),(0,a.jsxs)("ul",{className:"text-xs space-y-1",children:[(0,a.jsxs)("li",{className:"flex items-center ".concat(R.length?"text-green-500":"text-[var(--text-secondary)]"),children:[(0,a.jsx)("span",{children:R.length?"✓":"○"}),(0,a.jsx)("span",{className:"ml-1",children:"至少6个字符"})]}),(0,a.jsxs)("li",{className:"flex items-center ".concat(R.uppercase?"text-green-500":"text-[var(--text-secondary)]"),children:[(0,a.jsx)("span",{children:R.uppercase?"✓":"○"}),(0,a.jsx)("span",{className:"ml-1",children:"至少1个大写字母"})]}),(0,a.jsxs)("li",{className:"flex items-center ".concat(R.lowercase?"text-green-500":"text-[var(--text-secondary)]"),children:[(0,a.jsx)("span",{children:R.lowercase?"✓":"○"}),(0,a.jsx)("span",{className:"ml-1",children:"至少1个小写字母"})]})]})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邀请码 (可选)"}),(0,a.jsx)("input",{type:"text",placeholder:"输入邀请码",value:D,onChange:e=>E(e.target.value),readOnly:T,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus ".concat(T?"cursor-not-allowed opacity-70":"")}),T&&(0,a.jsx)("p",{className:"text-xs text-[var(--text-secondary)] mt-1",children:"已使用推荐链接中的邀请码。"})]}),h&&(0,a.jsx)("div",{className:"text-[var(--error-text)] text-sm",children:h}),(0,a.jsx)(l.$,{type:"submit",variant:"outline",className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:o||!!z.username||!!z.password,children:o?"注册中...":"注册"})]}),(0,a.jsxs)("div",{className:"relative flex items-center py-4",children:[(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"}),(0,a.jsx)("span",{className:"flex-shrink mx-4 text-[var(--text-secondary)] text-sm",children:"或"}),(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"})]}),(0,a.jsxs)(l.$,{variant:"outline",className:"w-full flex items-center justify-center gap-2 bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(n.default,{src:"https://ext.same-assets.com/1551878970/904099674.svg+xml",alt:"Discord",width:20,height:20}),(0,a.jsx)("span",{children:"使用 Discord 注册"})]})]})]}),(0,a.jsxs)("div",{className:"text-center text-sm text-[var(--text-secondary)] mt-4",children:[(0,a.jsx)("p",{children:"Quack是免费使用"}),(0,a.jsx)("p",{children:"加入Discord社群可以获得更多福利"})]})]})})}var v=r(7230),b=r(3158),w=r(518),C=r(154);let N=v.bL,j=v.l9;v.YJ,v.ZL,v.Pb,v.z6,c.forwardRef((e,t)=>{let{className:r,inset:s,children:o,...n}=e;return(0,a.jsxs)(v.ZP,{ref:t,className:(0,u.cn)("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s&&"pl-8",r),...n,children:[o,(0,a.jsx)(b.A,{className:"ml-auto"})]})}).displayName=v.ZP.displayName,c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(v.G5,{ref:t,className:(0,u.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...s})}).displayName=v.G5.displayName;let S=c.forwardRef((e,t)=>{let{className:r,sideOffset:s=4,...o}=e;return(0,a.jsx)(v.ZL,{children:(0,a.jsx)(v.UC,{ref:t,sideOffset:s,className:(0,u.cn)("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...o})})});S.displayName=v.UC.displayName;let I=c.forwardRef((e,t)=>{let{className:r,inset:s,...o}=e;return(0,a.jsx)(v.q7,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",s&&"pl-8",r),...o})});I.displayName=v.q7.displayName,c.forwardRef((e,t)=>{let{className:r,children:s,checked:o,...n}=e;return(0,a.jsxs)(v.H_,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),checked:o,...n,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(v.VF,{children:(0,a.jsx)(w.A,{className:"h-4 w-4"})})}),s]})}).displayName=v.H_.displayName,c.forwardRef((e,t)=>{let{className:r,children:s,...o}=e;return(0,a.jsxs)(v.hN,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),...o,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(v.VF,{children:(0,a.jsx)(C.A,{className:"h-2 w-2 fill-current"})})}),s]})}).displayName=v.hN.displayName,c.forwardRef((e,t)=>{let{className:r,inset:s,...o}=e;return(0,a.jsx)(v.JU,{ref:t,className:(0,u.cn)("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",r),...o})}).displayName=v.JU.displayName,c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(v.wv,{ref:t,className:(0,u.cn)("-mx-1 my-1 h-px bg-muted",r),...s})}).displayName=v.wv.displayName;var k=r(6562),F=r(1394),M=r(5695),D=r(3500),E=r(2847);function T(){var e,t;(0,i.wA)();let r=(0,i.d4)(e=>e.user.currentUser),s=(0,i.d4)(e=>e.user.isAuthenticated),{fetchUserProfile:d,logoutUser:h}=(0,f.As)(),u=(0,M.useRouter)(),{stories:m,fetchStories:y}=(0,D.R7)(),{characters:g}=(0,E.Ib)(),[x,v]=(0,c.useState)(!1),[b,w]=(0,c.useState)(!1),[C,T]=(0,c.useState)("login"),A=(0,c.useRef)(!0),[z,L]=(0,c.useState)(!1),R=(0,M.useSearchParams)(),U=e=>{T(e),w(!0)};(0,k.u)(U.bind(null,"login")),(0,c.useEffect)(()=>{"/"===window.location.pathname&&u.push("/characters")},[u]),(0,c.useEffect)(()=>{L(!0);let e=R.get("ref");e&&localStorage.setItem("referralCode",e)},[R]),(0,c.useEffect)(()=>{A.current&&s&&(A.current=!1,d())},[d,s]),(0,c.useEffect)(()=>{let e=e=>{let t=e.detail;t&&t.tab&&T(t.tab),w(!0)};return document.addEventListener("open-login-modal",e),()=>{document.removeEventListener("open-login-modal",e)}},[]),(0,c.useEffect)(()=>{s&&y()},[s,y]);let G=()=>{h()},P=e=>{if(e.preventDefault(),m&&m.length>0){let e=Math.floor(Math.random()*m.length),t=m[e];u.push("/chat?storyId=".concat(t.id))}else if(g&&g.length>0){let e=Math.floor(Math.random()*g.length),t=g[e];u.push("/chat?characterId=".concat(t.id))}};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"container mx-auto flex items-center justify-between px-4 py-2",children:[(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsx)(o(),{href:"/characters",className:"flex items-center",children:(0,a.jsx)(n.default,{src:"https://ext.same-assets.com/715601384/683049629.png",alt:"QuackAI",width:120,height:30,className:"mr-4"})})}),(0,a.jsx)("nav",{className:"hidden md:flex items-center space-x-6",children:z?s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o(),{href:"/",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"首页"}),(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"发现"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",onClick:P,children:"聊聊鸭"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"帮助"}),(0,a.jsxs)(N,{children:[(0,a.jsx)(j,{asChild:!0,children:(0,a.jsx)(l.$,{variant:"ghost",className:"relative h-8 w-8 rounded-full bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(0,a.jsxs)(F.eu,{className:"h-8 w-8",children:[(null==r?void 0:r.avatarUrl)?(0,a.jsx)(F.BK,{src:r.avatarUrl,alt:r.username||"User"}):null,(0,a.jsx)(F.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==r||null==(e=r.username)?void 0:e.charAt(0).toUpperCase())||"U"})]})})}),(0,a.jsxs)(S,{align:"end",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]",children:[(0,a.jsx)("div",{className:"flex items-center justify-start p-2 border-b border-[var(--border-color)]",children:(0,a.jsxs)("div",{className:"flex flex-col space-y-1 leading-none",children:[(0,a.jsx)("p",{className:"font-medium",children:(null==r?void 0:r.username)||(null==r?void 0:r.nickname)}),(0,a.jsx)("p",{className:"w-[200px] truncate text-sm text-[var(--text-secondary)]",children:null==r?void 0:r.email})]})}),(0,a.jsx)(o(),{href:"/profile",className:"cursor-pointer hover:bg-[var(--bg-tertiary)]",children:(0,a.jsx)(I,{children:"个人设置"})}),(0,a.jsx)(I,{className:"cursor-pointer text-red-500 hover:bg-[var(--bg-tertiary)] hover:text-red-500",onSelect:G,children:"退出登录"})]})]})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(l.$,{variant:"ghost",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm p-0 h-auto",onClick:()=>U("register"),children:"注册"}),(0,a.jsx)(o(),{href:"/",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"首页"}),(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"发现"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"帮助"}),(0,a.jsx)(l.$,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors",onClick:()=>U("login"),children:"登录"})]}):(0,a.jsxs)("div",{className:"flex items-center space-x-6 animate-pulse",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-10"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-16"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-12"}),(0,a.jsx)("div",{className:"h-8 w-8 bg-[var(--bg-tertiary)] rounded-full"})]})}),(0,a.jsx)("div",{className:"md:hidden",children:(0,a.jsx)(l.$,{variant:"ghost",size:"sm",className:"text-[var(--text-primary)]",onClick:()=>v(!x),children:(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),(0,a.jsx)("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),(0,a.jsx)("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})})})]}),x&&(0,a.jsx)("div",{className:"md:hidden bg-[var(--bg-secondary)] p-4",children:(0,a.jsx)("nav",{className:"flex flex-col space-y-4",children:z?s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 py-2 border-b border-[var(--border-color)]",children:[(0,a.jsxs)(F.eu,{className:"h-8 w-8",children:[(null==r?void 0:r.avatarUrl)?(0,a.jsx)(F.BK,{src:r.avatarUrl,alt:r.username||"User"}):null,(0,a.jsx)(F.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==r||null==(t=r.username)?void 0:t.charAt(0).toUpperCase())||"U"})]}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-sm font-medium",children:(null==r?void 0:r.username)||(null==r?void 0:r.nickname)}),(0,a.jsx)("span",{className:"text-xs text-[var(--text-secondary)]",children:null==r?void 0:r.email})]})]}),(0,a.jsx)(o(),{href:"/",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"首页"}),(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"发现"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",onClick:P,children:"聊聊鸭"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"帮助"}),(0,a.jsx)(o(),{href:"/profile",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"个人设置"}),(0,a.jsx)(l.$,{variant:"ghost",className:"text-red-500 hover:text-red-600 text-sm p-0 h-auto justify-start",onClick:G,children:"退出登录"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o(),{href:"/",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"首页"}),(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"发现"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"帮助"}),(0,a.jsx)(l.$,{variant:"ghost",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm p-0 h-auto justify-start",onClick:()=>U("register"),children:"注册"}),(0,a.jsx)(l.$,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors w-full justify-center",onClick:()=>U("login"),children:"登录"})]}):(0,a.jsxs)("div",{className:"flex flex-col space-y-4 animate-pulse",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-1/2"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-1/3"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-1/4"})]})})}),b&&(0,a.jsx)(p,{isOpen:b,onClose:()=>w(!1),initialTab:C})]})}function A(){return(0,a.jsxs)("div",{className:"container mx-auto flex items-center justify-between px-4 py-2",children:[(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsx)("div",{className:"w-[120px] h-[30px] bg-[var(--bg-tertiary)] rounded animate-pulse"})}),(0,a.jsxs)("div",{className:"hidden md:flex items-center space-x-6",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-10 animate-pulse"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-16 animate-pulse"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-12 animate-pulse"}),(0,a.jsx)("div",{className:"h-8 w-8 bg-[var(--bg-tertiary)] rounded-full animate-pulse"})]}),(0,a.jsx)("div",{className:"md:hidden",children:(0,a.jsx)("div",{className:"h-8 w-8 bg-[var(--bg-tertiary)] rounded animate-pulse"})})]})}function z(){return(0,a.jsx)("header",{className:"fixed top-0 left-0 right-0 z-50 bg-[var(--bg-primary)]/90 backdrop-blur-md border-b border-[var(--border-color)]",children:(0,a.jsx)(c.Suspense,{fallback:(0,a.jsx)(A,{}),children:(0,a.jsx)(T,{})})})}},6305:(e,t,r)=>{r.d(t,{HC:()=>s,Im:()=>l,QB:()=>n,TB:()=>o,TG:()=>d,Vs:()=>i,ov:()=>c,xk:()=>a,yw:()=>h});let a=e=>e.character.characters,s=e=>e.character.featuredCharacters,o=e=>e.character.currentCharacter,n=e=>e.character.isLoading,l=e=>e.character.error,c=e=>e.character.totalCount,i=e=>e.character.currentPage,d=e=>e.character.totalPages,h=e=>e.character.filters},6562:(e,t,r)=>{r.d(t,{u:()=>n});var a=r(2115),s=r(5695),o=r(7374);let n=e=>{let t=(0,s.useSearchParams)(),[r,n]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{r||("required"===t.get("auth")&&(o.oR.error("请先登录后访问该页面"),e&&setTimeout(()=>{e()},500)),n(!0))},[t,r,e]),{authChecked:r}}},7374:(e,t,r)=>{r.d(t,{oR:()=>n});var a=r(4752),s=r.n(a);let o=()=>({background:"var(--bg-secondary)",color:"var(--text-primary)",confirmButtonColor:"var(--switch-checked-bg)",cancelButtonColor:"var(--switch-unchecked-bg)"}),n={success:e=>{s().fire({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"success",title:e,...o()})},error:e=>{s().fire({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"error",title:e,...o()})},loading:e=>{s().fire({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"info",title:e,...o()})},promise:(e,t)=>s().fire({title:t.loading,allowOutsideClick:!1,showConfirmButton:!1,...o()}).then(()=>e.then(()=>{s().fire({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"success",title:t.success,...o()})}).catch(()=>{s().fire({toast:!0,position:"bottom-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,icon:"error",title:t.error,...o()})}))}},8578:(e,t,r)=>{r.d(t,{$c:()=>g,Ay:()=>C,ET:()=>f,FB:()=>l,JQ:()=>w,LD:()=>u,Nh:()=>x,Ob:()=>m,SU:()=>d,Uw:()=>v,f5:()=>p,iY:()=>h,oI:()=>i,r1:()=>y,tM:()=>b,tj:()=>c});var a=r(6439),s=r(4421);let o=(e,t)=>{console.log("Chat reducer called: ".concat(e),t)},n=(0,a.Z0)({name:"chat",initialState:{storyContexts:{},currentStoryContext:null,curMessages:[],isLoading:!1,isSending:!1,error:null,tempContext:null},reducers:{setMessages:(e,t)=>{o("setMessages",t.payload);let{storyId:r,messages:a}=t.payload;e.storyContexts[r]&&(e.storyContexts[r].messages=a),e.currentStoryContext&&e.currentStoryContext.id===r&&(e.curMessages=a)},addMessage:(e,t)=>{o("addMessage",t.payload);let r=t.payload,a=r.storyId;if(e.currentStoryContext&&e.currentStoryContext.id===a){let t=e.curMessages.findIndex(e=>e.id===r.id);-1!==t?e.curMessages[t]=r:e.curMessages.push(r)}},clearMessages:(e,t)=>{o("clearMessages",t.payload);let r=t.payload;e.storyContexts[r]&&(e.storyContexts[r].messages=[],e.storyContexts[r].lastMessage=void 0,e.storyContexts[r].lastMessageAt=void 0)},setCurrentStoryContext:(e,t)=>{o("setCurrentStoryContext",t.payload);let r=t.payload;if(e.currentStoryContext=r,r){var a;e.curMessages=(null==(a=e.storyContexts[r.id])?void 0:a.messages)||[]}else e.curMessages=[]},setStories:(e,t)=>{o("setStories",t.payload);let r={};t.payload.forEach(t=>{var a;let s=(null==(a=e.storyContexts[t.id])?void 0:a.messages)||[];r[t.id]={...t,messages:s}}),e.storyContexts=r},addStory:(e,t)=>{o("addStory",t.payload);let r=t.payload;r.messages||(r.messages=[]),e.storyContexts[r.id]={...e.storyContexts[r.id]||{},...r};let a={...e.storyContexts};delete a[r.id],e.storyContexts={[r.id]:e.storyContexts[r.id],...a}},removeStory:(e,t)=>{o("removeStory",t.payload);let r=t.payload;if(e.storyContexts[r]){var a;delete e.storyContexts[r],(null==(a=e.currentStoryContext)?void 0:a.id)===r&&(e.currentStoryContext=null)}},setLoading:(e,t)=>{o("setLoading",t.payload),e.isLoading=t.payload},setSending:(e,t)=>{o("setSending",t.payload),e.isSending=t.payload},setError:(e,t)=>{o("setError",t.payload),e.error=t.payload},clearError:e=>{o("clearError"),e.error=null},updateStoryDetails:(e,t)=>{let r=t.payload;if(r&&r.id)if(e.storyContexts[r.id]){let t=e.storyContexts[r.id].messages||[];e.storyContexts[r.id]={...e.storyContexts[r.id],...r,messages:t}}else{let t=r.lastMessage;e.storyContexts[r.id]={...r,lastMessage:t,messages:[]}}},setCurrentStoryContextFromDetails:(e,t)=>{o("setCurrentStoryContextFromDetails",t.payload);let r=t.payload;r&&r.id&&(e.currentStoryContext={...r,lastMessage:r.lastMessage,messages:[]},e.curMessages=[])},initTempStoryContext:(e,t)=>{o("initTempStoryContext",t.payload);let{character:r}=t.payload;if(e.tempContext&&e.tempContext.characterId===r.id)return;let a=new Date().toISOString(),n=[];r.greeting&&n.push({id:"greeting-".concat(Date.now()),role:s.hE.ASSISTANT,content:r.greeting,contentType:s._8.TEXT,createdAt:a,storyId:"temp",index:0,metadata:{}}),e.tempContext={id:"temp",title:"与".concat(r.name,"的临时对话"),characterId:r.id,characterName:r.name,avatarUrl:r.avatarUrl,userId:"temp-user",messages:n,messageCount:n.length,createdAt:a,updatedAt:a},e.storyContexts.temp&&delete e.storyContexts.temp}}}),{setMessages:l,addMessage:c,clearMessages:i,setCurrentStoryContext:d,setStories:h,addStory:u,removeStory:m,setLoading:y,setSending:g,setError:x,clearError:f,updateStoryDetails:p,setCurrentStoryContextFromDetails:v,initTempStoryContext:b}=n.actions,w=e=>!!e.chat.tempContext,C=n.reducer},9434:(e,t,r)=>{r.d(t,{cn:()=>o});var a=r(2596),s=r(9688);function o(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,s.QP)((0,a.$)(t))}}}]);