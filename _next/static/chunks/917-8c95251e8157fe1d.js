"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[917],{298:(e,t,r)=>{r.d(t,{Di:()=>d,LK:()=>l,V4:()=>c,d4:()=>m,ib:()=>o,jQ:()=>i,nT:()=>u,qi:()=>n});var a=r(8924);let s=e=>e.chat,o=(0,a.Mz)([e=>e.chat.currentStoryContext],e=>(null==e?void 0:e.id)||null),n=(0,a.Mz)([e=>e.character.currentCharacter],e=>(null==e?void 0:e.id)||null),l=(0,a.Mz)([s],e=>e.curMessages||[]),c=(0,a.Mz)([s],e=>Object.values(e.storyContexts).sort((e,t)=>{let r=e.lastMessageAt?new Date(e.lastMessageAt).getTime():0;return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():0)-r})),i=(0,a.Mz)([s],e=>e.currentStoryContext),d=e=>e.chat.isLoading,m=e=>e.chat.isSending,u=e=>e.chat.error;(0,a.Mz)([e=>e.chat,(e,t)=>t],(e,t)=>{if(e.currentStoryContext&&e.currentStoryContext.id===t)return e.currentStoryContext.messages||[];if("temp"===t){var r;return(null==(r=e.tempContext)?void 0:r.messages)||[]}let a=e.storyContexts[t];return a?a.messages:[]}),(0,a.Mz)([s,(e,t)=>t],(e,t)=>e.currentStoryContext&&e.currentStoryContext.id===t?e.currentStoryContext:t&&e.storyContexts[t]?e.storyContexts[t]:null),(0,a.Mz)([c],e=>[...e].sort((e,t)=>{let r=e.lastMessageAt?new Date(e.lastMessageAt).getTime():0;return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():0)-r}))},971:(e,t,r)=>{r.d(t,{py:()=>u,ji:()=>f,oA:()=>v,Xi:()=>p,d:()=>b,bn:()=>g,pc:()=>h,yn:()=>j,PS:()=>S,dF:()=>w,s_:()=>y,Gz:()=>x,RF:()=>N});var a=r(6439),s=r(8578),o=r(9249),n=r(6168),l=r(4421),c=r(3299);class i{async sendMessage(e){try{let t={content:e.content,contentType:e.contentType||l.oL.TEXT,index:e.index||0};return(await n.o.chat.sendMessage({id:e.storyId,sendMessageRequestDto:t})).data}catch(e){throw console.error("Failed to send message:",e),e}}async sendStreamMessage(e,t){try{let r=await n.o.chat.streamResponse({id:e.storyId,message:e.content});console.warn("Stream handling in sendStreamMessage needs proper implementation based on SDK behavior.",r);let a={messageId:"temp-id-".concat(Date.now()),content:"[Streaming mock chunk]",metadata:{},storyId:e.storyId,isLast:!0};t(a)}catch(e){throw console.error("Failed to send streaming message:",e),e}}async getHistory(e){try{let t={page:e.page||1,limit:e.limit||20,role:e.role,startTime:e.from,endTime:e.to},{data:r}=await n.o.chat.getStoryMessages({id:e.storyId,limit:t.limit,page:t.page});return{messages:r.items||[],totalCount:r.total,currentPage:r.page,totalPages:Math.ceil(r.total/r.limit)}}catch(e){throw console.error("Failed to fetch chat history:",e),e}}async getAllMessages(e){try{let e=1,t=[],r=0,a=1;for(;;){let{data:s}=await n.o.chat.getAllMessages({page:e,limit:100}),o=s.items||[];if(t=t.concat(o),r=s.total,a=Math.ceil(s.total/(s.limit||100)),e>=a)break;e++}return{messages:t,totalCount:r,currentPage:a,totalPages:a}}catch(e){throw console.error("Failed to fetch all messages:",e),e}}async deleteMessage(e){console.warn("deleteMessage is not implemented in the SDK")}async clearHistory(e){try{await n.o.chat.clearStoryMessages({id:e})}catch(t){throw console.error("Failed to clear history for story ".concat(e,":"),t),t}}async createStory(e){try{return(await n.o.chat.createStory({createStoryRequestDto:e})).data}catch(e){throw console.error("Failed to create story:",e),e}}async deleteStory(e){try{await n.o.chat.deleteStory({id:e})}catch(t){throw console.error("Failed to delete story ".concat(e,":"),t),t}}async exportStoryHistory(e,t){try{await n.o.chat.exportStoryHistory({id:e})}catch(t){throw console.error("Failed to export history for story ".concat(e,":"),t),t}}async getContextTips(e){try{await n.o.chat.getContextTips({id:e.storyId})}catch(t){throw console.error("Failed to get context tips for story ".concat(e.storyId,":"),t),t}}async getStory(e){try{return(await n.o.chat.getStory({id:e})).data}catch(t){throw console.error("Failed to get story ".concat(e,":"),t),t}}async updateStory(e,t){try{return(await n.o.chat.updateStory({id:e,updateStoryRequestDto:{title:t}})).data}catch(t){throw console.error("Failed to update story ".concat(e,":"),t),t}}async getUserStories(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;try{return(await n.o.chat.getUserStories({page:t,limit:r})).data}catch(t){throw console.error("Failed to get user stories for user ".concat(e,":"),t),t}}async regenerateResponse(e,t,r){try{return console.warn("SDK只接受storyId参数，messageId=".concat(t,"可能无法正确传递")),(await n.o.chat.regenerateResponse({id:e})).data}catch(r){throw console.error("Failed to regenerate response for message ".concat(t," in story ").concat(e,":"),r),r}}async stopGeneration(e){try{await n.o.chat.stopGeneration({id:e})}catch(t){throw console.error("Failed to stop generation for story ".concat(e,":"),t),t}}}let d=new(i=(0,o.Cg)([c.A.Singleton],i));var m=r(9371);let u=(0,a.zD)("chat/addMessageLocal",async(e,t)=>{let{dispatch:r,getState:a}=t,o=a().chat.curMessages,n=o.length>0?Math.max(...o.map(e=>{var t;return null!=(t=e.index)?t:0}))+1:0,c={id:"user-".concat(Date.now()),role:l.hE.USER,content:e.content,contentType:e.contentType||l._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:n,metadata:e.parentMessageId?{parentMessageId:e.parentMessageId}:{}};return r((0,s.tj)(c)),c}),y=(0,a.zD)("chat/sendMessage",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.$c)(!0));let t=await d.sendMessage({...e});r((0,s.tj)(t))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to send message:",t)}finally{r((0,s.$c)(!1))}}),x=(0,a.zD)("chat/sendStreamMessage",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.$c)(!0));let t=a(),o=[],n=t.chat.currentStoryContext;n&&n.id===e.storyId?o=n.messages||[]:console.warn("Current story context id (".concat(null==n?void 0:n.id,") does not match the provided storyId (").concat(e.storyId,")"));let c=o.length>0?Math.max(...o.map(e=>{var t;return null!=(t=e.index)?t:0}))+1:0,i={id:"user-".concat(Date.now()),role:l.hE.USER,content:e.content,contentType:e.contentType||l._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:c,metadata:e.parentMessageId?{parentMessageId:e.parentMessageId}:{}};r((0,s.tj)(i));let m="char-".concat(Date.now()),u="",y="",x={id:m,role:l.hE.ASSISTANT,content:"",contentType:l._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:c+1,metadata:{parentMessageId:i.id}};r((0,s.tj)(x)),await d.sendStreamMessage({...e,parentMessageId:i.id,index:c},t=>{u+=t.content,t.messageId&&t.messageId!==m&&(y=t.messageId),r((0,s.tj)({id:y||m,role:l.hE.ASSISTANT,content:u,contentType:l._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:c+1,metadata:{parentMessageId:i.id}})),t.isLast&&console.log("Stream message completed")})}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to send stream message:",t)}finally{r((0,s.$c)(!1))}}),h=(0,a.zD)("chat/fetchStoryHistory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{if(!e.storyId||!e.characterId)return void console.error("Cannot fetch history: missing storyId or characterId");console.log("Fetching chat history for story ".concat(e.storyId)),r((0,s.r1)(!0));let{page:t,limit:a}=e;try{let o=await d.getHistory({storyId:e.storyId,characterId:e.characterId,page:t,limit:a});if(o&&o.messages){let t=o.messages.map(t=>({...t,storyId:e.storyId}));r((0,s.FB)({storyId:e.storyId,messages:t}))}}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("API error when fetching story history:",t)}}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to fetch story history:",t)}finally{r((0,s.r1)(!1))}}),g=(0,a.zD)("chat/fetchAllStory",async(e,t)=>{let{page:r=1,limit:a=20}=e,{dispatch:o,getState:n}=t;try{console.log("Fetching all stories"),o((0,s.r1)(!0));try{var l;let e=(null==(l=n().user.currentUser)?void 0:l.id)||"",t=await d.getUserStories(e,r,a);if(t&&t.items){let e=t.items.map(e=>({...e,messages:[]}));o((0,s.iY)(e))}}catch(t){let e=t instanceof Error?t.message:String(t);o((0,s.Nh)(e)),console.error("API error when fetching stories:",t)}}catch(t){let e=t instanceof Error?t.message:String(t);o((0,s.Nh)(e)),console.error("Failed to fetch stories:",t)}finally{o((0,s.r1)(!1))}}),p=(0,a.zD)("chat/deleteMessage",async(e,t)=>{let{messageId:r,storyId:a}=e,{dispatch:o,getState:n}=t;try{let{chat:e}=n(),t=e.storyContexts[a];if(t){let e=t.messages.filter(e=>e.id!==r);o((0,s.FB)({storyId:a,messages:e})),console.warn("Message deleted locally, backend deletion not implemented in SDK.")}else console.error("Story context not found for ID: ".concat(a))}catch(t){let e=t instanceof Error?t.message:String(t);o((0,s.Nh)(e)),console.error("Failed to delete message:",t)}}),f=(0,a.zD)("chat/clearStoryHistory",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0)),await d.clearHistory(e),r((0,s.oI)(e))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to clear chat history:",t)}finally{r((0,s.r1)(!1))}}),v=(0,a.zD)("chat/createStory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.r1)(!0));let t={...await d.createStory(e),messages:[]};return r((0,s.LD)(t)),r((0,s.SU)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to create chat story:",t),null}finally{r((0,s.r1)(!1))}}),b=(0,a.zD)("chat/deleteStory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.r1)(!0));let{chat:t}=a();if(t.storyContexts[e]){try{await d.deleteStory(e)}catch(t){console.warn("Failed to delete story ".concat(e," via ChatService:"),t)}r((0,s.Ob)(e))}else console.warn("Story with ID ".concat(e," not found for deletion."))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to delete chat story:",t)}finally{r((0,s.r1)(!1))}}),j=(0,a.zD)("chat/fetchStoryDetails",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await d.getStory(e);return console.log("storyDetails",JSON.stringify(t)),t&&r((0,s.f5)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to fetch story details:",t),null}finally{r((0,s.r1)(!1))}}),S=(0,a.zD)("chat/fetchStoryToCurStoryContext",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await d.getStory(e);return console.log("fetchStoryToCurStoryContext storyDetails",JSON.stringify(t)),t&&r((0,s.Uw)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to fetch story to current story context:",t),null}finally{r((0,s.r1)(!1))}}),N=(0,a.zD)("chat/updateStoryTitle",async(e,t)=>{let{storyId:r,title:a}=e,{dispatch:o,getState:n}=t;try{o((0,s.r1)(!0));let e=await d.updateStory(r,a);if(e){var l;o((0,s.f5)(e));let t=e.id;(null==(l=n().chat.currentStoryContext)?void 0:l.id)===t&&o((0,s.Uw)(e))}return e}catch(t){let e=t instanceof Error?t.message:String(t);return o((0,s.Nh)(e)),console.error("Failed to update story title:",t),null}finally{o((0,s.r1)(!1))}}),w=(0,a.zD)("chat/forkSharedStory",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await m.a.forkSharedStory(e);if(t&&t.newStoryId)return await r(S(t.newStoryId)),t.newStoryId;return r((0,s.Nh)("未能获取新创建的故事ID")),null}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("分享故事衍生失败:",t),null}finally{r((0,s.r1)(!1))}})},3500:(e,t,r)=>{r.d(t,{R7:()=>m,Z3:()=>c,ki:()=>d,w0:()=>i});var a=r(2115),s=r(2045),o=r(298),n=r(971),l=r(8578);let c=()=>{let e=(0,s.j)(),t=(0,s.G)(o.ib),r=(0,s.G)(o.LK),c=(0,s.G)(o.jQ),i=(0,s.G)(o.qi),d=(0,s.G)(o.Di),m=(0,s.G)(o.d4),u=(0,s.G)(o.nT),y=(0,a.useCallback)(t=>{if(!t)return void console.error("Cannot send message null");e((0,n.s_)(t))},[e]),x=(0,a.useCallback)(async t=>{if(!t.storyId)return console.error("Cannot add message without a current story selected"),null;if(!t.characterId)return console.error("Cannot add message without characterId"),null;let r=t.storyId,a=await e((0,n.py)({...t,storyId:r}));return n.py.fulfilled.match(a)?a.payload:null},[e]),h=(0,a.useCallback)(t=>c?t.characterId||i?void e((0,n.Gz)({...t,storyId:c.id})):void console.error("Cannot send stream message without characterId"):void console.error("Cannot send stream message without a current story selected"),[e,c,i]),g=(0,a.useCallback)((t,r)=>{if(!c||!c.characterId)return void console.warn("Cannot fetch history without current story and character ID");let a={storyId:c.id,characterId:c.characterId,page:t,limit:r};e((0,n.pc)(a))},[e,c]),p=(0,a.useCallback)(t=>{if(!c)return void console.error("Cannot delete message without current story");e((0,n.Xi)({messageId:t,storyId:c.id}))},[e,c]),f=(0,a.useCallback)(()=>{if(!c)return void console.error("Cannot clear history without current story");e((0,n.ji)(c.id))},[e,c]);return{currentStoryId:t,currentCharacterId:i,messages:r,currentStory:c,isLoading:d,isSending:m,error:u,sendMessage:y,addMessage:x,sendStreamMessage:h,fetchCurStoryHistory:g,deleteMessage:p,clearHistory:f,clearErrors:(0,a.useCallback)(()=>{e((0,l.ET)())},[e])}},i=()=>{let e=(0,s.j)();return{clearCurrentStoryContext:(0,a.useCallback)(()=>{e((0,l.SU)(null))},[e])}},d=()=>{let e=(0,s.j)(),t=(0,s.G)(e=>e.chat.tempContext),r=(0,s.G)(l.JQ);return{tempContext:t,hasTempContext:r,initTempContext:(0,a.useCallback)(t=>{e((0,l.tM)({character:t}))},[e]),updateTempTitle:(0,a.useCallback)(t=>{e((0,l.pg)({title:t}))},[e])}},m=()=>{let e=(0,s.j)(),t=(0,s.G)(o.V4),r=(0,s.G)(o.Di),l=(0,s.G)(o.nT),c=(0,s.G)(e=>e.chat.storyContexts),i=(0,s.G)(o.ib),d=(0,a.useCallback)(()=>{console.log("Dispatching fetchAllStoryAsync"),e((0,n.bn)({}))},[e]),m=(0,a.useCallback)(()=>{console.log("Forcing refresh of stories"),e((0,n.bn)({}))},[e]),u=(0,a.useCallback)(e=>e&&c[e]||null,[c]),y=(0,a.useCallback)(async t=>{if(!t)return console.error("Cannot fetch story details without storyId"),null;let r=c[t];if(r)return r;let a=await e((0,n.yn)(t));return n.yn.fulfilled.match(a)&&a.payload?c[t]||a.payload:null},[e,c]),x=(0,a.useCallback)(async t=>{if(!t)return console.error("Cannot fetch story to current context without storyId"),null;let r=await e((0,n.PS)(t));return n.PS.fulfilled.match(r)&&r.payload?r.payload:null},[e]),h=(0,a.useCallback)(async t=>{let r=await e((0,n.oA)(t));return n.oA.fulfilled.match(r)?r.payload:null},[e]),g=(0,a.useCallback)(t=>{e((0,n.d)(t))},[e]);return{stories:t,isLoading:r,error:l,currentStoryId:i,fetchStories:d,fetchStoryDetails:y,fetchStoryToCurStoryContext:x,getStoryById:u,refreshStories:m,createStory:h,deleteStory:g,updateStoryTitle:(0,a.useCallback)(async(t,r)=>{let a=await e((0,n.RF)({storyId:t,title:r}));return n.RF.fulfilled.match(a)?a.payload:null},[e]),forkSharedStory:(0,a.useCallback)(async t=>{let r=await e((0,n.dF)(t));return n.dF.fulfilled.match(r)?r.payload:null},[e])}}},4165:(e,t,r)=>{r.d(t,{Cf:()=>m,Es:()=>y,L3:()=>x,c7:()=>u,lG:()=>c});var a=r(5155),s=r(2115),o=r(5452),n=r(5318),l=r(9434);let c=o.bL;o.l9;let i=o.ZL;o.bm;let d=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.hJ,{ref:t,className:(0,l.cn)("fixed inset-0 z-50 bg-background backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...s})});d.displayName=o.hJ.displayName;let m=s.forwardRef((e,t)=>{let{className:r,children:s,...c}=e;return(0,a.jsxs)(i,{children:[(0,a.jsx)(d,{}),(0,a.jsxs)(o.UC,{ref:t,className:(0,l.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-card p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",r),...c,children:[s,(0,a.jsxs)(o.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,a.jsx)(n.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});m.displayName=o.UC.displayName;let u=e=>{let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...r})};u.displayName="DialogHeader";let y=e=>{let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...r})};y.displayName="DialogFooter";let x=s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.hE,{ref:t,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight text-foreground",r),...s})});x.displayName=o.hE.displayName,s.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(o.VY,{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",r),...s})}).displayName=o.VY.displayName},5298:(e,t,r)=>{r.d(t,{default:()=>R});var a=r(5155),s=r(6874),o=r.n(s),n=r(6766),l=r(285),c=r(2115),i=r(4540),d=r(4165),m=r(704),u=r(9434);let y=m.bL,x=c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(m.B8,{ref:t,className:(0,u.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",r),...s})});x.displayName=m.B8.displayName;let h=c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(m.l9,{ref:t,className:(0,u.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",r),...s})});h.displayName=m.l9.displayName;let g=c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(m.UC,{ref:t,className:(0,u.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",r),...s})});g.displayName=m.UC.displayName;var p=r(8613),f=r(2732),v=r(3096);function b(e){let{isOpen:t,onClose:r,initialTab:s="login"}=e;(0,i.wA)();let{isLoading:o,error:m}=(0,i.d4)(e=>e.user),{login:u,register:b,clearErrors:j}=(0,p.As)(),[S,N]=(0,c.useState)(s),[w,C]=(0,c.useState)("add@1232163.com"),[I,M]=(0,c.useState)("12345678aA"),[k,D]=(0,c.useState)("add"),[T,E]=(0,c.useState)(t),[F,A]=(0,c.useState)(!1),[z,U]=(0,c.useState)(!1),[R,L]=(0,c.useState)(""),[G,$]=(0,c.useState)(!1),[q,_]=(0,c.useState)(!1),[P,O]=(0,c.useState)({});(0,c.useEffect)(()=>{let e=localStorage.getItem("referralCode");console.log("LoginModal checking localStorage for referral code:",e),e?(L(e),$(!0)):R||$(!1)},[t,R]),(0,c.useEffect)(()=>{let e=e=>{let t=e.detail;t&&t.tab&&N(t.tab),E(!0)};return document.addEventListener("open-login-modal",e),()=>{document.removeEventListener("open-login-modal",e)}},[]),(0,c.useEffect)(()=>{N(s)},[s]),(0,c.useEffect)(()=>{E(t)},[t]);let B=()=>{E(!1),j(),O({}),r()},H=e=>e.length<3?(O(e=>({...e,username:"Username must be at least 3 characters long"})),!1):e.length>20?(O(e=>({...e,username:"Username cannot exceed 20 characters"})),!1):/^[a-zA-Z0-9_-]+$/.test(e)?(O(e=>({...e,username:void 0})),!0):(O(e=>({...e,username:"Username can only contain letters, numbers, underscores, and hyphens"})),!1),V=async e=>{e.preventDefault();try{await u({email:w,password:I})&&B()}catch(e){console.error("Login failed:",e)}},J=async e=>{e.preventDefault();let t=H(k);if(!q||!t){q||P.username;return}try{await b({email:w,password:I,username:k,invitationCode:R||void 0})&&B()}catch(e){console.error("Registration failed:",e)}};return(0,c.useEffect)(()=>{O({})},[S]),(0,a.jsx)(d.lG,{open:T,onOpenChange:B,children:(0,a.jsxs)(d.Cf,{className:"sm:max-w-md bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]",children:[(0,a.jsx)(d.c7,{children:(0,a.jsx)(d.L3,{className:"text-center text-xl font-normal",children:"login"===S?"登录":"注册"})}),(0,a.jsxs)(y,{defaultValue:s,value:S,onValueChange:N,className:"w-full",children:[(0,a.jsxs)(x,{className:"grid w-full grid-cols-2 bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(h,{value:"login",className:"data-[state=active]:bg-[var(--bg-secondary)] data-[state=active]:text-[var(--text-primary)]",children:"登录"}),(0,a.jsx)(h,{value:"register",className:"data-[state=active]:bg-[var(--bg-secondary)] data-[state=active]:text-[var(--text-primary)]",children:"注册"})]}),(0,a.jsxs)(g,{value:"login",className:"mt-4",children:[(0,a.jsxs)("form",{onSubmit:V,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邮箱"}),(0,a.jsx)("input",{type:"email",placeholder:"邮箱地址",value:w,onChange:e=>C(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"密码"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{type:F?"text":"password",placeholder:"密码",value:I,onChange:e=>M(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus pr-10"}),(0,a.jsx)("button",{type:"button",onClick:()=>A(!F),className:"absolute inset-y-0 right-0 px-3 flex items-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:F?(0,a.jsx)(v.N5q,{}):(0,a.jsx)(v.V$C,{})})]})]}),m&&(0,a.jsx)("div",{className:"text-[var(--error-text)] text-sm",children:m}),(0,a.jsx)(l.$,{type:"submit",variant:"outline",className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:o,children:o?"登录中...":"登录"})]}),(0,a.jsxs)("div",{className:"relative flex items-center py-4",children:[(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"}),(0,a.jsx)("span",{className:"flex-shrink mx-4 text-[var(--text-secondary)] text-sm",children:"或"}),(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"})]}),(0,a.jsxs)(l.$,{variant:"outline",className:"w-full flex items-center justify-center gap-2 bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(n.default,{src:"https://ext.same-assets.com/1551878970/904099674.svg+xml",alt:"Discord",width:20,height:20}),(0,a.jsx)("span",{children:"使用 Discord 登录"})]})]}),(0,a.jsxs)(g,{value:"register",className:"mt-4",children:[(0,a.jsxs)("form",{onSubmit:J,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"用户名"}),(0,a.jsx)("input",{type:"text",placeholder:"用户名",value:k,onChange:e=>{let t=e.target.value;D(t),"register"===S&&t?H(t):O(e=>({...e,username:void 0}))},required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus ".concat(P.username?"border-[var(--error-border)] focus:ring-[var(--error-text)]":"focus:ring-[var(--primary)]")}),P.username&&(0,a.jsx)("div",{className:"text-[var(--error-text)] text-xs mt-1",children:P.username})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邮箱"}),(0,a.jsx)("input",{type:"email",placeholder:"邮箱地址",value:w,onChange:e=>C(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"密码"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{type:F?"text":"password",placeholder:"请输入密码",value:I,onChange:e=>{M(e.target.value)},className:"w-full p-2 border border-gray-300 rounded bg-[var(--bg-tertiary)] text-[var(--text-primary)] input-focus pr-10"}),(0,a.jsx)("button",{type:"button",onClick:()=>A(!F),className:"absolute inset-y-0 right-0 px-3 flex items-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:F?(0,a.jsx)(v.N5q,{}):(0,a.jsx)(v.V$C,{})})]}),"register"===S&&(0,a.jsx)(f.g,{password:I,onValidationChange:_})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邀请码 (可选)"}),(0,a.jsx)("input",{type:"text",placeholder:"输入邀请码",value:R,onChange:e=>L(e.target.value),readOnly:G,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus ".concat(G?"cursor-not-allowed opacity-70":"")}),G&&(0,a.jsx)("p",{className:"text-xs text-[var(--text-secondary)] mt-1",children:"已使用推荐链接中的邀请码。"})]}),m&&(0,a.jsx)("div",{className:"text-[var(--error-text)] text-sm",children:m}),(0,a.jsx)(l.$,{type:"submit",variant:"outline",className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:o||!!P.username,children:o?"注册中...":"注册"})]}),(0,a.jsxs)("div",{className:"relative flex items-center py-4",children:[(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"}),(0,a.jsx)("span",{className:"flex-shrink mx-4 text-[var(--text-secondary)] text-sm",children:"或"}),(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"})]}),(0,a.jsxs)(l.$,{variant:"outline",className:"w-full flex items-center justify-center gap-2 bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(n.default,{src:"https://ext.same-assets.com/1551878970/904099674.svg+xml",alt:"Discord",width:20,height:20}),(0,a.jsx)("span",{children:"使用 Discord 注册"})]})]})]}),(0,a.jsxs)("div",{className:"text-center text-sm text-[var(--text-secondary)] mt-4",children:[(0,a.jsx)("p",{children:"Quack是免费使用"}),(0,a.jsx)("p",{children:"加入Discord社群可以获得更多福利"})]})]})})}var j=r(7230),S=r(3158),N=r(518),w=r(154);let C=j.bL,I=j.l9;j.YJ,j.ZL,j.Pb,j.z6,c.forwardRef((e,t)=>{let{className:r,inset:s,children:o,...n}=e;return(0,a.jsxs)(j.ZP,{ref:t,className:(0,u.cn)("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s&&"pl-8",r),...n,children:[o,(0,a.jsx)(S.A,{className:"ml-auto"})]})}).displayName=j.ZP.displayName,c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(j.G5,{ref:t,className:(0,u.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...s})}).displayName=j.G5.displayName;let M=c.forwardRef((e,t)=>{let{className:r,sideOffset:s=4,...o}=e;return(0,a.jsx)(j.ZL,{children:(0,a.jsx)(j.UC,{ref:t,sideOffset:s,className:(0,u.cn)("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...o})})});M.displayName=j.UC.displayName;let k=c.forwardRef((e,t)=>{let{className:r,inset:s,...o}=e;return(0,a.jsx)(j.q7,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",s&&"pl-8",r),...o})});k.displayName=j.q7.displayName,c.forwardRef((e,t)=>{let{className:r,children:s,checked:o,...n}=e;return(0,a.jsxs)(j.H_,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),checked:o,...n,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(j.VF,{children:(0,a.jsx)(N.A,{className:"h-4 w-4"})})}),s]})}).displayName=j.H_.displayName,c.forwardRef((e,t)=>{let{className:r,children:s,...o}=e;return(0,a.jsxs)(j.hN,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),...o,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(j.VF,{children:(0,a.jsx)(w.A,{className:"h-2 w-2 fill-current"})})}),s]})}).displayName=j.hN.displayName,c.forwardRef((e,t)=>{let{className:r,inset:s,...o}=e;return(0,a.jsx)(j.JU,{ref:t,className:(0,u.cn)("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",r),...o})}).displayName=j.JU.displayName,c.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(j.wv,{ref:t,className:(0,u.cn)("-mx-1 my-1 h-px bg-muted",r),...s})}).displayName=j.wv.displayName;var D=r(6562),T=r(1394),E=r(5695),F=r(3500),A=r(2847);function z(){var e,t;(0,i.wA)();let r=(0,i.d4)(e=>e.user.currentUser),s=(0,i.d4)(e=>e.user.isAuthenticated),{fetchUserProfile:d,logoutUser:m}=(0,p.As)(),u=(0,E.useRouter)(),{stories:y,fetchStories:x}=(0,F.R7)(),{characters:h}=(0,A.Ib)(),[g,f]=(0,c.useState)(!1),[v,j]=(0,c.useState)(!1),[S,N]=(0,c.useState)("login"),w=(0,c.useRef)(!0),[z,U]=(0,c.useState)(!1),R=(0,E.useSearchParams)(),L=e=>{N(e),j(!0)};(0,D.u)(L.bind(null,"login")),(0,c.useEffect)(()=>{"/"===window.location.pathname&&u.push("/characters")},[u]),(0,c.useEffect)(()=>{U(!0);let e=R.get("ref");e&&localStorage.setItem("referralCode",e)},[R]),(0,c.useEffect)(()=>{w.current&&s&&(w.current=!1,d())},[d,s]),(0,c.useEffect)(()=>{let e=e=>{let t=e.detail;t&&t.tab&&N(t.tab),j(!0)};return document.addEventListener("open-login-modal",e),()=>{document.removeEventListener("open-login-modal",e)}},[]),(0,c.useEffect)(()=>{s&&x()},[s,x]);let G=()=>{m()},$=e=>{if(e.preventDefault(),y&&y.length>0){let e=Math.floor(Math.random()*y.length),t=y[e];u.push("/chat?storyId=".concat(t.id))}else if(h&&h.length>0){let e=Math.floor(Math.random()*h.length),t=h[e];u.push("/chat?characterId=".concat(t.id))}};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"container mx-auto flex items-center justify-between px-4 py-2",children:[(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsx)(o(),{href:"/characters",className:"flex items-center",children:(0,a.jsx)(n.default,{src:"https://ext.same-assets.com/715601384/683049629.png",alt:"QuackAI",width:120,height:30,className:"mr-4"})})}),(0,a.jsx)("nav",{className:"hidden md:flex items-center space-x-6",children:z?s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o(),{href:"/",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"首页"}),(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"发现"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",onClick:$,children:"聊聊鸭"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"帮助"}),(0,a.jsxs)(C,{children:[(0,a.jsx)(I,{asChild:!0,children:(0,a.jsx)(l.$,{variant:"ghost",className:"relative h-8 w-8 rounded-full bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(0,a.jsxs)(T.eu,{className:"h-8 w-8",children:[(null==r?void 0:r.avatarUrl)?(0,a.jsx)(T.BK,{src:r.avatarUrl,alt:r.username||"User"}):null,(0,a.jsx)(T.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==r||null==(e=r.username)?void 0:e.charAt(0).toUpperCase())||"U"})]})})}),(0,a.jsxs)(M,{align:"end",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]",children:[(0,a.jsx)("div",{className:"flex items-center justify-start p-2 border-b border-[var(--border-color)]",children:(0,a.jsxs)("div",{className:"flex flex-col space-y-1 leading-none",children:[(0,a.jsx)("p",{className:"font-medium",children:(null==r?void 0:r.username)||(null==r?void 0:r.nickname)}),(0,a.jsx)("p",{className:"w-[200px] truncate text-sm text-[var(--text-secondary)]",children:null==r?void 0:r.email})]})}),(0,a.jsx)(o(),{href:"/profile",className:"cursor-pointer hover:bg-[var(--bg-tertiary)]",children:(0,a.jsx)(k,{children:"个人设置"})}),(0,a.jsx)(k,{className:"cursor-pointer text-red-500 hover:bg-[var(--bg-tertiary)] hover:text-red-500",onSelect:G,children:"退出登录"})]})]})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(l.$,{variant:"ghost",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm p-0 h-auto",onClick:()=>L("register"),children:"注册"}),(0,a.jsx)(o(),{href:"/",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"首页"}),(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"发现"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm",children:"帮助"}),(0,a.jsx)(l.$,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors",onClick:()=>L("login"),children:"登录"})]}):(0,a.jsxs)("div",{className:"flex items-center space-x-6 animate-pulse",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-10"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-16"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-12"}),(0,a.jsx)("div",{className:"h-8 w-8 bg-[var(--bg-tertiary)] rounded-full"})]})}),(0,a.jsx)("div",{className:"md:hidden",children:(0,a.jsx)(l.$,{variant:"ghost",size:"sm",className:"text-[var(--text-primary)]",onClick:()=>f(!g),children:(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),(0,a.jsx)("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),(0,a.jsx)("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})})})]}),g&&(0,a.jsx)("div",{className:"md:hidden bg-[var(--bg-secondary)] p-4",children:(0,a.jsx)("nav",{className:"flex flex-col space-y-4",children:z?s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 py-2 border-b border-[var(--border-color)]",children:[(0,a.jsxs)(T.eu,{className:"h-8 w-8",children:[(null==r?void 0:r.avatarUrl)?(0,a.jsx)(T.BK,{src:r.avatarUrl,alt:r.username||"User"}):null,(0,a.jsx)(T.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==r||null==(t=r.username)?void 0:t.charAt(0).toUpperCase())||"U"})]}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-sm font-medium",children:(null==r?void 0:r.username)||(null==r?void 0:r.nickname)}),(0,a.jsx)("span",{className:"text-xs text-[var(--text-secondary)]",children:null==r?void 0:r.email})]})]}),(0,a.jsx)(o(),{href:"/",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"首页"}),(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"发现"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",onClick:$,children:"聊聊鸭"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"帮助"}),(0,a.jsx)(o(),{href:"/profile",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"个人设置"}),(0,a.jsx)(l.$,{variant:"ghost",className:"text-red-500 hover:text-red-600 text-sm p-0 h-auto justify-start",onClick:G,children:"退出登录"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o(),{href:"/",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"首页"}),(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"发现"}),(0,a.jsx)(o(),{href:"#",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm py-2",children:"帮助"}),(0,a.jsx)(l.$,{variant:"ghost",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm p-0 h-auto justify-start",onClick:()=>L("register"),children:"注册"}),(0,a.jsx)(l.$,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors w-full justify-center",onClick:()=>L("login"),children:"登录"})]}):(0,a.jsxs)("div",{className:"flex flex-col space-y-4 animate-pulse",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-1/2"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-1/3"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-1/4"})]})})}),v&&(0,a.jsx)(b,{isOpen:v,onClose:()=>j(!1),initialTab:S})]})}function U(){return(0,a.jsxs)("div",{className:"container mx-auto flex items-center justify-between px-4 py-2",children:[(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsx)("div",{className:"w-[120px] h-[30px] bg-[var(--bg-tertiary)] rounded animate-pulse"})}),(0,a.jsxs)("div",{className:"hidden md:flex items-center space-x-6",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-10 animate-pulse"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-16 animate-pulse"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-12 animate-pulse"}),(0,a.jsx)("div",{className:"h-8 w-8 bg-[var(--bg-tertiary)] rounded-full animate-pulse"})]}),(0,a.jsx)("div",{className:"md:hidden",children:(0,a.jsx)("div",{className:"h-8 w-8 bg-[var(--bg-tertiary)] rounded animate-pulse"})})]})}function R(){return(0,a.jsx)("header",{className:"fixed top-0 left-0 right-0 z-50 bg-[var(--bg-primary)]/90 backdrop-blur-md border-b border-[var(--border-color)]",children:(0,a.jsx)(c.Suspense,{fallback:(0,a.jsx)(U,{}),children:(0,a.jsx)(z,{})})})}},6562:(e,t,r)=>{r.d(t,{u:()=>n});var a=r(2115),s=r(5695),o=r(7374);let n=e=>{let t=(0,s.useSearchParams)(),[r,n]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{r||("required"===t.get("auth")&&(o.oR.error("请先登录后访问该页面"),e&&setTimeout(()=>{e()},500)),n(!0))},[t,r,e]),{authChecked:r}}},8578:(e,t,r)=>{r.d(t,{$c:()=>h,Ay:()=>w,ET:()=>p,FB:()=>l,JQ:()=>N,LD:()=>u,Nh:()=>g,Ob:()=>y,SU:()=>d,Uw:()=>v,XB:()=>j,f5:()=>f,iY:()=>m,oI:()=>i,pg:()=>S,r1:()=>x,tM:()=>b,tj:()=>c});var a=r(6439),s=r(4421);let o=(e,t)=>{console.log("Chat reducer called: ".concat(e),t)},n=(0,a.Z0)({name:"chat",initialState:{storyContexts:{},currentStoryContext:null,curMessages:[],isLoading:!1,isSending:!1,error:null,tempContext:null},reducers:{setMessages:(e,t)=>{o("setMessages",t.payload);let{storyId:r,messages:a}=t.payload;e.storyContexts[r]&&(e.storyContexts[r].messages=a),e.currentStoryContext&&e.currentStoryContext.id===r&&(e.curMessages=a)},addMessage:(e,t)=>{o("addMessage",t.payload);let r=t.payload,a=r.storyId;if(e.currentStoryContext&&e.currentStoryContext.id===a){let t=e.curMessages.findIndex(e=>e.id===r.id);-1!==t?e.curMessages[t]=r:e.curMessages.push(r)}},clearMessages:(e,t)=>{o("clearMessages",t.payload);let r=t.payload;e.storyContexts[r]&&(e.storyContexts[r].messages=[],e.storyContexts[r].lastMessage=void 0,e.storyContexts[r].lastMessageAt=void 0)},setCurrentStoryContext:(e,t)=>{o("setCurrentStoryContext",t.payload);let r=t.payload;if(e.currentStoryContext=r,r){var a;e.curMessages=(null==(a=e.storyContexts[r.id])?void 0:a.messages)||[]}else e.curMessages=[]},setStories:(e,t)=>{o("setStories",t.payload);let r={};t.payload.forEach(t=>{var a;let s=(null==(a=e.storyContexts[t.id])?void 0:a.messages)||[];r[t.id]={...t,messages:s}}),e.storyContexts=r},addStory:(e,t)=>{o("addStory",t.payload);let r=t.payload;r.messages||(r.messages=[]),e.storyContexts[r.id]={...e.storyContexts[r.id]||{},...r};let a={...e.storyContexts};delete a[r.id],e.storyContexts={[r.id]:e.storyContexts[r.id],...a}},removeStory:(e,t)=>{o("removeStory",t.payload);let r=t.payload;if(e.storyContexts[r]){var a;delete e.storyContexts[r],(null==(a=e.currentStoryContext)?void 0:a.id)===r&&(e.currentStoryContext=null)}},setLoading:(e,t)=>{o("setLoading",t.payload),e.isLoading=t.payload},setSending:(e,t)=>{o("setSending",t.payload),e.isSending=t.payload},setError:(e,t)=>{o("setError",t.payload),e.error=t.payload},clearError:e=>{o("clearError"),e.error=null},updateStoryDetails:(e,t)=>{let r=t.payload;if(r&&r.id)if(e.storyContexts[r.id]){let t=e.storyContexts[r.id].messages||[];e.storyContexts[r.id]={...e.storyContexts[r.id],...r,messages:t}}else{let t=r.lastMessage;e.storyContexts[r.id]={...r,lastMessage:t,messages:[]}}},setCurrentStoryContextFromDetails:(e,t)=>{o("setCurrentStoryContextFromDetails",t.payload);let r=t.payload;r&&r.id&&(e.currentStoryContext={...r,lastMessage:r.lastMessage,messages:[]},e.curMessages=[])},initTempStoryContext:(e,t)=>{o("initTempStoryContext",t.payload);let{character:r}=t.payload;if(e.tempContext&&e.tempContext.characterId===r.id)return;let a=new Date().toISOString(),n=[];r.greetings&&r.greetings.length>0&&n.push({id:"greeting-".concat(Date.now()),role:s.hE.ASSISTANT,content:r.greetings[0],contentType:s._8.TEXT,createdAt:a,storyId:"temp",index:0,metadata:{}}),e.tempContext={id:"temp",title:"与".concat(r.name,"的临时对话"),characterId:r.id,characterName:r.name,avatarUrl:r.avatarUrl,userId:"temp-user",messages:n,messageCount:n.length,createdAt:a,updatedAt:a},e.storyContexts.temp&&delete e.storyContexts.temp},updateTempGreeting:(e,t)=>{o("updateTempGreeting",t.payload),e.tempContext&&e.tempContext.messages&&e.tempContext.messages.length>0&&(e.tempContext.messages[0].content=t.payload.newGreeting)},updateTempContextTitle:(e,t)=>{o("updateTempContextTitle",t.payload),e.tempContext&&(e.tempContext.title=t.payload.title)}}}),{setMessages:l,addMessage:c,clearMessages:i,setCurrentStoryContext:d,setStories:m,addStory:u,removeStory:y,setLoading:x,setSending:h,setError:g,clearError:p,updateStoryDetails:f,setCurrentStoryContextFromDetails:v,initTempStoryContext:b,updateTempGreeting:j,updateTempContextTitle:S}=n.actions,N=e=>!!e.chat.tempContext,w=n.reducer},9371:(e,t,r)=>{r.d(t,{a:()=>l});var a=r(9249),s=r(6168),o=r(3299);class n{async createShareStory(e){try{return(await s.o.shareStories.createShareStory({createShareStoryRequestDto:e})).data}catch(e){throw console.error("Failed to create share story:",e),e}}async getPublicSharedStories(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{return(await s.o.shareStories.getPublicSharedStories({page:e,limit:t,...r})).data}catch(e){throw console.error("Failed to get public shared stories:",e),e}}async getSharedStoryBySlug(e){try{return(await s.o.shareStories.getSharedStoryBySlug({slug:e})).data}catch(e){throw console.error("Failed to get shared story by slug:",e),e}}async updateSharedStory(e,t){try{return(await s.o.shareStories.updateSharedStory({id:e,updateShareStoryRequestDto:t})).data}catch(e){throw console.error("Failed to update shared story:",e),e}}async deleteSharedStory(e){try{await s.o.shareStories.deleteSharedStory({id:e})}catch(e){throw console.error("Failed to delete shared story:",e),e}}async forkSharedStory(e){try{return(await s.o.shareStories.forkSharedStory({slug:e})).data}catch(e){throw console.error("Failed to fork shared story:",e),e}}}let l=new(n=(0,a.Cg)([o.A.Singleton],n))}}]);