"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[694],{298:(e,t,r)=>{r.d(t,{Di:()=>l,V4:()=>n,ib:()=>o,nT:()=>c});var a=r(8924);let s=e=>e.chat,o=(0,a.Mz)([e=>e.chat.currentStoryContext],e=>(null==e?void 0:e.id)||null);(0,a.Mz)([e=>e.character.currentCharacter],e=>(null==e?void 0:e.id)||null),(0,a.Mz)([s],e=>e.curMessages||[]);let n=(0,a.Mz)([s],e=>Object.values(e.storyContexts).sort((e,t)=>{let r=e.lastMessageAt?new Date(e.lastMessageAt).getTime():0;return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():0)-r}));(0,a.Mz)([s],e=>e.currentStoryContext);let l=e=>e.chat.isLoading,c=e=>e.chat.error;(0,a.Mz)([e=>e.chat,(e,t)=>t],(e,t)=>{if(e.currentStoryContext&&e.currentStoryContext.id===t)return e.currentStoryContext.messages||[];if("temp"===t){var r;return(null==(r=e.tempContext)?void 0:r.messages)||[]}let a=e.storyContexts[t];return a?a.messages:[]}),(0,a.Mz)([s,(e,t)=>t],(e,t)=>e.currentStoryContext&&e.currentStoryContext.id===t?e.currentStoryContext:t&&e.storyContexts[t]?e.storyContexts[t]:null),(0,a.Mz)([n],e=>[...e].sort((e,t)=>{let r=e.lastMessageAt?new Date(e.lastMessageAt).getTime():0;return(t.lastMessageAt?new Date(t.lastMessageAt).getTime():0)-r}))},770:(e,t,r)=>{r.d(t,{m:()=>c});var a=r(9249),s=r(6168),o=r(4421),n=r(3299);class l{async sendMessage(e){try{let t={content:e.content,contentType:e.contentType||o.oL.TEXT,index:e.index||0,virtualModelId:e.virtualModelId};return(await s.o.chat.sendMessage({id:e.storyId,sendMessageRequestDto:t})).data}catch(e){throw console.error("Failed to send message:",e),e}}async sendStreamMessage(e,t){try{let r=await s.o.chat.streamResponse({id:e.storyId,message:e.content,virtualModelId:e.virtualModelId});console.warn("Stream handling in sendStreamMessage needs proper implementation based on SDK behavior.",r);let a={messageId:"temp-id-".concat(Date.now()),content:"[Streaming mock chunk]",metadata:{},storyId:e.storyId,isLast:!0};t(a)}catch(e){throw console.error("Failed to send streaming message:",e),e}}async getHistory(e){try{let t={page:e.page||1,limit:e.limit||20,role:e.role,startTime:e.from,endTime:e.to},{data:r}=await s.o.chat.getStoryMessages({id:e.storyId,limit:t.limit,page:t.page});return{messages:r.items||[],totalCount:r.total,currentPage:r.page,totalPages:Math.ceil(r.total/r.limit)}}catch(e){throw console.error("Failed to fetch chat history:",e),e}}async getAllMessages(e){try{let e=1,t=[],r=0,a=1;for(;;){let{data:o}=await s.o.chat.getAllMessages({page:e,limit:100}),n=o.items||[];if(t=t.concat(n),r=o.total,a=Math.ceil(o.total/(o.limit||100)),e>=a)break;e++}return{messages:t,totalCount:r,currentPage:a,totalPages:a}}catch(e){throw console.error("Failed to fetch all messages:",e),e}}async deleteMessage(e,t){try{await s.o.chat.deleteMessage({storyId:e,messageId:t})}catch(r){throw console.error("Failed to delete message ".concat(t," for story ").concat(e,":"),r),r}}async clearHistory(e){try{await s.o.chat.clearStoryMessages({id:e})}catch(t){throw console.error("Failed to clear history for story ".concat(e,":"),t),t}}async createStory(e){try{return(await s.o.chat.createStory({createStoryRequestDto:e})).data}catch(e){throw console.error("Failed to create story:",e),e}}async deleteStory(e){try{await s.o.chat.deleteStory({id:e})}catch(t){throw console.error("Failed to delete story ".concat(e,":"),t),t}}async exportStoryHistory(e,t){try{await s.o.chat.exportStoryHistory({id:e})}catch(t){throw console.error("Failed to export history for story ".concat(e,":"),t),t}}async getContextTips(e){try{await s.o.chat.getContextTips({id:e.storyId})}catch(t){throw console.error("Failed to get context tips for story ".concat(e.storyId,":"),t),t}}async getStory(e){try{return(await s.o.chat.getStory({id:e})).data}catch(t){throw console.error("Failed to get story ".concat(e,":"),t),t}}async updateStory(e,t){try{return(await s.o.chat.updateStory({id:e,updateStoryRequestDto:{title:t}})).data}catch(t){throw console.error("Failed to update story ".concat(e,":"),t),t}}async getUserStories(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;try{return(await s.o.chat.getUserStories({page:t,limit:r})).data}catch(t){throw console.error("Failed to get user stories for user ".concat(e,":"),t),t}}async regenerateResponse(e,t,r){try{return(await s.o.chat.regenerateResponse({storyId:e,messageId:t},{params:{virtualModelId:r}})).data}catch(r){throw console.error("Failed to regenerate response for message ".concat(t," in story ").concat(e,":"),r),r}}async stopGeneration(e){try{await s.o.chat.stopGeneration({id:e})}catch(t){throw console.error("Failed to stop generation for story ".concat(e,":"),t),t}}async updateMessage(e,t,r,a,o){try{return(await s.o.chat.updateMessage({storyId:e,messageId:t,updateMessageRequestDto:{content:r,contentType:a,metadata:o}})).data}catch(r){throw console.error("Failed to update message ".concat(t," for story ").concat(e,":"),r),r}}}let c=new(l=(0,a.Cg)([n.A.Singleton],l))},3500:(e,t,r)=>{r.d(t,{R7:()=>l});var a=r(2115),s=r(2045),o=r(298),n=r(8781);r(8578);let l=()=>{let e=(0,s.j)(),t=(0,s.G)(o.V4),r=(0,s.G)(o.Di),l=(0,s.G)(o.nT),c=(0,s.G)(e=>e.chat.storyContexts),i=(0,s.G)(o.ib),d=(0,a.useCallback)(()=>{console.log("Dispatching fetchAllStoryAsync"),e((0,n.bn)({}))},[e]),u=(0,a.useCallback)(()=>{console.log("Forcing refresh of stories"),e((0,n.bn)({}))},[e]),m=(0,a.useCallback)(e=>e&&c[e]||null,[c]),h=(0,a.useCallback)(async t=>{if(!t)return console.error("Cannot fetch story details without storyId"),null;let r=c[t];if(r)return r;let a=await e((0,n.yn)(t));return n.yn.fulfilled.match(a)&&a.payload?c[t]||a.payload:null},[e,c]),y=(0,a.useCallback)(async t=>{if(!t)return console.error("Cannot fetch story to current context without storyId"),null;let r=await e((0,n.PS)(t));return n.PS.fulfilled.match(r)&&r.payload?r.payload:null},[e]),g=(0,a.useCallback)(async t=>{let r=await e((0,n.oA)(t));return n.oA.fulfilled.match(r)?r.payload:null},[e]),x=(0,a.useCallback)(t=>{e((0,n.d)(t))},[e]);return{stories:t,isLoading:r,error:l,currentStoryId:i,fetchStories:d,fetchStoryDetails:h,fetchStoryToCurStoryContext:y,getStoryById:m,refreshStories:u,createStory:g,deleteStory:x,updateStoryTitle:(0,a.useCallback)(async(t,r)=>{let a=await e((0,n.RF)({storyId:t,title:r}));return n.RF.fulfilled.match(a)?a.payload:null},[e]),forkSharedStory:(0,a.useCallback)(async t=>{let r=await e((0,n.dF)(t));return n.dF.fulfilled.match(r)?r.payload:null},[e])}}},6525:(e,t,r)=>{r.d(t,{rN:()=>n,st:()=>l,z7:()=>o});var a=r(8924);let s=e=>e.app.model,o=e=>s(e).uiModels,n=e=>s(e).selectedModel,l=e=>s(e).status;(0,a.Mz)([o,(e,t)=>t],(e,t)=>e.find(e=>e.id===t)||null)},6562:(e,t,r)=>{r.d(t,{u:()=>n});var a=r(2115),s=r(5695),o=r(7374);let n=e=>{let t=(0,s.useSearchParams)(),[r,n]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{r||("required"===t.get("auth")&&(o.oR.error("请先登录后访问该页面"),e&&setTimeout(()=>{e()},500)),n(!0))},[t,r,e]),{authChecked:r}}},7694:(e,t,r)=>{r.d(t,{default:()=>V});var a=r(5155),s=r(6874),o=r.n(s),n=r(285),l=r(2115),c=r(4540),i=r(5452),d=r(5318),u=r(9434);let m=i.bL;i.l9;let h=i.ZL;i.bm;let y=l.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(i.hJ,{ref:t,className:(0,u.cn)("fixed inset-0 z-50 bg-background backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...s})});y.displayName=i.hJ.displayName;let g=l.forwardRef((e,t)=>{let{className:r,children:s,...o}=e;return(0,a.jsxs)(h,{children:[(0,a.jsx)(y,{}),(0,a.jsxs)(i.UC,{ref:t,className:(0,u.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border bg-card p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",r),...o,children:[s,(0,a.jsxs)(i.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,a.jsx)(d.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});g.displayName=i.UC.displayName;let x=e=>{let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,u.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...r})};x.displayName="DialogHeader";let p=l.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(i.hE,{ref:t,className:(0,u.cn)("text-lg font-semibold leading-none tracking-tight text-foreground",r),...s})});p.displayName=i.hE.displayName,l.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(i.VY,{ref:t,className:(0,u.cn)("text-sm text-muted-foreground",r),...s})}).displayName=i.VY.displayName;var f=r(704);let v=f.bL,b=l.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(f.B8,{ref:t,className:(0,u.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",r),...s})});b.displayName=f.B8.displayName;let w=l.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(f.l9,{ref:t,className:(0,u.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",r),...s})});w.displayName=f.l9.displayName;let S=l.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(f.UC,{ref:t,className:(0,u.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",r),...s})});S.displayName=f.UC.displayName;var N=r(6766),j=r(8613),C=r(2732),M=r(3096);function I(e){let{isOpen:t,onClose:r,initialTab:s="login"}=e;(0,c.wA)();let{isLoading:o,error:i}=(0,c.d4)(e=>e.user),{login:d,register:u,clearErrors:h}=(0,j.As)(),[y,f]=(0,l.useState)(s),[I,k]=(0,l.useState)("add@1232163.com"),[D,F]=(0,l.useState)("12345678aA"),[T,E]=(0,l.useState)("add"),[A,z]=(0,l.useState)(t),[R,L]=(0,l.useState)(!1),[U,$]=(0,l.useState)(!1),[P,G]=(0,l.useState)(""),[H,q]=(0,l.useState)(!1),[O,_]=(0,l.useState)(!1);(0,l.useEffect)(()=>{let e=localStorage.getItem("referralCode");console.log("LoginModal checking localStorage for referral code:",e),e?(G(e),q(!0)):P||q(!1)},[t,P]),(0,l.useEffect)(()=>{let e=e=>{let t=e.detail;t&&t.tab&&f(t.tab),z(!0)};return document.addEventListener("open-login-modal",e),()=>{document.removeEventListener("open-login-modal",e)}},[]),(0,l.useEffect)(()=>{f(s)},[s]),(0,l.useEffect)(()=>{z(t)},[t]);let B=()=>{z(!1),h(),r()},V=async e=>{e.preventDefault();try{await d({email:I,password:D})&&B()}catch(e){console.error("Login failed:",e)}},J=async e=>{if(e.preventDefault(),O)try{await u({email:I,password:D,nickname:T||void 0,invitationCode:P||void 0})&&B()}catch(e){console.error("Registration failed:",e)}};return(0,l.useEffect)(()=>{},[y]),(0,a.jsx)(m,{open:A,onOpenChange:B,children:(0,a.jsxs)(g,{className:"sm:max-w-md bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]",children:[(0,a.jsx)(x,{children:(0,a.jsx)(p,{className:"text-center text-xl font-normal",children:"login"===y?"登录":"注册"})}),(0,a.jsxs)(v,{defaultValue:s,value:y,onValueChange:f,className:"w-full",children:[(0,a.jsxs)(b,{className:"grid w-full grid-cols-2 bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(w,{value:"login",className:"data-[state=active]:bg-[var(--bg-secondary)] data-[state=active]:text-[var(--text-primary)]",children:"登录"}),(0,a.jsx)(w,{value:"register",className:"data-[state=active]:bg-[var(--bg-secondary)] data-[state=active]:text-[var(--text-primary)]",children:"注册"})]}),(0,a.jsxs)(S,{value:"login",className:"mt-4",children:[(0,a.jsxs)("form",{onSubmit:V,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邮箱"}),(0,a.jsx)("input",{type:"email",placeholder:"邮箱地址",value:I,onChange:e=>k(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"密码"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{type:R?"text":"password",placeholder:"密码",value:D,onChange:e=>F(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus pr-10"}),(0,a.jsx)("button",{type:"button",onClick:()=>L(!R),className:"absolute inset-y-0 right-0 px-3 flex items-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:R?(0,a.jsx)(M.N5q,{}):(0,a.jsx)(M.V$C,{})})]})]}),i&&(0,a.jsx)("div",{className:"text-[var(--error-text)] text-sm",children:i}),(0,a.jsx)(n.$,{type:"submit",variant:"outline",className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:o,children:o?"登录中...":"登录"})]}),(0,a.jsxs)("div",{className:"relative flex items-center py-4",children:[(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"}),(0,a.jsx)("span",{className:"flex-shrink mx-4 text-[var(--text-secondary)] text-sm",children:"或"}),(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"})]}),(0,a.jsxs)(n.$,{variant:"outline",className:"w-full flex items-center justify-center gap-2 bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(N.default,{src:"https://ext.same-assets.com/1551878970/904099674.svg+xml",alt:"Discord",width:20,height:20}),(0,a.jsx)("span",{children:"使用 Discord 登录"})]})]}),(0,a.jsxs)(S,{value:"register",className:"mt-4",children:[(0,a.jsxs)("form",{onSubmit:J,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"昵称（可选）"}),(0,a.jsx)("input",{type:"text",placeholder:"昵称",value:T,onChange:e=>{E(e.target.value)},className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邮箱"}),(0,a.jsx)("input",{type:"email",placeholder:"邮箱地址",value:I,onChange:e=>k(e.target.value),required:!0,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"密码"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{type:R?"text":"password",placeholder:"请输入密码",value:D,onChange:e=>{F(e.target.value)},className:"w-full p-2 border border-gray-300 rounded bg-[var(--bg-tertiary)] text-[var(--text-primary)] input-focus pr-10"}),(0,a.jsx)("button",{type:"button",onClick:()=>L(!R),className:"absolute inset-y-0 right-0 px-3 flex items-center text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:R?(0,a.jsx)(M.N5q,{}):(0,a.jsx)(M.V$C,{})})]}),"register"===y&&(0,a.jsx)(C.g,{password:D,onValidationChange:_})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm text-[var(--text-secondary)] block",children:"邀请码 (可选)"}),(0,a.jsx)("input",{type:"text",placeholder:"输入邀请码",value:P,onChange:e=>G(e.target.value),readOnly:H,className:"w-full p-2 bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md text-[var(--text-primary)] focus:outline-none input-focus ".concat(H?"cursor-not-allowed opacity-70":"")}),H&&(0,a.jsx)("p",{className:"text-xs text-[var(--text-secondary)] mt-1",children:"已使用推荐链接中的邀请码。"})]}),i&&(0,a.jsx)("div",{className:"text-[var(--error-text)] text-sm",children:i}),(0,a.jsx)(n.$,{type:"submit",variant:"outline",className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:o,children:o?"注册中...":"注册"})]}),(0,a.jsxs)("div",{className:"relative flex items-center py-4",children:[(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"}),(0,a.jsx)("span",{className:"flex-shrink mx-4 text-[var(--text-secondary)] text-sm",children:"或"}),(0,a.jsx)("div",{className:"flex-grow border-t border-[var(--border-color)]"})]}),(0,a.jsxs)(n.$,{variant:"outline",className:"w-full flex items-center justify-center gap-2 bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(N.default,{src:"https://ext.same-assets.com/1551878970/904099674.svg+xml",alt:"Discord",width:20,height:20}),(0,a.jsx)("span",{children:"使用 Discord 注册"})]})]})]}),(0,a.jsxs)("div",{className:"text-center text-sm text-[var(--text-secondary)] mt-4",children:[(0,a.jsx)("p",{children:"Quack是免费使用"}),(0,a.jsx)("p",{children:"加入Discord社群可以获得更多福利"})]})]})})}var k=r(7230),D=r(3158),F=r(518),T=r(154);let E=k.bL,A=k.l9;k.YJ,k.ZL,k.Pb,k.z6,l.forwardRef((e,t)=>{let{className:r,inset:s,children:o,...n}=e;return(0,a.jsxs)(k.ZP,{ref:t,className:(0,u.cn)("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",s&&"pl-8",r),...n,children:[o,(0,a.jsx)(D.A,{className:"ml-auto"})]})}).displayName=k.ZP.displayName,l.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(k.G5,{ref:t,className:(0,u.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...s})}).displayName=k.G5.displayName;let z=l.forwardRef((e,t)=>{let{className:r,sideOffset:s=4,...o}=e;return(0,a.jsx)(k.ZL,{children:(0,a.jsx)(k.UC,{ref:t,sideOffset:s,className:(0,u.cn)("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...o})})});z.displayName=k.UC.displayName;let R=l.forwardRef((e,t)=>{let{className:r,inset:s,...o}=e;return(0,a.jsx)(k.q7,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",s&&"pl-8",r),...o})});R.displayName=k.q7.displayName,l.forwardRef((e,t)=>{let{className:r,children:s,checked:o,...n}=e;return(0,a.jsxs)(k.H_,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),checked:o,...n,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(k.VF,{children:(0,a.jsx)(F.A,{className:"h-4 w-4"})})}),s]})}).displayName=k.H_.displayName,l.forwardRef((e,t)=>{let{className:r,children:s,...o}=e;return(0,a.jsxs)(k.hN,{ref:t,className:(0,u.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),...o,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(k.VF,{children:(0,a.jsx)(T.A,{className:"h-2 w-2 fill-current"})})}),s]})}).displayName=k.hN.displayName,l.forwardRef((e,t)=>{let{className:r,inset:s,...o}=e;return(0,a.jsx)(k.JU,{ref:t,className:(0,u.cn)("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",r),...o})}).displayName=k.JU.displayName,l.forwardRef((e,t)=>{let{className:r,...s}=e;return(0,a.jsx)(k.wv,{ref:t,className:(0,u.cn)("-mx-1 my-1 h-px bg-muted",r),...s})}).displayName=k.wv.displayName;var L=r(6562),U=r(1394),$=r(5695),P=r(3500),G=r(2847),H=r(7374),q=r(7280);function O(e){let{className:t="",showLabel:r=!0}=e,{themeSetting:s,updateSettings:o}=(0,j.Qg)(),{setTheme:n}=(0,q.D)(),c=(0,l.useMemo)(()=>[{value:"dark",label:"深色",icon:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"})})},{value:"light",label:"浅色",icon:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"})})},{value:"pink",label:"少女粉",icon:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})})}],[]),i=(0,l.useCallback)(()=>{let e=(c.findIndex(e=>e.value===s)+1)%c.length;return c[e]},[s,c]),d=(0,l.useCallback)(()=>{let e=i();console.log("[ThemeSwitch] 切换到主题:",e.value),n(e.value),o({theme:e.value}).then(t=>{t?(H.oR.success("已切换到".concat(e.label,"主题")),console.log("[ThemeSwitch] 主题设置保存成功:",e.value)):(n(s),H.oR.error("主题切换失败"),console.error("[ThemeSwitch] 主题设置保存失败"))}).catch(e=>{n(s),H.oR.error("主题切换失败"),console.error("[ThemeSwitch] 主题设置保存错误:",e)})},[o,s,n,i]),u=c.find(e=>e.value===s)||c[0];return(0,a.jsxs)("button",{onClick:d,className:"flex items-center space-x-2 p-2 rounded-md transition-colors hover:bg-[var(--bg-tertiary)] ".concat(t),title:"当前: ".concat(u.label,"，点击切换主题"),children:[u.icon,r&&(0,a.jsx)("span",{className:"text-sm",children:u.label})]})}function _(){var e;(0,c.wA)();let t=(0,c.d4)(e=>e.user.currentUser),r=(0,c.d4)(e=>e.user.isAuthenticated),{fetchUserProfile:s,logoutUser:i}=(0,j.As)(),d=(0,$.useRouter)(),u=(0,$.usePathname)(),{stories:m,fetchStories:h}=(0,P.R7)(),{characters:y}=(0,G.Ib)(),[g,x]=(0,l.useState)(!1),[p,f]=(0,l.useState)(!1),[v,b]=(0,l.useState)("login"),[w,S]=(0,l.useState)(""),N=(0,l.useRef)(!0),[C,k]=(0,l.useState)(!1),D=(0,$.useSearchParams)(),F="/characters"!==u&&"/characters/"!==u&&"/"!==u,T=e=>{b(e),f(!0)};(0,L.u)(T.bind(null,"login")),(0,l.useEffect)(()=>{"/"===window.location.pathname&&d.push("/characters")},[d]),(0,l.useEffect)(()=>{k(!0);let e=D.get("ref");e&&localStorage.setItem("referralCode",e)},[D]),(0,l.useEffect)(()=>{N.current&&r&&(N.current=!1,s())},[s,r]),(0,l.useEffect)(()=>{let e=e=>{let t=e.detail;t&&t.tab&&b(t.tab),f(!0)};return document.addEventListener("open-login-modal",e),()=>{document.removeEventListener("open-login-modal",e)}},[]),(0,l.useEffect)(()=>{r&&h()},[r,h]);let H=e=>{if(e.preventDefault(),m&&m.length>0){let e=Math.floor(Math.random()*m.length),t=m[e];d.push("/chat?storyId=".concat(t.id))}else if(y&&y.length>0){let e=Math.floor(Math.random()*y.length),t=y[e];d.push("/chat?characterId=".concat(t.id))}},q=()=>{w.trim()&&d.push("/characters?search=".concat(encodeURIComponent(w.trim())))},_=e=>{"Enter"===e.key&&q()};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"container mx-auto flex items-center justify-between px-4 py-2",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 md:space-x-6",children:[(0,a.jsxs)(E,{children:[(0,a.jsx)(A,{asChild:!0,children:(0,a.jsx)(n.$,{variant:"ghost",size:"sm",className:"text-[var(--text-primary)] hover:text-[var(--accent-color)] p-1 md:hidden",children:(0,a.jsx)(M.sKQ,{className:"h-5 w-5"})})}),(0,a.jsxs)(z,{align:"start",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]",children:[(0,a.jsx)(o(),{href:"/characters",className:"cursor-pointer hover:bg-[var(--bg-tertiary)]",children:(0,a.jsxs)(R,{children:[(0,a.jsx)(M.nXn,{className:"h-4 w-4 mr-2"}),"角色"]})}),(0,a.jsx)(o(),{href:"/discovery",className:"cursor-pointer hover:bg-[var(--bg-tertiary)]",children:(0,a.jsxs)(R,{children:[(0,a.jsx)(M.$p$,{className:"h-4 w-4 mr-2"}),"探索"]})}),(0,a.jsxs)(R,{className:"cursor-pointer hover:bg-[var(--bg-tertiary)]",onSelect:()=>H({}),children:[(0,a.jsx)(M.ywh,{className:"h-4 w-4 mr-2"}),"消息"]}),(0,a.jsxs)(R,{className:"cursor-pointer hover:bg-[var(--bg-tertiary)]",children:[(0,a.jsx)(M.tiF,{className:"h-4 w-4 mr-2"}),"帮助"]})]})]}),F&&(0,a.jsx)(n.$,{variant:"ghost",size:"sm",className:"bg-[var(--bg-primary)]/90 backdrop-blur-md border border-[var(--border-color)] text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] md:hidden",onClick:()=>{d.push("/characters")},"aria-label":"返回发现页面",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 19l-7-7 7-7"})})}),(0,a.jsx)(o(),{href:"/characters",className:"flex items-center",children:(0,a.jsx)("h1",{className:"text-2xl font-bold text-[var(--accent-color)] mr-4",children:"G"})}),(0,a.jsxs)("nav",{className:"hidden md:flex space-x-4",children:[(0,a.jsx)(o(),{href:"/characters",className:"text-[var(--text-primary)] hover:text-[var(--accent-color)] pb-1 border-b-2 transition-colors ".concat("/characters"===u||"/characters/"===u?"text-[var(--accent-color)] border-[var(--accent-color)]":"border-transparent"),children:"角色"}),(0,a.jsx)(o(),{href:"/chat",className:"text-[var(--text-primary)] hover:text-[var(--accent-color)] pb-1 border-b-2 transition-colors ".concat(u.startsWith("/chat")?"text-[var(--accent-color)] border-[var(--accent-color)]":"border-transparent"),onClick:H,children:"消息"}),(0,a.jsx)(o(),{href:"/help",className:"text-[var(--text-primary)] hover:text-[var(--accent-color)] pb-1 border-b-2 transition-colors ".concat("/help"===u?"text-[var(--accent-color)] border-[var(--accent-color)]":"border-transparent"),children:"帮助"})]})]}),(0,a.jsx)("div",{className:"flex items-center space-x-2 md:space-x-4",children:C?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"hidden md:flex items-center space-x-2",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--text-secondary)]",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,a.jsx)("input",{type:"text",placeholder:"搜索角色",value:w,onChange:e=>S(e.target.value),onKeyPress:_,className:"bg-[var(--bg-secondary)] border border-[var(--border-color)] text-[var(--text-primary)] placeholder-[var(--text-secondary)] pl-10 pr-4 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)] w-40 lg:w-48"})]})}),(0,a.jsxs)("div",{className:"md:hidden relative",children:[(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--text-secondary)]",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,a.jsx)("input",{type:"text",placeholder:"搜索角色",value:w,onChange:e=>S(e.target.value),onKeyPress:_,className:"bg-[var(--bg-secondary)] border border-[var(--border-color)] text-[var(--text-primary)] placeholder-[var(--text-secondary)] pl-10 pr-4 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)] w-32"})]}),r?(0,a.jsxs)(E,{children:[(0,a.jsx)(A,{asChild:!0,children:(0,a.jsx)(n.$,{variant:"ghost",className:"relative h-8 w-8 rounded-full bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-[var(--bg-secondary)]",children:(0,a.jsxs)(U.eu,{className:"h-8 w-8",children:[(null==t?void 0:t.avatarUrl)?(0,a.jsx)(U.BK,{src:t.avatarUrl,alt:t.nickname||"User"}):null,(0,a.jsx)(U.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==t||null==(e=t.nickname)?void 0:e.charAt(0).toUpperCase())||"U"})]})})}),(0,a.jsxs)(z,{align:"end",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] text-[var(--text-primary)]",children:[(0,a.jsx)("div",{className:"flex items-center justify-start p-2 border-b border-[var(--border-color)]",children:(0,a.jsxs)("div",{className:"flex flex-col space-y-1 leading-none",children:[(0,a.jsx)("p",{className:"font-medium",children:null==t?void 0:t.nickname}),(0,a.jsx)("p",{className:"truncate text-sm text-[var(--text-secondary)]",children:null==t?void 0:t.email})]})}),(0,a.jsx)("div",{className:"p-1 border-b border-[var(--border-color)]",children:(0,a.jsx)(O,{className:"w-full justify-start"})}),(0,a.jsx)(o(),{href:"/profile",className:"cursor-pointer hover:bg-[var(--bg-tertiary)]",children:(0,a.jsx)(R,{children:"个人设置"})}),(0,a.jsx)(R,{className:"cursor-pointer text-red-500 hover:bg-[var(--bg-tertiary)] hover:text-red-500",onSelect:()=>{i()},children:"退出登录"})]})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.$,{variant:"ghost",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)] text-sm p-0 h-auto hidden md:block",onClick:()=>T("register"),children:"注册"}),(0,a.jsx)(n.$,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors text-sm px-3 py-1",onClick:()=>T("login"),children:"登录"})]})]}):(0,a.jsxs)("div",{className:"flex items-center space-x-4 animate-pulse",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-20"}),(0,a.jsx)("div",{className:"h-8 w-24 bg-[var(--bg-tertiary)] rounded"}),(0,a.jsx)("div",{className:"h-8 w-8 bg-[var(--bg-tertiary)] rounded-full"})]})})]}),p&&(0,a.jsx)(I,{isOpen:p,onClose:()=>f(!1),initialTab:v})]})}function B(){return(0,a.jsxs)("div",{className:"container mx-auto flex items-center justify-between px-4 py-2",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-6",children:[(0,a.jsx)("div",{className:"w-[120px] h-[30px] bg-[var(--bg-tertiary)] rounded animate-pulse"}),(0,a.jsxs)("div",{className:"hidden md:flex space-x-4",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-10 animate-pulse"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-12 animate-pulse"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-10 animate-pulse"}),(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-10 animate-pulse"})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)("div",{className:"h-4 bg-[var(--bg-tertiary)] rounded w-20 animate-pulse"}),(0,a.jsx)("div",{className:"h-8 w-24 bg-[var(--bg-tertiary)] rounded animate-pulse"}),(0,a.jsx)("div",{className:"h-8 w-8 bg-[var(--bg-tertiary)] rounded-full animate-pulse"})]})]})}function V(){return(0,a.jsx)("header",{className:"fixed top-0 left-0 right-0 z-50 bg-[var(--bg-primary)] border-b border-[var(--border-color)]",children:(0,a.jsx)(l.Suspense,{fallback:(0,a.jsx)(B,{}),children:(0,a.jsx)(_,{})})})}},8578:(e,t,r)=>{r.d(t,{$c:()=>g,Ay:()=>M,FB:()=>l,G0:()=>j,Hw:()=>N,LD:()=>m,Nh:()=>x,Ob:()=>h,SU:()=>d,Uw:()=>v,f5:()=>f,iY:()=>u,oI:()=>i,r1:()=>y,tj:()=>c,xb:()=>C});var a=r(6439),s=r(4421);let o=(e,t)=>{},n=(0,a.Z0)({name:"chat",initialState:{storyContexts:{},currentStoryContext:null,curMessages:[],isLoading:!1,isSending:!1,error:null,tempContext:null,isRegeneratingMessageId:null,isDeletingMessageId:null},reducers:{setMessages:(e,t)=>{o("setMessages",t.payload);let{storyId:r,messages:a}=t.payload;e.storyContexts[r]&&(e.storyContexts[r].messages=a),e.currentStoryContext&&e.currentStoryContext.id===r&&(e.curMessages=a)},addMessage:(e,t)=>{o("addMessage",t.payload);let r=t.payload,a=r.storyId;if(e.currentStoryContext&&e.currentStoryContext.id===a){let t=e.curMessages.findIndex(e=>e.id===r.id);-1!==t?e.curMessages[t]=r:e.curMessages.push(r)}},clearMessages:(e,t)=>{o("clearMessages",t.payload);let r=t.payload;e.storyContexts[r]&&(e.storyContexts[r].messages=[],e.storyContexts[r].lastMessage=void 0,e.storyContexts[r].lastMessageAt=void 0)},setCurrentStoryContext:(e,t)=>{o("setCurrentStoryContext",t.payload);let r=t.payload;if(e.currentStoryContext=r,r){var a;e.curMessages=(null==(a=e.storyContexts[r.id])?void 0:a.messages)||[]}else e.curMessages=[]},setStories:(e,t)=>{o("setStories",t.payload);let r={};t.payload.forEach(t=>{var a;let s=(null==(a=e.storyContexts[t.id])?void 0:a.messages)||[];r[t.id]={...t,messages:s}}),e.storyContexts=r},addStory:(e,t)=>{o("addStory",t.payload);let r=t.payload;r.messages||(r.messages=[]),e.storyContexts[r.id]={...e.storyContexts[r.id]||{},...r};let a={...e.storyContexts};delete a[r.id],e.storyContexts={[r.id]:e.storyContexts[r.id],...a}},removeStory:(e,t)=>{o("removeStory",t.payload);let r=t.payload;if(e.storyContexts[r]){var a;delete e.storyContexts[r],(null==(a=e.currentStoryContext)?void 0:a.id)===r&&(e.currentStoryContext=null)}},setLoading:(e,t)=>{o("setLoading",t.payload),e.isLoading=t.payload},setSending:(e,t)=>{o("setSending",t.payload),e.isSending=t.payload},setError:(e,t)=>{o("setError",t.payload),e.error=t.payload},clearError:e=>{o("clearError"),e.error=null},updateStoryDetails:(e,t)=>{let r=t.payload;if(r&&r.id)if(e.storyContexts[r.id]){let t=e.storyContexts[r.id].messages||[];e.storyContexts[r.id]={...e.storyContexts[r.id],...r,messages:t}}else{let t=r.lastMessage;e.storyContexts[r.id]={...r,lastMessage:t,messages:[]}}},setCurrentStoryContextFromDetails:(e,t)=>{o("setCurrentStoryContextFromDetails",t.payload);let r=t.payload;r&&r.id&&(e.currentStoryContext={...r,lastMessage:r.lastMessage,messages:[]},e.curMessages=[])},initTempStoryContext:(e,t)=>{o("initTempStoryContext",t.payload);let{character:r}=t.payload;if(e.tempContext&&e.tempContext.characterId===r.id)return;let a=new Date().toISOString(),n=[];r.greetings&&r.greetings.length>0&&n.push({id:"greeting-".concat(Date.now()),role:s.hE.ASSISTANT,content:r.greetings[0],contentType:s._8.TEXT,createdAt:a,storyId:"temp",index:0,metadata:{}}),e.tempContext={id:"temp",title:"与".concat(r.name,"的临时对话"),characterId:r.id,characterName:r.name,avatarUrl:r.avatarUrl,userId:"temp-user",messages:n,messageCount:n.length,createdAt:a,updatedAt:a},e.storyContexts.temp&&delete e.storyContexts.temp},updateTempGreeting:(e,t)=>{o("updateTempGreeting",t.payload),e.tempContext&&e.tempContext.messages&&e.tempContext.messages.length>0&&(e.tempContext.messages[0].content=t.payload.newGreeting)},updateTempContextTitle:(e,t)=>{o("updateTempContextTitle",t.payload),e.tempContext&&(e.tempContext.title=t.payload.title)},setCurMessagesList:(e,t)=>{o("setCurMessagesList",t.payload),e.curMessages=t.payload},setRegeneratingMessageId:(e,t)=>{e.isRegeneratingMessageId=t.payload},setDeletingMessageId:(e,t)=>{e.isDeletingMessageId=t.payload}}}),{setMessages:l,addMessage:c,clearMessages:i,setCurrentStoryContext:d,setStories:u,addStory:m,removeStory:h,setLoading:y,setSending:g,setError:x,clearError:p,updateStoryDetails:f,setCurrentStoryContextFromDetails:v,initTempStoryContext:b,updateTempGreeting:w,updateTempContextTitle:S,setCurMessagesList:N,setRegeneratingMessageId:j,setDeletingMessageId:C}=n.actions,M=n.reducer},8781:(e,t,r)=>{r.d(t,{PS:()=>h,RF:()=>y,bn:()=>i,d:()=>u,dF:()=>g,oA:()=>d,yn:()=>m});var a=r(6439),s=r(8578),o=r(770),n=r(4421),l=r(9371),c=r(6525);(0,a.zD)("chat/addMessageLocal",async(e,t)=>{let{dispatch:r,getState:a}=t,o=a().chat.curMessages,l=o.length>0?Math.max(...o.map(e=>{var t;return null!=(t=e.index)?t:0}))+1:0,c={id:"user-".concat(Date.now()),role:n.hE.USER,content:e.content,contentType:e.contentType||n._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:l,metadata:e.parentMessageId?{parentMessageId:e.parentMessageId}:{}};return r((0,s.tj)(c)),c}),(0,a.zD)("chat/sendMessage",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.$c)(!0));let t=a(),n=(0,c.rN)(t),l=null==n?void 0:n.id,i=await o.m.sendMessage({...e,virtualModelId:l});r((0,s.tj)(i))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to send message:",t)}finally{r((0,s.$c)(!1))}}),(0,a.zD)("chat/sendStreamMessage",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.$c)(!0));let t=a(),l=[],i=(0,c.rN)(t),d=null==i?void 0:i.id,u=t.chat.currentStoryContext;u&&u.id===e.storyId?l=u.messages||[]:console.warn("Current story context id (".concat(null==u?void 0:u.id,") does not match the provided storyId (").concat(e.storyId,")"));let m=l.length>0?Math.max(...l.map(e=>{var t;return null!=(t=e.index)?t:0}))+1:0,h={id:"user-".concat(Date.now()),role:n.hE.USER,content:e.content,contentType:e.contentType||n._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:m,metadata:e.parentMessageId?{parentMessageId:e.parentMessageId}:{}};r((0,s.tj)(h));let y="char-".concat(Date.now()),g="",x="",p={id:y,role:n.hE.ASSISTANT,content:"",contentType:n._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:m+1,metadata:{parentMessageId:h.id}};r((0,s.tj)(p)),await o.m.sendStreamMessage({...e,parentMessageId:h.id,index:m,virtualModelId:d},t=>{g+=t.content,t.messageId&&t.messageId!==y&&(x=t.messageId),r((0,s.tj)({id:x||y,role:n.hE.ASSISTANT,content:g,contentType:n._8.TEXT,createdAt:new Date().toISOString(),storyId:e.storyId,index:m+1,metadata:{parentMessageId:h.id}})),t.isLast&&console.log("Stream message completed")})}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to send stream message:",t)}finally{r((0,s.$c)(!1))}}),(0,a.zD)("chat/fetchStoryHistory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{if(!e.storyId||!e.characterId)return void console.error("Cannot fetch history: missing storyId or characterId");console.log("Fetching chat history for story ".concat(e.storyId)),r((0,s.r1)(!0));let{page:t,limit:a}=e;try{let n=await o.m.getHistory({storyId:e.storyId,characterId:e.characterId,page:t,limit:a});if(n&&n.messages){let t=n.messages.map(t=>({...t,storyId:e.storyId}));r((0,s.FB)({storyId:e.storyId,messages:t}))}}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("API error when fetching story history:",t)}}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to fetch story history:",t)}finally{r((0,s.r1)(!1))}});let i=(0,a.zD)("chat/fetchAllStory",async(e,t)=>{let{page:r=1,limit:a=20}=e,{dispatch:n,getState:l}=t;try{console.log("Fetching all stories"),n((0,s.r1)(!0));try{var c;let e=(null==(c=l().user.currentUser)?void 0:c.id)||"",t=await o.m.getUserStories(e,r,a);if(t&&t.items){let e=t.items.map(e=>({...e,messages:[]}));n((0,s.iY)(e))}}catch(t){let e=t instanceof Error?t.message:String(t);n((0,s.Nh)(e)),console.error("API error when fetching stories:",t)}}catch(t){let e=t instanceof Error?t.message:String(t);n((0,s.Nh)(e)),console.error("Failed to fetch stories:",t)}finally{n((0,s.r1)(!1))}});(0,a.zD)("chat/deleteMessage",async(e,t)=>{let{messageId:r,storyId:a}=e,{dispatch:n,getState:l}=t;try{n((0,s.xb)(r)),await o.m.deleteMessage(a,r);let{curMessages:e}=l().chat,t=e.filter(e=>e.id!==r);n((0,s.Hw)(t))}catch(t){let e=t instanceof Error?t.message:String(t);n((0,s.Nh)(e)),console.error("Failed to delete message:",t)}finally{n((0,s.xb)(null))}}),(0,a.zD)("chat/clearStoryHistory",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0)),await o.m.clearHistory(e),r((0,s.oI)(e))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to clear chat history:",t)}finally{r((0,s.r1)(!1))}});let d=(0,a.zD)("chat/createStory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.r1)(!0));let t={...await o.m.createStory(e),messages:[]};return r((0,s.LD)(t)),r((0,s.SU)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to create chat story:",t),null}finally{r((0,s.r1)(!1))}}),u=(0,a.zD)("chat/deleteStory",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.r1)(!0));let{chat:t}=a();if(t.storyContexts[e]){try{await o.m.deleteStory(e)}catch(t){console.warn("Failed to delete story ".concat(e," via ChatService:"),t)}r((0,s.Ob)(e))}else console.warn("Story with ID ".concat(e," not found for deletion."))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,s.Nh)(e)),console.error("Failed to delete chat story:",t)}finally{r((0,s.r1)(!1))}}),m=(0,a.zD)("chat/fetchStoryDetails",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await o.m.getStory(e);return console.log("storyDetails",JSON.stringify(t)),t&&r((0,s.f5)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to fetch story details:",t),null}finally{r((0,s.r1)(!1))}}),h=(0,a.zD)("chat/fetchStoryToCurStoryContext",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await o.m.getStory(e);return console.log("fetchStoryToCurStoryContext storyDetails",JSON.stringify(t)),t&&r((0,s.Uw)(t)),t}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to fetch story to current story context:",t),null}finally{r((0,s.r1)(!1))}}),y=(0,a.zD)("chat/updateStoryTitle",async(e,t)=>{let{storyId:r,title:a}=e,{dispatch:n,getState:l}=t;try{n((0,s.r1)(!0));let e=await o.m.updateStory(r,a);if(e){var c;n((0,s.f5)(e));let t=e.id;(null==(c=l().chat.currentStoryContext)?void 0:c.id)===t&&n((0,s.Uw)(e))}return e}catch(t){let e=t instanceof Error?t.message:String(t);return n((0,s.Nh)(e)),console.error("Failed to update story title:",t),null}finally{n((0,s.r1)(!1))}});(0,a.zD)("chat/updateMessage",async(e,t)=>{let{dispatch:r,getState:a}=t;try{r((0,s.$c)(!0));let{storyId:t,messageId:n,content:l,contentType:c,metadata:i}=e,d=await o.m.updateMessage(t,n,l,c,i);if(d){let{curMessages:e}=a().chat,t=e.findIndex(e=>e.id===n);if(t>-1){let a=[...e];a[t]=d,r((0,s.Hw)(a))}}return d}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("Failed to update message:",t),null}finally{r((0,s.$c)(!1))}});let g=(0,a.zD)("chat/forkSharedStory",async(e,t)=>{let{dispatch:r}=t;try{r((0,s.r1)(!0));let t=await l.a.forkSharedStory(e);if(t&&t.newStoryId)return await r(h(t.newStoryId)),t.newStoryId;return r((0,s.Nh)("未能获取新创建的故事ID")),null}catch(t){let e=t instanceof Error?t.message:String(t);return r((0,s.Nh)(e)),console.error("分享故事衍生失败:",t),null}finally{r((0,s.r1)(!1))}});(0,a.zD)("chat/regenerateResponse",async(e,t)=>{let{storyId:r,messageId:a}=e,{dispatch:n,getState:l}=t;try{n((0,s.G0)(a));let e=l(),t=(0,c.rN)(e),i=(null==t?void 0:t.id)||"",d=await o.m.regenerateResponse(r,a,i);if(d){let{curMessages:e}=l().chat,t=e.findIndex(e=>e.id===a);if(t>-1){let r=[...e];r[t]=d,n((0,s.Hw)(r))}}return d}catch(t){let e=t instanceof Error?t.message:String(t);return n((0,s.Nh)(e)),console.error("Failed to regenerate response:",t),null}finally{n((0,s.G0)(null))}})},9371:(e,t,r)=>{r.d(t,{a:()=>l});var a=r(9249),s=r(6168),o=r(3299);class n{async createShareStory(e){try{return(await s.o.shareStories.createShareStory({createShareStoryRequestDto:e})).data}catch(e){throw console.error("Failed to create share story:",e),e}}async getPublicSharedStories(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{return(await s.o.shareStories.getPublicSharedStories({page:e,limit:t,...r})).data}catch(e){throw console.error("Failed to get public shared stories:",e),e}}async getSharedStoryBySlug(e){try{return(await s.o.shareStories.getSharedStoryBySlug({slug:e})).data}catch(e){throw console.error("Failed to get shared story by slug:",e),e}}async updateSharedStory(e,t){try{return(await s.o.shareStories.updateSharedStory({id:e,updateShareStoryRequestDto:t})).data}catch(e){throw console.error("Failed to update shared story:",e),e}}async deleteSharedStory(e){try{await s.o.shareStories.deleteSharedStory({id:e})}catch(e){throw console.error("Failed to delete shared story:",e),e}}async forkSharedStory(e){try{return(await s.o.shareStories.forkSharedStory({slug:e})).data}catch(e){throw console.error("Failed to fork shared story:",e),e}}}let l=new(n=(0,a.Cg)([o.A.Singleton],n))}}]);