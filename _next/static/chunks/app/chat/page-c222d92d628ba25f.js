(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{333:(e,t,r)=>{"use strict";r.d(t,{d:()=>o});var s=r(5155),l=r(2115),n=r(239),a=r(9434);let o=l.forwardRef((e,t)=>{let{className:r,...l}=e;return(0,s.jsx)(n.bL,{className:(0,a.cn)("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-[var(--switch-checked-bg)] data-[state=unchecked]:bg-[var(--switch-unchecked-bg)]",r),...l,ref:t,children:(0,s.jsx)(n.zi,{className:(0,a.cn)("pointer-events-none block h-4 w-4 rounded-full bg-[var(--switch-thumb-bg)] shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})})});o.displayName=n.bL.displayName},388:(e,t,r)=>{"use strict";r.d(t,{default:()=>B});var s=r(5155),l=r(2115),n=r(5695),a=r(5298),o=r(285),i=r(6766);let c=[{id:"1",name:"1",image:"/voice-actors/actor1.jpg",gender:"女",type:"公有",code:"11"},{id:"1188",name:"1188",image:"/voice-actors/actor2.jpg",gender:"女",type:"公有",code:"8"},{id:"1.1",name:"1.1 dy霸总萧炎",image:"/voice-actors/actor3.jpg",gender:"男",type:"公有",code:"中气十足男声"},{id:"1314",name:"1314",image:"/voice-actors/actor1.jpg",gender:"女",type:"公有",code:"1314"},{id:"2",name:"2",image:"/voice-actors/actor2.jpg",gender:"女",type:"公有",code:"自用"},{id:"2211",name:"2211",image:"/voice-actors/actor3.jpg",gender:"女",type:"公有",code:"1122"}];function d(e){let{isOpen:t,onClose:r,onSelect:n}=e,[a,d]=(0,l.useState)("全部"),[u,x]=(0,l.useState)(""),[m,h]=(0,l.useState)(!1),g=(0,l.useRef)(null);(0,l.useEffect)(()=>{let e=e=>{g.current&&!g.current.contains(e.target)&&r()};return t&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[t,r]);let f=c.filter(e=>{let t="全部"===a||"男声"===a&&"男"===e.gender||"女声"===a&&"女"===e.gender,r=""===u||e.name.toLowerCase().includes(u.toLowerCase())||e.code.toLowerCase().includes(u.toLowerCase());return t&&r});return t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-50",onClick:r}),(0,s.jsx)("div",{className:"fixed inset-0 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{ref:g,className:"bg-card rounded-lg w-[900px] max-w-[90%] max-h-[90vh] shadow-xl overflow-hidden",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center p-4 border-b border-border",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-foreground",children:"选择声优"}),(0,s.jsx)(o.$,{onClick:r,variant:"ghost",size:"icon",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)("input",{type:"text",placeholder:"搜索声优...",value:u,onChange:e=>x(e.target.value),className:"w-full bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md p-3 text-[var(--text-primary)] focus:outline-none input-focus"})}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>h(!m),className:"min-w-[120px] flex items-center justify-between",children:[(0,s.jsx)("span",{children:a}),(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M6 9l6 6 6-6"})})]}),m&&(0,s.jsx)("div",{className:"absolute right-0 top-full mt-1 w-full bg-card rounded-md shadow-lg overflow-hidden z-60",children:(0,s.jsxs)("div",{className:"p-1",children:[(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{d("全部"),h(!1)},children:["全部"===a&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"全部"]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{d("男声"),h(!1)},children:["男声"===a&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"男声"]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{d("女声"),h(!1)},children:["女声"===a&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"女声"]})]})})]})]}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-4 overflow-y-auto max-h-[500px] pr-2",children:f.map(e=>(0,s.jsx)("div",{className:"bg-card rounded-lg overflow-hidden",children:(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsx)("div",{className:"flex justify-center mb-3",children:(0,s.jsx)("div",{className:"relative h-16 w-16 rounded-full overflow-hidden",children:(0,s.jsx)(i.default,{src:e.image,alt:e.name,fill:!0,className:"object-cover"})})}),(0,s.jsxs)("div",{className:"flex items-center justify-center gap-2 mb-2",children:[(0,s.jsx)("h3",{className:"text-foreground font-medium",children:e.name}),(0,s.jsx)("span",{className:"bg-accent text-xs text-accent-foreground px-1 py-0.5 rounded",children:e.type})]}),(0,s.jsx)("div",{className:"text-center text-sm text-muted-foreground mb-3",children:e.code}),(0,s.jsxs)("div",{className:"text-center text-sm text-muted-foreground mb-3",children:["性别: ",e.gender]}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)(o.$,{className:"flex-1",variant:"outline",onClick:()=>n(e),children:"选择"}),(0,s.jsx)(o.$,{variant:"outline",size:"icon",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"}),(0,s.jsx)("path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"})]})})]})]})},e.id))})]})]})})]}):null}var u=r(2523),x=r(333);let m=["/backgrounds/bg1.jpg","/backgrounds/bg2.jpg","/backgrounds/bg3.jpg","/backgrounds/bg4.jpg","/backgrounds/bg5.jpg","/backgrounds/bg6.jpg","/backgrounds/bg7.jpg","/backgrounds/bg8.jpg","/backgrounds/bg9.jpg"],h=[{title:"Max系列: 极限性能，极致体验",description:"",models:[{id:"nalang-max",name:"nalang-max",description:"算力高，记忆力好，废话少（推荐）",icon:"bg-primary",price:"0.6规范/1K tokens"}]},{title:"XL系列: 均衡性价比，优良体验",description:"",models:[{id:"nalang-xl-8",name:"nalang-xl-8",description:"适合闲聊",icon:"bg-primary",price:"0.4规范/1K tokens"},{id:"nalang-xl-10",name:"nalang-xl-10",description:"最新一代常规模型（推荐）",icon:"bg-primary",price:"0.4规范/1K tokens"}]},{title:"Turbo: 快速响应，经久耐用",description:"",models:[{id:"nalang-turbo-v22",name:"nalang-turbo-v22",description:"新一代性价比之王",icon:"bg-secondary",price:"0.1规范/1K tokens",freeQuota:50},{id:"nalang-turbo-v21",name:"nalang-turbo-v21",description:"上一代性价比之王",icon:"bg-secondary",price:"0.1规范/1K tokens",freeQuota:50}]},{title:"Medium: 稳定可靠，性价比优",description:"",models:[{id:"nalang-medium-2",name:"nalang-medium-2",description:"稳定可靠的中型模型",icon:"bg-accent",price:"0.2规范/1K tokens"}]},{title:"Legacy: 经典模型，休闲首选",description:"",models:[{id:"nalang-turbo-v17",name:"nalang-turbo-v17",description:"主创性和话题掌控力",icon:"bg-accent",price:"0.1规范/1K tokens",freeQuota:50}]}];function g(e){let{isOpen:t,onClose:r,onBackgroundChange:n}=e,[a,c]=(0,l.useState)(!1),[g,f]=(0,l.useState)(!1),[v,p]=(0,l.useState)(!1),[j,b]=(0,l.useState)(!1),[w,y]=(0,l.useState)(!1),[N,k]=(0,l.useState)(!1),[C,L]=(0,l.useState)("1000"),[S,R]=(0,l.useState)(null),[E,T]=(0,l.useState)("故事"),[I,M]=(0,l.useState)(!1),[O,U]=(0,l.useState)(null),[A,z]=(0,l.useState)(!1),[B,_]=(0,l.useState)(h[1].models[1]),[W,D]=(0,l.useState)(!1),[$,F]=(0,l.useState)("标准"),H=e=>{R(e),n&&n(e)},P=e=>{_(e),z(!1)};return t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-50",onClick:r}),(0,s.jsxs)("div",{className:"fixed top-0 right-0 w-80 h-full bg-card shadow-lg border-l border-border overflow-y-auto z-50 text-foreground p-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"设置"}),(0,s.jsxs)("div",{className:"flex space-x-4",children:[(0,s.jsx)(o.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"}),(0,s.jsx)("polyline",{points:"16 6 12 2 8 6"}),(0,s.jsx)("line",{x1:"12",y1:"2",x2:"12",y2:"15"})]})}),(0,s.jsx)(o.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})})}),(0,s.jsx)(o.$,{variant:"ghost",size:"icon",onClick:r,className:"text-muted-foreground hover:text-foreground",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("label",{className:"text-sm",children:"开启高亮"}),(0,s.jsx)(x.d,{checked:a,onCheckedChange:c})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"故事标题"}),(0,s.jsx)(u.p,{type:"text",value:E,onChange:e=>T(e.target.value)})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"最大回复Token数量"}),(0,s.jsx)(u.p,{type:"text",value:C,onChange:e=>L(e.target.value)})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"模型"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>z(!A),className:"w-full justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"w-8 h-8 ".concat(B.icon," rounded-md flex items-center justify-center mr-2"),children:(0,s.jsx)("span",{className:"text-foreground text-xs",children:"AI"})}),(0,s.jsxs)("div",{className:"flex-1 text-left",children:[(0,s.jsx)("div",{className:"text-sm",children:B.name}),(0,s.jsxs)("div",{className:"flex justify-between text-xs text-muted-foreground",children:[(0,s.jsx)("span",{children:B.description}),(0,s.jsx)("span",{children:B.price})]})]})]}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),A&&(0,s.jsx)("div",{className:"absolute z-50 w-full mt-1 bg-card border border-border rounded shadow-lg max-h-[400px] overflow-y-auto",children:h.map((e,t)=>(0,s.jsxs)("div",{className:"border-b border-border last:border-b-0",children:[e.title&&(0,s.jsx)("div",{className:"text-xs text-muted-foreground p-2 bg-card",children:e.title}),(0,s.jsx)("div",{className:"p-1",children:e.models.map((e,r)=>(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-start h-auto py-2",onClick:()=>P(e),children:[(0,s.jsx)("div",{className:"w-8 h-8 ".concat(e.icon," rounded-md flex items-center justify-center mr-2 flex-shrink-0"),children:(0,s.jsx)("span",{className:"text-foreground text-xs",children:"AI"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,s.jsx)("div",{className:"text-sm text-foreground",children:e.name}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.description}),(0,s.jsxs)("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[(0,s.jsx)("span",{children:e.price}),e.freeQuota&&(0,s.jsxs)("span",{className:"text-accent-foreground",children:["剩余免费次数: ",e.freeQuota]})]})]}),B.id===e.id&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]},"".concat(t,"-").concat(r)))})]},t))})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"风格"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>D(!W),className:"w-full justify-between",children:[(0,s.jsx)("span",{children:$}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),W&&(0,s.jsx)("div",{className:"absolute z-50 w-full mt-1 bg-card border border-border rounded shadow-lg",children:(0,s.jsxs)("div",{className:"p-1",children:[(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-between",onClick:()=>{F("标准"),D(!1)},children:[(0,s.jsx)("span",{className:"flex-1 text-left",children:"标准"}),"标准"===$&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-between",onClick:()=>{F("创意"),D(!1)},children:[(0,s.jsx)("span",{className:"flex-1 text-left",children:"创意"}),"创意"===$&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]})]})})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"声优"}),(0,s.jsx)(o.$,{variant:"outline",onClick:()=>M(!0),className:"w-full justify-start",children:O?O.name:"选择声优"})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("label",{className:"text-sm block",children:"语音设置"}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("label",{className:"text-sm",children:"自动朗读"}),(0,s.jsx)(x.d,{checked:g,onCheckedChange:f})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("label",{className:"text-sm",children:"跳过中括号内容"}),(0,s.jsx)(x.d,{checked:v,onCheckedChange:p})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("label",{className:"text-sm",children:"只朗读引号内容"}),(0,s.jsx)(x.d,{checked:j,onCheckedChange:b})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("label",{className:"text-sm",children:"跳过英文内容"}),(0,s.jsx)(x.d,{checked:w,onCheckedChange:y})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("label",{className:"text-sm",children:"只朗读星号内容"}),(0,s.jsx)(x.d,{checked:N,onCheckedChange:k})]})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("label",{className:"text-sm block",children:"背景图片"}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-2",children:m.map((e,t)=>(0,s.jsx)("div",{className:"relative h-20 w-full rounded-md overflow-hidden cursor-pointer border-2 ".concat(S===e?"border-primary":"border-transparent"),onClick:()=>H(e),children:(0,s.jsx)(i.default,{src:e,alt:"背景".concat(t+1),fill:!0,className:"object-cover"})},t))})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"自定义背景"}),(0,s.jsxs)("label",{className:"flex items-center justify-center p-2 bg-muted border border-border rounded-md cursor-pointer hover:bg-border",children:[(0,s.jsx)("span",{className:"text-foreground",children:"选择文件"}),(0,s.jsx)("input",{type:"file",className:"hidden",accept:"image/*",onChange:e=>{e.target.files&&e.target.files[0]&&H(URL.createObjectURL(e.target.files[0]))}})]}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground text-center",children:"未选择任何文件"})]}),(0,s.jsx)("div",{className:"pt-4 mt-6 border-t border-border",children:(0,s.jsxs)(o.$,{variant:"outline",className:"w-full flex items-center justify-center",children:[(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,s.jsx)("polyline",{points:"3 6 5 6 21 6"}),(0,s.jsx)("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),"删除故事"]})})]})]}),(0,s.jsx)(d,{isOpen:I,onClose:()=>M(!1),onSelect:e=>{U(e),M(!1)}})]}):null}var f=r(6874),v=r.n(f),p=r(3500),j=r(1394);function b(e){let{activeStoryId:t,isOpen:r=!0,onClose:n,searchMode:a=!1}=e,[o,i]=(0,l.useState)(""),[c,d]=(0,l.useState)(!1),[u,x]=(0,l.useState)(!1),m=(0,l.useRef)(null),[h,g]=(0,l.useState)(!0),{stories:f,isLoading:b,error:w,fetchStories:y}=(0,p.R7)();(0,l.useEffect)(()=>{f.length>0&&g(!1)},[f]),(0,l.useEffect)(()=>{let e=setTimeout(()=>{h&&0===f.length&&(console.log("StorySidebar: loading timeout, forcing end of loading state"),g(!1))},3e3);return()=>clearTimeout(e)},[h,f.length]),(0,l.useEffect)(()=>{},[y]);let N=e=>{if(!e)return{date:"",time:""};let t=new Date(e);return{date:"".concat(t.getMonth()+1,"-").concat(t.getDate()),time:t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}},k=o?f.filter(e=>{var t;if(e.title&&e.title.toLowerCase().includes(o.toLowerCase()))return!0;let r="string"==typeof e.lastMessage?e.lastMessage:null==(t=e.lastMessage)?void 0:t.content;return!!(r&&r.toLowerCase().includes(o.toLowerCase()))}):f,C=()=>{n&&n()},L=()=>{i(""),x(!1),m.current&&m.current.focus()};(0,l.useEffect)(()=>{if(r&&window.innerWidth<768||r&&a){let e=setTimeout(()=>{var e;null==(e=m.current)||e.focus()},300);return()=>clearTimeout(e)}},[r,a]);let S=e=>{let{story:r}=e,{avatarUrl:l,characterName:n,lastMessage:a,lastMessageAt:o,title:i}=r,c=N(o?new Date(o):Date.now());return(0,s.jsxs)(v(),{href:"/chat?storyId=".concat(r.id),onClick:C,className:"flex items-center p-4 hover:bg-muted ".concat(r.id===t?"bg-muted":""),children:[(0,s.jsx)("div",{className:"relative h-10 w-10 rounded-full overflow-hidden mr-3",children:(0,s.jsxs)(j.eu,{className:"h-full w-full",children:[(0,s.jsx)(j.BK,{src:l,alt:i||"",className:"object-cover"}),(0,s.jsx)(j.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==i?void 0:i.charAt(0).toUpperCase())||"S"})]})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("div",{className:"text-foreground font-medium truncate",children:i||"未命名"}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:c.time})]}),(0,s.jsx)("div",{className:"text-sm text-muted-foreground truncate",children:"string"==typeof a?a:(null==a?void 0:a.content)||"无消息"}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:c.date})]})]})};return(0,s.jsxs)("div",{className:"\n        ".concat(r?"translate-x-0":"-translate-x-full","\n        fixed md:relative md:translate-x-0\n        w-[280px] md:w-72 h-full bg-card/50 border-r border-border flex flex-col\n        transition-transform duration-300 ease-in-out z-30\n      "),children:[(0,s.jsxs)("div",{className:"p-4 border-b border-border flex items-center ".concat(a?"bg-muted/50":""),children:[(0,s.jsxs)("div",{className:"relative flex-1 ".concat(c||a?"ring-1 ring-border rounded-md":""),children:[(0,s.jsx)("input",{ref:m,type:"text",value:o,onChange:e=>{let t=e.target.value;i(t),t?(x(!0),setTimeout(()=>{x(!1)},300)):x(!1),t.length},onFocus:()=>d(!0),onBlur:()=>d(!1),placeholder:a?"搜索聊天...":"搜索",className:"w-full bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md p-2 pl-9 text-[var(--text-primary)] focus:outline-none input-focus","aria-label":"搜索聊天"}),(0,s.jsx)("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 text-muted-foreground",children:u?(0,s.jsxs)("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),o&&(0,s.jsx)("button",{onClick:L,className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground","aria-label":"清除搜索",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),(0,s.jsx)("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]})})]}),(0,s.jsx)("button",{onClick:n,className:"ml-2 text-muted-foreground hover:text-foreground p-2 md:hidden","aria-label":"关闭侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar scrollbar-thin scrollbar-track-background scrollbar-thumb-border hover:scrollbar-thumb-border/80",children:h?(0,s.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,s.jsxs)("svg",{className:"animate-spin h-8 w-8 text-foreground",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):o&&0===k.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"未找到结果"}),(0,s.jsxs)("p",{className:"text-muted-foreground mt-2 mb-4",children:['没有找到与"',o,'"相关的聊天']}),(0,s.jsx)("button",{onClick:L,className:"px-4 py-2 bg-primary text-foreground rounded-md transition-colors",children:"清除搜索"})]}):0===k.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),(0,s.jsx)("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"暂无聊天记录"}),(0,s.jsx)("p",{className:"text-muted-foreground mt-2",children:"开始与角色聊天创建新的故事"})]}):k.map(e=>(0,s.jsx)(S,{story:e},e.id))}),r&&(0,s.jsx)("div",{className:"fixed inset-0 bg-background/70 z-20 md:hidden",onClick:n,"aria-hidden":"true"})]})}var w=r(4165);function y(e){let{isOpen:t,onClose:r,title:l,onTitleChange:n,onStoryCreated:a,isCreating:i}=e;return(0,s.jsx)(w.lG,{open:t,onOpenChange:r,children:(0,s.jsxs)(w.Cf,{className:"bg-opacity-90 bg-background backdrop-blur-sm z-150",children:[(0,s.jsx)(w.c7,{children:(0,s.jsx)(w.L3,{children:"创建新故事"})}),(0,s.jsxs)("div",{className:"py-4",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"故事标题"}),(0,s.jsx)(u.p,{value:l,onChange:e=>n(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"输入故事标题",autoFocus:!0})]}),(0,s.jsxs)(w.Es,{children:[(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:r,children:"取消"}),(0,s.jsx)(o.$,{onClick:a,variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:i||!l.trim(),children:i?"创建中...":"创建故事"})]})]})})}var N=r(2045),k=r(1795),C=r(4421),L=r(822),S=r(9161),R=r.n(S),E=function(e){return e.ENGLISH="ENGLISH",e.CURLY="CURLY",e.GUILLEMETS="GUILLEMETS",e.CORNER="CORNER",e.WHITE_CORNER="WHITE_CORNER",e.FULLWIDTH="FULLWIDTH",e}(E||{}),T=function(e){return e[e.USER_INPUT=0]="USER_INPUT",e[e.AI_OUTPUT=1]="AI_OUTPUT",e[e.SLASH_COMMAND=2]="SLASH_COMMAND",e[e.WORLD_INFO=3]="WORLD_INFO",e[e.AUTHOR_NOTE=4]="AUTHOR_NOTE",e[e.INSTRUCT=5]="INSTRUCT",e[e.RAW_INPUT=6]="RAW_INPUT",e[e.REPLACEMENT=7]="REPLACEMENT",e[e.REASONING=8]="REASONING",e}({});class I{setVariable(e,t){this.environment[e]=t}addRegexRule(e){this.regexRules.push(e)}format(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return"";let r=this.substituteVariables(e);if(r=this.applyRegexRules(r,1,t),r=this.processQuotes(r),!1!==t.isMarkdown&&(r=this.convertMarkdown(r)),r=this.encodeStyleTags(r),!t.skipSanitize){let e={ALLOWED_TAGS:["div","span","a","p","br","strong","em","b","i","ul","ol","li","code","pre","blockquote","q","img","h1","h2","h3","h4","h5","h6","table","thead","tbody","tr","th","td","hr","del","ins","mark","custom-style","sup","sub"],ALLOWED_ATTR:["href","src","class","style","title","alt","target","rel","id","width","height"],ADD_TAGS:["custom-style"],ADD_ATTR:["target","rel"],FORBID_TAGS:["style","script"],FORBID_ATTR:["onerror","onload","onclick"]};t.allowUnsafeHTML&&(e.ALLOW_UNKNOWN_PROTOCOLS=!0,e.ALLOW_ARIA_ATTR=!0);let s=L.A.sanitize(r,e);r="string"==typeof s?s:String(s)}return this.decodeStyleTags(r)}substituteVariables(e){var t,r;if(!e)return"";let s=e;for(let e in this.environment)if(Object.prototype.hasOwnProperty.call(this.environment,e)){let t=this.environment[e],r=RegExp("{{".concat(this.escapeRegex(e),"}}"),"gi");s=s.replace(r,"function"==typeof t?t():t.toString())}return(s=s.replace(/<USER>/gi,(null==(t=this.environment.user)?void 0:t.toString())||"")).replace(/<CHAR>/gi,(null==(r=this.environment.char)?void 0:r.toString())||"")}applyRegexRules(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e||0===this.regexRules.length)return e;let s=e;for(let e of this.regexRules.filter(e=>!e.disabled&&e.placement.includes(t)&&(!e.markdownOnly&&!e.promptOnly||e.markdownOnly&&r.isMarkdown||e.promptOnly&&r.isPrompt)&&(!r.isEdit||!1!==e.runOnEdit)&&(void 0===r.depth||void 0===e.minDepth||r.depth>=e.minDepth)&&(void 0===r.depth||void 0===e.maxDepth||r.depth<=e.maxDepth)))try{let t=RegExp(e.find,"g");s="string"==typeof e.replace?s.replace(t,e.replace):s.replace(t,function(t){for(var r=arguments.length,s=Array(r>1?r-1:0),l=1;l<r;l++)s[l-1]=arguments[l];return(0,e.replace)(t,...s)})}catch(t){console.error('正则表达式规则 "'.concat(e.name,'" 应用失败:'),t)}return s}processQuotes(e){return e?e=(e=(e=e.replace(/<([^>]+)>/g,(e,t)=>"<"+t.replace(/"/g,"￾")+">")).replace(/```[\s\S]*?```|``[\s\S]*?``|`[\s\S]*?`|(".*?")|(\u201C.*?\u201D)|(\u00AB.*?\u00BB)|(\u300C.*?\u300D)|(\u300E.*?\u300F)|(\uFF02.*?\uFF02)/gm,(e,t,r,s,l,n,a)=>{if(t)return'<q>"'.concat(t.slice(1,-1),'"</q>');if(r)return'<q>"'.concat(r.slice(1,-1),'"</q>');if(s)return"<q>\xab".concat(s.slice(1,-1),"\xbb</q>");if(l)return"<q>「".concat(l.slice(1,-1),"」</q>");if(n)return"<q>『".concat(n.slice(1,-1),"』</q>");else if(a)return"<q>＂".concat(a.slice(1,-1),"＂</q>");else return e})).replace(/\ufffe/g,'"'):""}convertMarkdown(e){if(!e)return"";e=(e=e.replaceAll("\\begin{align*}","$$")).replaceAll("\\end{align*}","$$");let t=this.converter.makeHtml(e);return(t=(t=(t=(t=t.replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/\n/gm,"\0"))).replace(/\u0000/g,"\n")).replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/&amp;/g,"&"))).replace(/<pre><code(.*?)>([\s\S]*?)<\/code><\/pre>/g,(e,t,r)=>'<pre style="overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code'.concat(t,">").concat(r,"</code></pre>"))).trim()}encodeStyleTags(e){return e?e.replace(/<style>([^]*?)<\/style>/g,(e,t)=>"<custom-style>".concat(escape(t),"</custom-style>")):""}decodeStyleTags(e){return e?e.replace(/<custom-style>([^]*?)<\/custom-style>/g,(e,t)=>{try{let e=unescape(t).replace(/<br\/>/g,"");return"<style>".concat(e,"</style>")}catch(e){return"CSS ERROR: ".concat(e)}}):""}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}formatWithRegexOnly(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.applyRegexRules(e,t,r)}substituteOnly(e){return this.substituteVariables(e)}processQuotesOnly(e){return this.processQuotes(e)}markdownOnly(e){return this.convertMarkdown(e)}constructor(e={},t=[]){this.regexRules=[],this.environment={},this.environment=e,this.regexRules=t,this.converter=new(R()).Converter({tables:!0,simpleLineBreaks:!0,strikethrough:!0,literalMidWordUnderscores:!0,tasklists:!0,smoothLivePreview:!0,smartIndentationFix:!0}),this.converter.setOption("openLinksInNewWindow",!0),this.converter.setOption("ghMentions",!1),this.converter.setOption("emoji",!0)}}new I;let M=new I;function O(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))M.setVariable(e,r);return M.format(e)}function U(e){var t,r;let{character:a,error:i,clearError:c}=e,d=(0,n.useRouter)(),[u,x]=(0,l.useState)(""),[m,h]=(0,l.useState)(!1),[f,v]=(0,l.useState)(""),[w,L]=(0,l.useState)(!1),[S,R]=(0,l.useState)(!1),E=(0,N.G)(k.xu),T=(0,N.G)(k.vc),[I,U]=(0,l.useState)(!1),[A,z]=(0,l.useState)(null),[B,_]=(0,l.useState)(!1),[W,D]=(0,l.useState)(!1),[$,F]=(0,l.useState)(!0),[H,P]=(0,l.useState)("fade-in-up"),q=(0,l.useRef)(null),V=(0,l.useRef)(null),{currentStoryId:K,currentCharacterId:G,messages:Q,isLoading:Z,isSending:X,error:Y,sendMessage:J,addMessage:ee,sendStreamMessage:et,fetchCurStoryHistory:er}=(0,p.Z3)(),{createStory:es,fetchStories:el}=(0,p.R7)(),{tempContext:en,initTempContext:ea}=(0,p.ki)(),{formatChat:eo}=function(){let e=(0,N.G)(e=>e.user.currentUser),t=(null==e?void 0:e.username)||"User",r=(0,l.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return O(e,t)},[]),s=(0,l.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))M.setVariable(e,r);return M.substituteOnly(e)}(e,t)},[]);return{format:r,substitute:s,formatChat:(0,l.useCallback)(function(e,r){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return O(e,{user:t,char:r,...s})}(e,t,r,s)},[t]),formatWithDateTime:(0,l.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return O(e,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString(),...t})},[])}}(),ei=S&&en?en.messages:Q,ec=(0,l.useCallback)(e=>{let t=window.innerWidth<768;!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLSelectElement)&&(("/"===e.key||e.ctrlKey&&"f"===e.key)&&!I&&(e.preventDefault(),t?ex():_(!0)),"Escape"===e.key&&(B||I)&&(e.preventDefault(),I?U(!1):B&&em()))},[B,I]);(0,l.useEffect)(()=>(window.addEventListener("keydown",ec),()=>{window.removeEventListener("keydown",ec)}),[ec]),(0,l.useEffect)(()=>{a&&!K&&ea(a)},[el,a,K,ea]),(0,l.useEffect)(()=>{!K&&G?R(!0):K&&G?R(!1):(console.error("currentStoryId",K),console.error("currentCharacterId",G))},[K,G]),(0,l.useEffect)(()=>{q.current&&q.current.scrollIntoView({behavior:"smooth"})},[Q,ei]),(0,l.useEffect)(()=>{if(console.log("isSending 滚动到最新消息",X),X){q.current&&q.current.scrollIntoView({behavior:"smooth"});let e=setTimeout(()=>{q.current&&(q.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 延迟500ms"))},500),t=setTimeout(()=>{q.current&&(q.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 延迟1500ms"))},1500);return()=>{clearTimeout(e),clearTimeout(t)}}if(!1===X){let e=setTimeout(()=>{q.current&&(q.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 发送完成"))},300);return()=>clearTimeout(e)}},[X]),(0,l.useEffect)(()=>{if($){let e=setTimeout(()=>{P("fade-out-down"),setTimeout(()=>{F(!1)},300)},5e3);return()=>clearTimeout(e)}},[$]),(0,l.useEffect)(()=>{let e=()=>{P("fade-out-down"),setTimeout(()=>{F(!1)},300)};return window.addEventListener("click",e),window.addEventListener("touchstart",e),()=>{window.removeEventListener("click",e),window.removeEventListener("touchstart",e)}},[]),(0,l.useEffect)(()=>{if(m&&a){let e=(null==E?void 0:E.username)||"用户";v("".concat(e,"和").concat(a.name,"的浪漫故事"))}},[m,E,a]),(0,l.useEffect)(()=>{if(i){let e=setTimeout(()=>{c()},5e3);return()=>clearTimeout(e)}},[i,c]);let ed=()=>{u.trim()&&a&&(u.length>1e3||(q.current&&q.current.scrollIntoView({behavior:"smooth"}),ee({storyId:K,characterId:a.id,contentType:C._8.TEXT,content:u}).then(e=>{e&&(J(e),x(""),setTimeout(()=>{q.current&&q.current.scrollIntoView({behavior:"smooth"})},100))})))},eu=async()=>{if(f.trim()&&a){if(!S)return void console.error("isCharaterMode",S);L(!0);try{let e=ei.map((e,t)=>({content:e.content,contentType:e.contentType,index:t,metadata:e.metadata||{}})),t={characterId:a.id,title:f,initialMessages:e};await es(t)&&(el(),x(""))}catch(e){console.error("Failed to create story:",e)}finally{L(!1),h(!1)}}},ex=()=>{_(!0),D(!0)},em=()=>{_(!1),D(!1)};return a?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"pt-16 flex h-[calc(100vh-4rem)]",children:[(0,s.jsx)(b,{activeStoryId:K||"",isOpen:B,onClose:em,searchMode:W}),(0,s.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden relative w-full z-0",children:[(0,s.jsxs)("div",{className:"bg-card p-3 sm:p-4 flex items-center border-b border-border",children:[(0,s.jsx)("button",{onClick:()=>_(!0),className:"mr-3 text-foreground p-1 md:hidden","aria-label":"打开侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),(0,s.jsx)("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),(0,s.jsx)("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),(0,s.jsx)("div",{className:"relative h-10 w-10 sm:h-12 sm:w-12 rounded-full overflow-hidden mr-3 sm:mr-4 flex-shrink-0",children:(0,s.jsxs)(j.eu,{className:"h-full w-full",children:[(0,s.jsx)(j.BK,{src:a.avatarUrl,alt:a.name,className:"object-cover",shouldBlur:a.shouldBlurAvatar}),(0,s.jsx)(j.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(t=a.name)?void 0:t.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("h2",{className:"text-lg sm:text-xl font-bold text-foreground truncate",children:a.name}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:ex,className:"text-foreground p-2 rounded-full hover:bg-muted transition-colors md:hidden","aria-label":"搜索聊天",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),(0,s.jsx)("button",{onClick:()=>U(!0),className:"text-foreground p-2 rounded-full hover:bg-muted transition-colors","aria-label":"设置",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})]})]}),(0,s.jsx)("p",{className:"text-muted-foreground text-xs sm:text-sm truncate",children:a.description})]})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4 bg-background relative z-5",style:A?{backgroundImage:"url(".concat(A,")"),backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:{},children:[A&&(0,s.jsx)("div",{className:"absolute inset-0 bg-background z-0"}),(0,s.jsx)("div",{className:"mx-auto w-full relative z-5",style:{maxWidth:"1800px"},children:(0,s.jsxs)("div",{className:"space-y-3 sm:space-y-4 relative z-5",children:[ei.map(e=>{var t,r;return(0,s.jsxs)("div",{className:"flex ".concat(e.role===C.hE.USER?"justify-end":"justify-start"),children:[e.role!==C.hE.USER&&(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(j.eu,{className:"h-full w-full",children:[(0,s.jsx)(j.BK,{src:a.avatarUrl,alt:a.name,className:"object-cover",shouldBlur:a.shouldBlurAvatar}),(0,s.jsx)(j.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(t=a.name)?void 0:t.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsxs)("div",{className:"max-w-[80%] sm:max-w-[70%] rounded-lg p-2 sm:p-3 ".concat(e.role===C.hE.USER?"border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)]":"bg-card text-foreground"),children:[(0,s.jsx)("div",{className:"whitespace-pre-wrap text-sm sm:text-base [&_pre]:overflow-x-auto [&_pre]:whitespace-pre-wrap [&_pre]:word-wrap-break-word [&_code]:break-words",dangerouslySetInnerHTML:{__html:eo(e.content,a.name,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString()})}}),(0,s.jsx)("p",{className:"text-[10px] sm:text-xs opacity-70 mt-1",children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.role===C.hE.USER&&(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(j.eu,{className:"h-full w-full",children:[(0,s.jsx)(j.BK,{src:T,alt:(null==E?void 0:E.username)||"用户",className:"object-cover"}),(0,s.jsx)(j.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==E||null==(r=E.username)?void 0:r.charAt(0).toUpperCase())||"U"})]})})]},e.id)}),X&&(0,s.jsxs)("div",{className:"flex justify-start",children:[(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(j.eu,{className:"h-full w-full",children:[(0,s.jsx)(j.BK,{src:a.avatarUrl,alt:a.name,className:"object-cover",shouldBlur:a.shouldBlurAvatar}),(0,s.jsx)(j.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(r=a.name)?void 0:r.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsx)("div",{className:"bg-card text-foreground rounded-lg p-2 sm:p-3 max-w-[80%] sm:max-w-[70%]",children:(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.2s"}}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.4s"}})]})})]}),(0,s.jsx)("div",{ref:q})]})})]}),(0,s.jsx)("div",{className:"bg-background relative z-20",children:(0,s.jsxs)("div",{className:"mx-auto w-full",style:{maxWidth:"1800px"},children:[i&&(0,s.jsx)("div",{className:"px-3 py-2 bg-destructive/50 text-destructive-foreground rounded-md text-sm mx-2 sm:mx-4 mt-2 sm:mt-3",children:(0,s.jsx)("p",{children:i})}),(0,s.jsx)("div",{className:"flex justify-center items-center p-2 sm:p-4",children:(0,s.jsxs)("div",{className:"relative flex items-center w-full",children:[(0,s.jsx)("button",{className:"absolute left-3 sm:left-4 text-primary/70 hidden sm:block",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{d:"M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"})})}),!K&&(null==a?void 0:a.id)?(0,s.jsx)("button",{onClick:()=>{h(!0)},className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 sm:pl-12 pr-12 sm:pr-16 py-2 sm:py-3 text-sm sm:text-base text-[var(--text-primary)] focus:outline-none hover:bg-[var(--bg-tertiary)]/90 transition-colors",children:"创建故事"}):(0,s.jsx)("textarea",{ref:V,value:u,onChange:e=>{x(e.target.value),e.target.value.length>1e3||i&&e.target.value.length<=1e3&&c()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),ed())},placeholder:"输入消息 (Shift+Enter 换行)",className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 sm:pl-12 pr-12 sm:pr-16 py-2 sm:py-3 text-sm sm:text-base text-[var(--text-primary)] focus:outline-none input-focus resize-none scrollbar scrollbar-thin scrollbar-track-[var(--bg-secondary)] scrollbar-thumb-[var(--primary)]/20 hover:scrollbar-thumb-[var(--primary)]/40",rows:1}),K&&(0,s.jsx)("button",{className:"absolute right-3 sm:right-4 bg-[var(--primary)] h-7 w-7 sm:h-8 sm:w-8 rounded-full flex items-center justify-center hover:bg-[var(--primary-hover)]",onClick:ed,disabled:X||u.length>1e3||""===u.trim(),children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-primary-foreground",children:[(0,s.jsx)("path",{d:"M22 2L11 13"}),(0,s.jsx)("path",{d:"M22 2L15 22L11 13L2 9L22 2Z"})]})})]})})]})})]}),$&&!B&&!I&&(0,s.jsx)("div",{className:"fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-card text-foreground px-4 py-2 rounded-lg shadow-lg text-sm md:hidden z-10 ".concat("fade-in-up"===H?"animate-fade-in-up":"animate-fade-out-down"),children:(0,s.jsx)("p",{children:'提示: 按 "/" 键快速搜索'})}),(0,s.jsx)(g,{isOpen:I,onClose:()=>U(!1),onBackgroundChange:e=>{z(e)}})]}),m&&(0,s.jsx)(y,{isOpen:m,onClose:()=>h(!1),title:f,onTitleChange:v,onStoryCreated:eu,isCreating:w})]}):(0,s.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"角色不存在"}),(0,s.jsx)("p",{className:"mb-8",children:"无法找到该角色，请返回角色库选择其他角色。"}),(0,s.jsx)(o.$,{className:"bg-primary text-foreground",onClick:()=>d.push("/characters"),children:"返回角色库"})]})}M.addRegexRule({name:"表情符号替换",find:":(smile|grin|laugh|wink|heart|cry|sob|angry):",replace:(e,t)=>({smile:"\uD83D\uDE0A",grin:"\uD83D\uDE01",laugh:"\uD83D\uDE02",wink:"\uD83D\uDE09",heart:"❤️",cry:"\uD83D\uDE22",sob:"\uD83D\uDE2D",angry:"\uD83D\uDE20"})[t]||e,placement:[T.AI_OUTPUT,T.USER_INPUT]}),M.addRegexRule({name:"强调内容",find:"\\*\\*([^*]+)\\*\\*",replace:"<strong>$1</strong>",placement:[T.AI_OUTPUT,T.USER_INPUT]}),M.addRegexRule({name:"斜体内容",find:"\\*([^*]+)\\*",replace:"<em>$1</em>",placement:[T.AI_OUTPUT,T.USER_INPUT]});var A=r(2847),z=r(8613);function B(){return(0,s.jsxs)("main",{className:"min-h-screen bg-background relative",children:[(0,s.jsx)(a.default,{}),(0,s.jsx)(l.Suspense,{fallback:(0,s.jsx)(_,{}),children:(0,s.jsx)(W,{})})]})}function _(){return(0,s.jsxs)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:[(0,s.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-primary motion-reduce:animate-[spin_1.5s_linear_infinite]",children:(0,s.jsx)("span",{className:"sr-only",children:"Loading..."})}),(0,s.jsx)("p",{className:"ml-3 text-foreground",children:"正在加载聊天数据..."})]})}function W(){let e=(0,n.useRouter)(),t=(0,n.useSearchParams)(),r=null==t?void 0:t.get("characterId"),a=null==t?void 0:t.get("storyId"),[o,i]=(0,l.useState)(null),{clearCurrentStoryContext:c}=(0,p.w0)(),{currentUser:d}=(0,z.Jd)(),{currentCharacter:u,isLoading:x,error:m}=(0,A.OE)(),{fetchCharacterById:h}=(0,A.MM)(),{fetchStoryToCurStoryContext:g,isLoading:f,fetchStories:v,currentStoryId:j}=(0,p.R7)(),{error:b,clearErrors:w,isLoading:y,currentStory:N,fetchCurStoryHistory:k}=(0,p.Z3)();return((0,l.useEffect)(()=>{console.log("Effect: Fetch stories triggered"),d&&v()},[d,v]),(0,l.useEffect)(()=>{console.log("Effect: Fetch story context triggered, storyId:",a),a?g(a):c()},[a,g,c]),(0,l.useEffect)(()=>{let e=null==N?void 0:N.characterId;console.log("Effect: Fetch character and history for story triggered, charId:",e),e&&(h(e),k(0,30))},[null==N?void 0:N.characterId,h,k]),(0,l.useEffect)(()=>{console.log("Effect: Fetch character by URL ID triggered, characterId:",r,"storyId:",a),r&&!a&&h(r)},[r,a,h]),y||x||f)?(0,s.jsx)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:(0,s.jsx)("span",{className:"text-foreground",children:"正在加载聊天数据..."})}):u?(0,s.jsx)(U,{character:u,error:o||m||b,clearError:w}):(0,s.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"正在加载角色..."}),(0,s.jsx)("p",{className:"mb-8",children:"请稍候，如果长时间未响应或角色不存在，请返回角色库选择其他角色。"}),(0,s.jsx)("button",{className:"bg-primary/20 hover:bg-primary/30 px-4 py-2 rounded",onClick:()=>e.push("/characters"),children:"返回角色库"})]})}},2523:(e,t,r)=>{"use strict";r.d(t,{p:()=>a});var s=r(5155),l=r(2115),n=r(9434);let a=l.forwardRef((e,t)=>{let{className:r,type:l,...a}=e;return(0,s.jsx)("input",{type:l,className:(0,n.cn)("flex h-10 w-full rounded-md border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",r),ref:t,...a})});a.displayName="Input"},6773:(e,t,r)=>{Promise.resolve().then(r.bind(r,388))}},e=>{var t=t=>e(e.s=t);e.O(0,[951,320,428,702,500,698,600,613,917,441,684,358],()=>t(6773)),_N_E=e.O()}]);