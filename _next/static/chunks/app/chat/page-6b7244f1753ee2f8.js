(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{795:(e,t,r)=>{"use strict";r.d(t,{d:()=>y});var s=r(5155),l=r(2115),n=r(5185),a=r(6101),o=r(6081),i=r(5845),c=r(1275),d=r(3655),u="Switch",[m,x]=(0,o.A)(u),[h,g]=m(u),p=l.forwardRef((e,t)=>{let{__scopeSwitch:r,name:o,checked:c,defaultChecked:m,required:x,disabled:g,value:p="on",onCheckedChange:f,form:v,...w}=e,[y,N]=l.useState(null),k=(0,a.s)(t,e=>N(e)),C=l.useRef(!1),L=!y||v||!!y.closest("form"),[E,S]=(0,i.i)({prop:c,defaultProp:null!=m&&m,onChange:f,caller:u});return(0,s.jsxs)(h,{scope:r,checked:E,disabled:g,children:[(0,s.jsx)(d.sG.button,{type:"button",role:"switch","aria-checked":E,"aria-required":x,"data-state":j(E),"data-disabled":g?"":void 0,disabled:g,value:p,...w,ref:k,onClick:(0,n.m)(e.onClick,e=>{S(e=>!e),L&&(C.current=e.isPropagationStopped(),C.current||e.stopPropagation())})}),L&&(0,s.jsx)(b,{control:y,bubbles:!C.current,name:o,value:p,checked:E,required:x,disabled:g,form:v,style:{transform:"translateX(-100%)"}})]})});p.displayName=u;var f="SwitchThumb",v=l.forwardRef((e,t)=>{let{__scopeSwitch:r,...l}=e,n=g(f,r);return(0,s.jsx)(d.sG.span,{"data-state":j(n.checked),"data-disabled":n.disabled?"":void 0,...l,ref:t})});v.displayName=f;var b=l.forwardRef((e,t)=>{let{__scopeSwitch:r,control:n,checked:o,bubbles:i=!0,...d}=e,u=l.useRef(null),m=(0,a.s)(u,t),x=function(e){let t=l.useRef({value:e,previous:e});return l.useMemo(()=>(t.current.value!==e&&(t.current.previous=t.current.value,t.current.value=e),t.current.previous),[e])}(o),h=(0,c.X)(n);return l.useEffect(()=>{let e=u.current;if(!e)return;let t=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"checked").set;if(x!==o&&t){let r=new Event("click",{bubbles:i});t.call(e,o),e.dispatchEvent(r)}},[x,o,i]),(0,s.jsx)("input",{type:"checkbox","aria-hidden":!0,defaultChecked:o,...d,tabIndex:-1,ref:m,style:{...d.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});function j(e){return e?"checked":"unchecked"}b.displayName="SwitchBubbleInput";var w=r(9434);let y=l.forwardRef((e,t)=>{let{className:r,...l}=e;return(0,s.jsx)(p,{className:(0,w.cn)("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-[var(--switch-checked-bg)] data-[state=unchecked]:bg-[var(--switch-unchecked-bg)]",r),...l,ref:t,children:(0,s.jsx)(v,{className:(0,w.cn)("pointer-events-none block h-4 w-4 rounded-full bg-[var(--switch-thumb-bg)] shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})})});y.displayName=p.displayName},2523:(e,t,r)=>{"use strict";r.d(t,{p:()=>a});var s=r(5155),l=r(2115),n=r(9434);let a=l.forwardRef((e,t)=>{let{className:r,type:l,...a}=e;return(0,s.jsx)("input",{type:l,className:(0,n.cn)("flex h-10 w-full rounded-md border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",r),ref:t,...a})});a.displayName="Input"},3183:(e,t,r)=>{"use strict";r.d(t,{default:()=>et});var s=r(5155),l=r(2115),n=r(5695),a=r(5298),o=r(285),i=r(7374),c=r(6766);let d=[{id:"1",name:"1",image:"/voice-actors/actor1.jpg",gender:"女",type:"公有",code:"11"},{id:"1188",name:"1188",image:"/voice-actors/actor2.jpg",gender:"女",type:"公有",code:"8"},{id:"1.1",name:"1.1 dy霸总萧炎",image:"/voice-actors/actor3.jpg",gender:"男",type:"公有",code:"中气十足男声"},{id:"1314",name:"1314",image:"/voice-actors/actor1.jpg",gender:"女",type:"公有",code:"1314"},{id:"2",name:"2",image:"/voice-actors/actor2.jpg",gender:"女",type:"公有",code:"自用"},{id:"2211",name:"2211",image:"/voice-actors/actor3.jpg",gender:"女",type:"公有",code:"1122"}];function u(e){let{isOpen:t,onClose:r,onSelect:n}=e,[a,i]=(0,l.useState)("全部"),[u,m]=(0,l.useState)(""),[x,h]=(0,l.useState)(!1),g=(0,l.useRef)(null);(0,l.useEffect)(()=>{let e=e=>{g.current&&!g.current.contains(e.target)&&r()};return t&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[t,r]);let p=d.filter(e=>{let t="全部"===a||"男声"===a&&"男"===e.gender||"女声"===a&&"女"===e.gender,r=""===u||e.name.toLowerCase().includes(u.toLowerCase())||e.code.toLowerCase().includes(u.toLowerCase());return t&&r});return t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-50",onClick:r}),(0,s.jsx)("div",{className:"fixed inset-0 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{ref:g,className:"bg-[var(--bg-primary)] rounded-lg w-[900px] max-w-[90%] max-h-[90vh] shadow-xl overflow-hidden",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center p-4 border-b border-border",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-foreground",children:"选择声优"}),(0,s.jsx)(o.$,{onClick:r,variant:"ghost",size:"icon",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)("input",{type:"text",placeholder:"搜索声优...",value:u,onChange:e=>m(e.target.value),className:"w-full bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md p-3 text-[var(--text-primary)] focus:outline-none input-focus"})}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>h(!x),className:"min-w-[120px] flex items-center justify-between",children:[(0,s.jsx)("span",{children:a}),(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M6 9l6 6 6-6"})})]}),x&&(0,s.jsx)("div",{className:"absolute right-0 top-full mt-1 w-full bg-card rounded-md shadow-lg overflow-hidden z-60",children:(0,s.jsxs)("div",{className:"p-1",children:[(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{i("全部"),h(!1)},children:["全部"===a&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"全部"]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{i("男声"),h(!1)},children:["男声"===a&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"男声"]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{i("女声"),h(!1)},children:["女声"===a&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"女声"]})]})})]})]}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-4 overflow-y-auto max-h-[500px] pr-2",children:p.map(e=>(0,s.jsx)("div",{className:"bg-card rounded-lg overflow-hidden",children:(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsx)("div",{className:"flex justify-center mb-3",children:(0,s.jsx)("div",{className:"relative h-16 w-16 rounded-full overflow-hidden",children:(0,s.jsx)(c.default,{src:e.image,alt:e.name,fill:!0,className:"object-cover"})})}),(0,s.jsxs)("div",{className:"flex items-center justify-center gap-2 mb-2",children:[(0,s.jsx)("h3",{className:"text-foreground font-medium",children:e.name}),(0,s.jsx)("span",{className:"bg-accent text-xs text-accent-foreground px-1 py-0.5 rounded",children:e.type})]}),(0,s.jsx)("div",{className:"text-center text-sm text-muted-foreground mb-3",children:e.code}),(0,s.jsxs)("div",{className:"text-center text-sm text-muted-foreground mb-3",children:["性别: ",e.gender]}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)(o.$,{className:"flex-1",variant:"outline",onClick:()=>n(e),children:"选择"}),(0,s.jsx)(o.$,{variant:"outline",size:"icon",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"}),(0,s.jsx)("path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"})]})})]})]})},e.id))})]})]})})]}):null}var m=r(4752),x=r.n(m),h=r(4149),g=r.n(h);let p=g()(x()),f=[{id:"standard",name:"标准",description:"对话内容清晰流畅，表达平实"},{id:"creative",name:"创意",description:"对话内容富有创意，表达活泼生动"}];function v(e){let{selectedStyle:t,onStyleSelect:r}=e;return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"风格"}),(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>{p.fire({title:"选择对话风格",html:(0,s.jsx)("div",{className:"style-selector-container mt-4",children:f.map(e=>(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-start h-auto py-3 mb-2",onClick:()=>{r(e.name),p.close()},children:[(0,s.jsxs)("div",{className:"flex-1 text-left",children:[(0,s.jsx)("div",{className:"text-sm font-medium",children:e.name}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.description})]}),t===e.name&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]},e.id))}),showConfirmButton:!1,showCloseButton:!0,customClass:{container:"style-dialog-container",popup:"model-dialog-popup",htmlContainer:"model-dialog-html-container p-0"},width:"400px"})},className:"w-full justify-between",children:[(0,s.jsx)("span",{children:t}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]})]})}var b=r(2523),j=r(4540),w=r(6525),y=r(3500);let N=["/backgrounds/bg1.jpg","/backgrounds/bg2.jpg","/backgrounds/bg3.jpg","/backgrounds/bg4.jpg","/backgrounds/bg5.jpg","/backgrounds/bg6.jpg","/backgrounds/bg7.jpg","/backgrounds/bg8.jpg","/backgrounds/bg9.jpg"];function k(e){let{isOpen:t,onClose:r,onBackgroundChange:n,chatTitle:a="故事",onChatTitleChange:d}=e;(0,j.wA)();let{deleteStory:m,currentStoryId:x}=(0,y.R7)();(0,j.d4)(w.st);let[h,g]=(0,l.useState)("1000"),[p,f]=(0,l.useState)(null),[k,C]=(0,l.useState)(!1),[L,E]=(0,l.useState)(null),[S,R]=(0,l.useState)("标准"),[T,O]=(0,l.useState)(a);(0,l.useEffect)(()=>{O(a)},[a]);let M=()=>{T!==a&&d&&d(T),r()},I=e=>{f(e),n&&n(e)},B=async()=>{x?(await (0,i.lJ)({title:'"'.concat(T,'"'),text:"确定要删除吗？",confirmButtonText:"删除",cancelButtonText:"取消"})).isConfirmed&&(m(x),r()):console.error("无法删除故事：未找到当前故事ID")};return t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-50",onClick:M}),(0,s.jsxs)("div",{className:"fixed top-0 right-0 w-80 h-full bg-[var(--bg-primary)] shadow-lg border-l border-border overflow-y-auto z-50 text-foreground p-4 settings-panel",onKeyDown:e=>{e.stopPropagation()},children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"设置"}),(0,s.jsxs)("div",{className:"flex space-x-4",children:[(0,s.jsx)(o.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"}),(0,s.jsx)("polyline",{points:"16 6 12 2 8 6"}),(0,s.jsx)("line",{x1:"12",y1:"2",x2:"12",y2:"15"})]})}),(0,s.jsx)(o.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})})}),(0,s.jsx)(o.$,{variant:"ghost",size:"icon",onClick:M,className:"text-muted-foreground hover:text-foreground",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"故事标题"}),(0,s.jsx)(b.p,{type:"text",value:T,onChange:e=>{O(e.target.value)}})]}),(0,s.jsxs)("div",{className:"pt-1",children:[(0,s.jsxs)(o.$,{variant:"outline",className:"w-full flex items-center justify-center",onClick:B,children:[(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,s.jsx)("polyline",{points:"3 6 5 6 21 6"}),(0,s.jsx)("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),"删除故事"]}),(0,s.jsx)("div",{className:"mt-6 border-t border-border"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"最大回复Token数量"}),(0,s.jsx)(b.p,{type:"text",value:h,onChange:e=>g(e.target.value)})]}),(0,s.jsx)(v,{selectedStyle:S,onStyleSelect:e=>{R(e)}}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("label",{className:"text-sm block",children:"背景图片"}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-2",children:N.map((e,t)=>(0,s.jsx)("div",{className:"relative h-20 w-full rounded-md overflow-hidden cursor-pointer border-2 ".concat(p===e?"border-primary":"border-transparent"),onClick:()=>I(e),children:(0,s.jsx)(c.default,{src:e,alt:"背景".concat(t+1),fill:!0,className:"object-cover"})},t))})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"自定义背景"}),(0,s.jsxs)("label",{className:"flex items-center justify-center p-2 bg-muted border border-border rounded-md cursor-pointer hover:bg-border",children:[(0,s.jsx)("span",{className:"text-foreground",children:"选择文件"}),(0,s.jsx)("input",{type:"file",className:"hidden",accept:"image/*",onChange:e=>{e.target.files&&e.target.files[0]&&I(URL.createObjectURL(e.target.files[0]))},onKeyDown:e=>{"Escape"===e.key&&e.stopPropagation()}})]})]})]})]}),(0,s.jsx)(u,{isOpen:k,onClose:()=>C(!1),onSelect:e=>{E(e),C(!1)}})]}):null}var C=r(6874),L=r.n(C),E=r(1394);function S(e){let{activeStoryId:t,isOpen:r=!0,onClose:n,searchMode:a=!1}=e,[o,i]=(0,l.useState)(""),[c,d]=(0,l.useState)(!1),[u,m]=(0,l.useState)(!1),x=(0,l.useRef)(null),[h,g]=(0,l.useState)(!0),{stories:p,isLoading:f,error:v,fetchStories:b}=(0,y.R7)();(0,l.useEffect)(()=>{p.length>0&&g(!1)},[p]),(0,l.useEffect)(()=>{let e=setTimeout(()=>{h&&0===p.length&&(console.log("StorySidebar: loading timeout, forcing end of loading state"),g(!1))},3e3);return()=>clearTimeout(e)},[h,p.length]),(0,l.useEffect)(()=>{},[b]);let j=e=>{if(!e)return{date:"",time:""};let t=new Date(e);return{date:"".concat(t.getMonth()+1,"-").concat(t.getDate()),time:t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}},w=o?p.filter(e=>{var t;if(e.title&&e.title.toLowerCase().includes(o.toLowerCase()))return!0;let r="string"==typeof e.lastMessage?e.lastMessage:null==(t=e.lastMessage)?void 0:t.content;return!!(r&&r.toLowerCase().includes(o.toLowerCase()))}):p,N=()=>{n&&n()},k=()=>{i(""),m(!1),x.current&&x.current.focus()};(0,l.useEffect)(()=>{if(r&&window.innerWidth<768||r&&a){let e=setTimeout(()=>{var e;null==(e=x.current)||e.focus()},300);return()=>clearTimeout(e)}},[r,a]);let C=e=>{let{story:r}=e,{avatarUrl:l,characterName:n,lastMessage:a,lastMessageAt:o,title:i}=r,c=j(o?new Date(o):Date.now());return(0,s.jsxs)(L(),{href:"/chat?storyId=".concat(r.id),onClick:N,className:"flex items-center p-4 hover:bg-muted ".concat(r.id===t?"bg-muted":""),children:[(0,s.jsx)("div",{className:"relative h-10 w-10 rounded-full overflow-hidden mr-3",children:(0,s.jsxs)(E.eu,{className:"h-full w-full",children:[(0,s.jsx)(E.BK,{src:l,alt:i||"",className:"object-cover"}),(0,s.jsx)(E.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==i?void 0:i.charAt(0).toUpperCase())||"S"})]})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("div",{className:"text-foreground font-medium truncate",children:i||"未命名"}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:c.time})]}),(0,s.jsx)("div",{className:"text-sm text-muted-foreground truncate",children:"string"==typeof a?a:(null==a?void 0:a.content)||"无消息"}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:c.date})]})]})};return(0,s.jsxs)("div",{className:"\n        ".concat(r?"translate-x-0":"-translate-x-full","\n        fixed md:relative md:translate-x-0\n        w-[280px] md:w-72 h-full bg-[var(--bg-primary)] border-r border-border flex flex-col\n        transition-transform duration-300 ease-in-out z-30\n      "),children:[(0,s.jsxs)("div",{className:"p-4 border-b border-border flex items-center ".concat(a?"bg-muted/50":""),children:[(0,s.jsxs)("div",{className:"relative flex-1 ".concat(c||a?"ring-1 ring-border rounded-md":""),children:[(0,s.jsx)("input",{ref:x,type:"text",value:o,onChange:e=>{let t=e.target.value;i(t),t?(m(!0),setTimeout(()=>{m(!1)},300)):m(!1),t.length},onFocus:()=>d(!0),onBlur:()=>d(!1),placeholder:a?"搜索聊天...":"搜索",className:"w-full bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md p-2 pl-9 text-[var(--text-primary)] focus:outline-none input-focus","aria-label":"搜索聊天"}),(0,s.jsx)("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 text-muted-foreground",children:u?(0,s.jsxs)("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),o&&(0,s.jsx)("button",{onClick:k,className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground","aria-label":"清除搜索",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),(0,s.jsx)("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]})})]}),(0,s.jsx)("button",{onClick:n,className:"ml-2 text-muted-foreground hover:text-foreground p-2 md:hidden","aria-label":"关闭侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar scrollbar-thin scrollbar-track-background scrollbar-thumb-border hover:scrollbar-thumb-border/80",children:h?(0,s.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,s.jsxs)("svg",{className:"animate-spin h-8 w-8 text-foreground",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):o&&0===w.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"未找到结果"}),(0,s.jsxs)("p",{className:"text-muted-foreground mt-2 mb-4",children:['没有找到与"',o,'"相关的聊天']}),(0,s.jsx)("button",{onClick:k,className:"px-4 py-2 bg-primary text-foreground rounded-md transition-colors",children:"清除搜索"})]}):0===w.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),(0,s.jsx)("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"暂无聊天记录"}),(0,s.jsx)("p",{className:"text-muted-foreground mt-2",children:"开始与角色聊天创建新的故事"})]}):w.map(e=>(0,s.jsx)(C,{story:e},e.id))}),r&&(0,s.jsx)("div",{className:"fixed inset-0 bg-background/70 z-20 md:hidden",onClick:n,"aria-hidden":"true"})]})}var R=r(4165);function T(e){let{isOpen:t,onClose:r,title:l,onTitleChange:n,onStoryCreated:a,isCreating:i}=e;return(0,s.jsx)(R.lG,{open:t,onOpenChange:r,children:(0,s.jsxs)(R.Cf,{className:"bg-opacity-90 bg-[var(--bg-primary)] backdrop-blur-sm z-150",children:[(0,s.jsx)(R.c7,{children:(0,s.jsx)(R.L3,{children:"创建新故事"})}),(0,s.jsxs)("div",{className:"py-4",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"故事标题"}),(0,s.jsx)(b.p,{value:l,onChange:e=>n(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"输入故事标题",autoFocus:!0})]}),(0,s.jsxs)(R.Es,{children:[(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:r,children:"取消"}),(0,s.jsx)(o.$,{onClick:a,variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:i||!l.trim(),children:i?"创建中...":"创建故事"})]})]})})}var O=r(2045),M=r(1795),I=r(4421),B=r(8578),_=r(3315);let A=l.forwardRef(function(e,t){let{title:r,titleId:s,...n}=e;return l.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":s},n),r?l.createElement("title",{id:s},r):null,l.createElement("path",{fillRule:"evenodd",d:"M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z",clipRule:"evenodd"}))}),D=l.forwardRef(function(e,t){let{title:r,titleId:s,...n}=e;return l.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":s},n),r?l.createElement("title",{id:s},r):null,l.createElement("path",{fillRule:"evenodd",d:"M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z",clipRule:"evenodd"}))});var U=r(3096),z=r(795),W=r(3655),P=l.forwardRef((e,t)=>(0,s.jsx)(W.sG.label,{...e,ref:t,onMouseDown:t=>{var r;t.target.closest("button, input, select, textarea")||(null==(r=e.onMouseDown)||r.call(e,t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}}));P.displayName="Label";var F=r(2085),$=r(9434);let H=(0,F.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),G=l.forwardRef((e,t)=>{let{className:r,...l}=e;return(0,s.jsx)(P,{ref:t,className:(0,$.cn)(H(),r),...l})});function V(e){let{isOpen:t,onClose:r,storyId:n,onShareStory:a}=e,[i,c]=(0,l.useState)(""),[d,u]=(0,l.useState)(""),[m,x]=(0,l.useState)(!0),[h,g]=(0,l.useState)(!0),[p,f]=(0,l.useState)(!1),[v,j]=(0,l.useState)(null),[w,y]=(0,l.useState)(!1),N=async()=>{f(!0);try{let e={originalStoryId:n,title:i||void 0,description:d||void 0,visibility:m?I.gu.PUBLIC:I.gu.UNLISTED,allowForking:h},t=await a(e);if(t&&t.slug){let e=window.location.origin,r="".concat(e,"/character/dialogue/?slug=").concat(t.slug);j(r)}}catch(e){console.error("Failed to share story:",e)}finally{f(!1)}},k=()=>{p||(j(null),c(""),u(""),x(!0),g(!0),y(!1),r())};return(0,s.jsx)(R.lG,{open:t,onOpenChange:k,children:(0,s.jsxs)(R.Cf,{className:"bg-opacity-90 bg-background backdrop-blur-sm z-150",children:[(0,s.jsx)(R.c7,{children:(0,s.jsx)(R.L3,{children:"分享故事"})}),v?(0,s.jsxs)("div",{className:"py-4 space-y-4",children:[(0,s.jsx)("p",{className:"text-sm text-[var(--text-secondary)]",children:"故事已成功分享! 您可以复制以下链接分享给他人:"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(b.p,{value:v,readOnly:!0,className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus flex-1"}),(0,s.jsxs)(o.$,{onClick:()=>{v&&navigator.clipboard.writeText(v).then(()=>{y(!0),setTimeout(()=>y(!1),2e3)}).catch(e=>{console.error("无法复制到剪贴板:",e)})},variant:"outline",className:"flex items-center gap-2 bg-[var(--bg-secondary)] border-[var(--border-color)]",children:[(0,s.jsx)(U.DDb,{className:"h-4 w-4"}),w?(0,s.jsx)("span",{className:"text-xs",children:"已复制"}):null]})]}),(0,s.jsx)(R.Es,{children:(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:k,children:"关闭"})})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"py-4 space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(G,{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"故事标题 (可选)"}),(0,s.jsx)(b.p,{value:i,onChange:e=>c(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"保持为空以使用原始故事标题"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)(G,{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"描述 (可选)"}),(0,s.jsx)(b.p,{value:d,onChange:e=>u(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"添加故事描述"})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)(G,{className:"text-sm font-medium text-[var(--text-secondary)]",children:"公开分享"}),(0,s.jsx)(z.d,{checked:m,onCheckedChange:x})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)(G,{className:"text-sm font-medium text-[var(--text-secondary)]",children:"允许其他用户衍生"}),(0,s.jsx)(z.d,{checked:h,onCheckedChange:g})]})]}),(0,s.jsxs)(R.Es,{children:[(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:k,children:"取消"}),(0,s.jsx)(o.$,{onClick:N,variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:p,children:p?"分享中...":"分享故事"})]})]})]})})}G.displayName=P.displayName;var q=r(9371),K=r(298),Q=r(8613),Z=r(5844);let X=g()(x());function J(){let e=(0,j.wA)(),t=(0,j.d4)(w.OD),r=(0,j.d4)(w.rN),n=(0,j.d4)(w.st);(0,l.useEffect)(()=>{"idle"===n&&e((0,Z.ZC)())},[e,n]);let a=t=>{e((0,Z.xH)(t))};return(0,s.jsx)("div",{className:"space-y-2",children:(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>{X.fire({title:"选择模型",html:(0,s.jsx)("div",{className:"model-selector-container max-h-[400px] overflow-y-auto mt-4",children:"loading"===n?(0,s.jsx)("div",{className:"flex items-center justify-center w-full p-4",children:(0,s.jsx)("span",{className:"animate-pulse",children:"加载中..."})}):"succeeded"===n?(0,s.jsx)("div",{children:t.map((e,t)=>(0,s.jsxs)("div",{className:"border-b border-border last:border-b-0 mb-2",children:[e.title&&(0,s.jsx)("div",{className:"text-xs text-muted-foreground p-2 bg-card",children:e.title}),(0,s.jsx)("div",{className:"p-1",children:e.models.map((e,l)=>(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-start h-auto py-2",onClick:()=>{a(e),X.close()},children:[(0,s.jsx)("div",{className:"w-8 h-8 ".concat(e.icon," rounded-md flex items-center justify-center mr-2 flex-shrink-0"),children:(0,s.jsx)("span",{className:"text-foreground text-xs",children:"AI"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,s.jsx)("div",{className:"text-sm text-foreground",children:e.name}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.description}),(0,s.jsxs)("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[(0,s.jsx)("span",{children:e.price}),e.freeQuota&&(0,s.jsxs)("span",{className:"text-accent-foreground",children:["剩余免费次数: ",e.freeQuota]})]})]}),r&&r.id===e.id&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]},"".concat(t,"-").concat(l)))})]},t))}):(0,s.jsx)("div",{className:"text-center p-4",children:(0,s.jsx)("p",{children:"加载模型失败"})})}),showConfirmButton:!1,showCloseButton:!0,customClass:{container:"model-dialog-container",popup:"model-dialog-popup",htmlContainer:"model-dialog-html-container p-0"},width:"500px"})},className:"w-full justify-between",disabled:"succeeded"!==n,children:["loading"===n?(0,s.jsx)("div",{className:"flex items-center justify-center w-full",children:(0,s.jsx)("span",{className:"animate-pulse",children:"加载中..."})}):r?(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"w-8 h-8 ".concat(r.icon," rounded-md flex items-center justify-center mr-2"),children:(0,s.jsx)("span",{className:"text-foreground text-xs",children:"AI"})}),(0,s.jsx)("div",{className:"flex-1 text-left",children:(0,s.jsx)("div",{className:"text-sm",children:r.name})})]}):(0,s.jsx)("span",{children:"选择模型"}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]})})}function Y(e){var t;let{character:r,error:a,clearError:c}=e,d=(0,n.useRouter)(),[u,m]=(0,l.useState)(""),[x,h]=(0,l.useState)(!1),[g,p]=(0,l.useState)(""),[f,v]=(0,l.useState)(!1),[b,j]=(0,l.useState)(!1),w=(0,O.G)(M.xu),N=(0,O.G)(M.vc),[C,L]=(0,l.useState)(!1),[R,z]=(0,l.useState)(null),[W,P]=(0,l.useState)(!1),[F,$]=(0,l.useState)(!1),[H,G]=(0,l.useState)(!0),[Z,X]=(0,l.useState)("fade-in-up"),Y=(0,l.useRef)(null),ee=(0,l.useRef)(null),[et,er]=(0,l.useState)(0),es=(0,O.j)(),[el,en]=(0,l.useState)(!1),{currentStoryId:ea,currentCharacterId:eo,messages:ei,isLoading:ec,isSending:ed,error:eu,sendMessage:em,addMessage:ex,sendStreamMessage:eh,fetchCurStoryHistory:eg}=(0,y.Z3)(),{createStory:ep,fetchStories:ef,updateStoryTitle:ev}=(0,y.R7)(),{tempContext:eb,initTempContext:ej,updateTempTitle:ew}=(0,y.ki)(),{formatChat:ey}=(0,_.L)(),eN=(0,O.G)(K.jQ),[ek,eC]=(0,l.useState)(""),{getAssetBalanceByCode:eL,fetchWallet:eE}=(0,Q.vT)();(0,l.useEffect)(()=>{eN&&eN.title?eC(eN.title):b&&eb&&eb.title?eC(eb.title):eC("")},[eN,b,eb]);let eS=b&&eb?eb.messages:ei,eR=async e=>{if(e!==ek){eC(e);try{ea?await ev(ea,e)||console.error("Failed to update story title"):b&&eb&&ew(e)}catch(e){console.error("Error updating story title:",e)}}},eT=(0,l.useCallback)(e=>{let t=window.innerWidth<768;if(C||x||el)return;let r=e.target;r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement||r instanceof HTMLSelectElement||r.isContentEditable||"BUTTON"===r.tagName||("/"===e.key||e.ctrlKey&&"f"===e.key?(e.preventDefault(),t?eI():P(!0)):"Escape"===e.key&&W&&(e.preventDefault(),eB()))},[W,C,x,el]);(0,l.useEffect)(()=>(window.addEventListener("keydown",eT),()=>{window.removeEventListener("keydown",eT)}),[eT]),(0,l.useEffect)(()=>{r&&!ea&&(ej(r),er(0))},[ef,r,ea,ej]),(0,l.useEffect)(()=>{eE()},[eE]),(0,l.useEffect)(()=>{!ea&&eo?j(!0):ea&&eo?j(!1):(console.error("currentStoryId",ea),console.error("currentCharacterId",eo))},[ea,eo]),(0,l.useEffect)(()=>{Y.current&&Y.current.scrollIntoView({behavior:"smooth"})},[ei,eS]),(0,l.useEffect)(()=>{if(console.log("isSending 滚动到最新消息",ed),ed){Y.current&&Y.current.scrollIntoView({behavior:"smooth"});let e=setTimeout(()=>{Y.current&&(Y.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 延迟500ms"))},500),t=setTimeout(()=>{Y.current&&(Y.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 延迟1500ms"))},1500);return()=>{clearTimeout(e),clearTimeout(t)}}if(!1===ed){let e=setTimeout(()=>{Y.current&&(Y.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 发送完成"))},300);return()=>clearTimeout(e)}},[ed]),(0,l.useEffect)(()=>{if(H){let e=setTimeout(()=>{X("fade-out-down"),setTimeout(()=>{G(!1)},300)},5e3);return()=>clearTimeout(e)}},[H]),(0,l.useEffect)(()=>{let e=()=>{X("fade-out-down"),setTimeout(()=>{G(!1)},300)};return window.addEventListener("click",e),window.addEventListener("touchstart",e),()=>{window.removeEventListener("click",e),window.removeEventListener("touchstart",e)}},[]),(0,l.useEffect)(()=>{if(x&&r){let e=(null==w?void 0:w.username)||"用户";p("".concat(e,"和").concat(r.name,"的浪漫故事"))}},[x,w,r]),(0,l.useEffect)(()=>{if(a){let e=setTimeout(()=>{c()},5e3);return()=>clearTimeout(e)}},[a,c]);let eO=()=>{if(u.trim()&&r&&!(u.length>1e3)){if(10>eL("SCORE"))return void(0,i.lJ)({title:"余额不足",text:"您的SCORE余额不足，需要至少10分才能发送消息。是否前往充值？",confirmButtonText:"去充值",cancelButtonText:"取消"}).then(e=>{e.isConfirmed&&d.push("/profile")});Y.current&&Y.current.scrollIntoView({behavior:"smooth"}),ex({storyId:ea,characterId:r.id,contentType:I._8.TEXT,content:u}).then(e=>{e&&(em(e),m(""),setTimeout(()=>{Y.current&&Y.current.scrollIntoView({behavior:"smooth"})},100))}).catch(e=>{eE(),i.oR.error((null==e?void 0:e.message)||"发送消息失败，请稍后再试")})}},eM=async()=>{if(g.trim()&&r){if(!b)return void console.error("isCharaterMode",b);v(!0);try{let e=eS.map((e,t)=>({content:e.content,contentType:e.contentType,index:t,metadata:e.metadata||{}})),t={characterId:r.id,title:g,initialMessages:e};await ep(t)&&(ef(),m(""))}catch(e){console.error("Failed to create story:",e)}finally{v(!1),h(!1)}}},eI=()=>{P(!0),$(!0)},eB=()=>{P(!1),$(!1)},e_=async e=>{try{return{slug:(await q.a.createShareStory(e)).slug}}catch(e){throw console.error("Failed to share story:",e),e}};return r?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"pt-16 flex h-[calc(100vh-4rem)]",children:[(0,s.jsx)(S,{activeStoryId:ea||"",isOpen:W,onClose:eB,searchMode:F}),(0,s.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden relative w-full z-0",children:[(0,s.jsxs)("div",{className:"bg-card p-3 sm:p-4 flex items-center border-b border-border",children:[(0,s.jsx)("button",{onClick:()=>P(!0),className:"mr-3 text-foreground p-1 md:hidden","aria-label":"打开侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),(0,s.jsx)("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),(0,s.jsx)("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),(0,s.jsx)("div",{className:"flex-1 min-w-0",children:(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)(J,{}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:eI,className:"text-foreground p-2 rounded-full hover:bg-muted transition-colors md:hidden","aria-label":"搜索聊天",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),(0,s.jsx)("button",{onClick:()=>L(!0),className:"text-foreground p-2 rounded-full hover:bg-muted transition-colors","aria-label":"设置",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})]})]})})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4 bg-background relative z-5",style:R?{backgroundImage:"url(".concat(R,")"),backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:{},children:[R&&(0,s.jsx)("div",{className:"absolute inset-0 bg-background z-0"}),(0,s.jsx)("div",{className:"mx-auto w-full relative z-5",style:{maxWidth:"1800px"},children:(0,s.jsxs)("div",{className:"space-y-3 sm:space-y-4 relative z-5",children:[eS.map((e,t)=>{var l,n;return(0,s.jsxs)("div",{className:"flex ".concat(e.role===I.hE.USER?"justify-end":"justify-start"),children:[e.role!==I.hE.USER&&(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(E.eu,{className:"h-full w-full",children:[(0,s.jsx)(E.BK,{src:r.avatarUrl,alt:r.name,className:"object-cover",shouldBlur:r.shouldBlurAvatar}),(0,s.jsx)(E.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(l=r.name)?void 0:l.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsxs)("div",{className:"max-w-[80%] sm:max-w-[70%] rounded-lg p-2 sm:p-3 flex flex-col ".concat(e.role===I.hE.USER?"border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)]":"bg-card text-foreground"),children:[(0,s.jsx)("div",{className:"whitespace-pre-wrap text-sm sm:text-base [&_pre]:overflow-x-auto [&_pre]:whitespace-pre-wrap [&_pre]:word-wrap-break-word [&_code]:break-words",dangerouslySetInnerHTML:{__html:ey(e.content,r.name,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString()})}}),(0,s.jsx)("p",{className:"text-[10px] sm:text-xs opacity-70 mt-1 self-end",children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),b&&eb&&0===t&&e.role===I.hE.ASSISTANT&&r.greetings&&r.greetings.length>1&&(0,s.jsxs)("div",{className:"flex items-center mt-2 self-center space-x-1",children:[(0,s.jsx)("button",{onClick:()=>{let e=0===et?r.greetings.length-1:et-1;er(e),es((0,B.XB)({newGreeting:r.greetings[e]}))},className:"p-1 rounded-full hover:bg-muted transition-colors","aria-label":"Previous greeting",children:(0,s.jsx)(A,{className:"h-4 w-4 text-foreground"})}),(0,s.jsx)("span",{className:"text-xs text-muted-foreground",children:"".concat(et+1," / ").concat(r.greetings.length)},"greeting-counter-".concat(et)),(0,s.jsx)("button",{onClick:()=>{let e=et===r.greetings.length-1?0:et+1;er(e),es((0,B.XB)({newGreeting:r.greetings[e]}))},className:"p-1 rounded-full hover:bg-muted transition-colors","aria-label":"Next greeting",children:(0,s.jsx)(D,{className:"h-4 w-4 text-foreground"})})]})]}),e.role===I.hE.USER&&(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 ml-2",children:(0,s.jsxs)(E.eu,{className:"h-full w-full",children:[(0,s.jsx)(E.BK,{src:N,alt:(null==w?void 0:w.username)||"用户",className:"object-cover"}),(0,s.jsx)(E.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==w||null==(n=w.username)?void 0:n.charAt(0).toUpperCase())||"U"})]})})]},e.id)}),ed&&(0,s.jsxs)("div",{className:"flex justify-start",children:[(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(E.eu,{className:"h-full w-full",children:[(0,s.jsx)(E.BK,{src:r.avatarUrl,alt:r.name,className:"object-cover",shouldBlur:r.shouldBlurAvatar}),(0,s.jsx)(E.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(t=r.name)?void 0:t.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsx)("div",{className:"bg-card text-foreground rounded-lg p-2 sm:p-3 max-w-[80%] sm:max-w-[70%]",children:(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.2s"}}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.4s"}})]})})]}),(0,s.jsx)("div",{ref:Y})]})})]}),(0,s.jsx)("div",{className:"bg-background relative z-20",children:(0,s.jsxs)("div",{className:"mx-auto w-full",style:{maxWidth:"1800px"},children:[a&&(0,s.jsx)("div",{className:"px-3 py-2 bg-destructive/50 text-destructive-foreground rounded-md text-sm mx-2 sm:mx-4 mt-2 sm:mt-3",children:(0,s.jsx)("p",{children:a})}),(0,s.jsx)("div",{className:"flex justify-center items-center p-2 sm:p-4",children:(0,s.jsxs)("div",{className:"relative flex items-center w-full",children:[(0,s.jsx)("button",{className:"absolute left-3 sm:left-4 text-primary/70 hidden sm:block",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{d:"M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"})})}),!ea&&(null==r?void 0:r.id)?(0,s.jsx)("button",{onClick:()=>{h(!0)},className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 sm:pl-12 pr-12 sm:pr-16 py-2 sm:py-3 text-sm sm:text-base text-[var(--text-primary)] focus:outline-none hover:bg-[var(--bg-tertiary)]/90 transition-colors",children:"创建故事"}):(0,s.jsx)("textarea",{ref:ee,value:u,onChange:e=>{m(e.target.value),e.target.value.length>1e3||a&&e.target.value.length<=1e3&&c()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eO())},placeholder:"输入消息 (Shift+Enter 换行)",className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 sm:pl-12 pr-24 sm:pr-28 py-2 sm:py-3 text-sm sm:text-base text-[var(--text-primary)] focus:outline-none input-focus resize-none scrollbar scrollbar-thin scrollbar-track-[var(--bg-secondary)] scrollbar-thumb-[var(--primary)]/20 hover:scrollbar-thumb-[var(--primary)]/40",rows:1}),ea&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{className:"absolute right-12 sm:right-14 bg-[var(--primary)] h-7 w-7 sm:h-8 sm:w-8 rounded-full flex items-center justify-center hover:bg-[var(--primary-hover)]",onClick:eO,disabled:ed||u.length>1e3||""===u.trim(),children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-primary-foreground",children:[(0,s.jsx)("path",{d:"M22 2L11 13"}),(0,s.jsx)("path",{d:"M22 2L15 22L11 13L2 9L22 2Z"})]})}),(0,s.jsx)("button",{className:"absolute right-3 sm:right-4 bg-[var(--bg-tertiary)] h-7 w-7 sm:h-8 sm:w-8 rounded-full flex items-center justify-center border border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]/90",onClick:()=>en(!0),disabled:ed,"aria-label":"分享故事",children:(0,s.jsx)(U.qfV,{className:"h-4 w-4 text-[var(--text-primary)]"})})]})]})})]})})]}),H&&!W&&!C&&(0,s.jsx)("div",{className:"fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-card text-foreground px-4 py-2 rounded-lg shadow-lg text-sm md:hidden z-10 ".concat("fade-in-up"===Z?"animate-fade-in-up":"animate-fade-out-down"),children:(0,s.jsx)("p",{children:'提示: 按 "/" 键快速搜索'})}),(0,s.jsx)(k,{isOpen:C,onClose:()=>L(!1),onBackgroundChange:e=>{z(e)},chatTitle:ek,onChatTitleChange:eR})]}),x&&(0,s.jsx)(T,{isOpen:x,onClose:()=>h(!1),title:g,onTitleChange:p,onStoryCreated:eM,isCreating:f}),el&&ea&&(0,s.jsx)(V,{isOpen:el,onClose:()=>en(!1),storyId:ea,onShareStory:e_})]}):(0,s.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"角色不存在"}),(0,s.jsx)("p",{className:"mb-8",children:"无法找到该角色，请返回角色库选择其他角色。"}),(0,s.jsx)(o.$,{className:"bg-primary text-foreground",onClick:()=>d.push("/characters"),children:"返回角色库"})]})}var ee=r(2847);function et(){return(0,s.jsxs)("main",{className:"min-h-screen bg-background relative",children:[(0,s.jsx)(a.default,{}),(0,s.jsx)(l.Suspense,{fallback:(0,s.jsx)(er,{}),children:(0,s.jsx)(es,{})})]})}function er(){return(0,s.jsxs)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:[(0,s.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-primary motion-reduce:animate-[spin_1.5s_linear_infinite]",children:(0,s.jsx)("span",{className:"sr-only",children:"Loading..."})}),(0,s.jsx)("p",{className:"ml-3 text-foreground",children:"正在加载聊天数据..."})]})}function es(){let e=(0,n.useRouter)(),t=(0,n.useSearchParams)(),r=null==t?void 0:t.get("characterId"),a=null==t?void 0:t.get("storyId"),[o,i]=(0,l.useState)(null),{clearCurrentStoryContext:c}=(0,y.w0)(),{currentUser:d}=(0,Q.Jd)(),{currentCharacter:u,isLoading:m,error:x}=(0,ee.OE)(),{fetchCharacterById:h}=(0,ee.MM)(),{fetchStoryToCurStoryContext:g,isLoading:p,fetchStories:f,currentStoryId:v}=(0,y.R7)(),{error:b,clearErrors:j,isLoading:w,currentStory:N,fetchCurStoryHistory:k}=(0,y.Z3)();return((0,l.useEffect)(()=>{console.log("Effect: Fetch stories triggered"),d&&f()},[d,f]),(0,l.useEffect)(()=>{console.log("Effect: Fetch story context triggered, storyId:",a),a?g(a):c()},[a,g,c]),(0,l.useEffect)(()=>{let e=null==N?void 0:N.characterId;console.log("Effect: Fetch character and history for story triggered, charId:",e),e&&(h(e),k(0,30))},[null==N?void 0:N.characterId,h,k]),(0,l.useEffect)(()=>{console.log("Effect: Fetch character by URL ID triggered, characterId:",r,"storyId:",a),r&&!a&&h(r)},[r,a,h]),w||m||p)?(0,s.jsx)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:(0,s.jsx)("span",{className:"text-foreground",children:"正在加载聊天数据..."})}):u?(0,s.jsx)(Y,{character:u,error:o||x||b,clearError:j}):(0,s.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"正在加载角色..."}),(0,s.jsx)("p",{className:"mb-8",children:"请稍候，如果长时间未响应或角色不存在，请返回角色库选择其他角色。"}),(0,s.jsx)("button",{className:"bg-primary/20 hover:bg-primary/30 px-4 py-2 rounded",onClick:()=>e.push("/characters"),children:"返回角色库"})]})}},3315:(e,t,r)=>{"use strict";r.d(t,{L:()=>x});var s=r(2115),l=r(822),n=r(9161),a=r.n(n),o=function(e){return e.ENGLISH="ENGLISH",e.CURLY="CURLY",e.GUILLEMETS="GUILLEMETS",e.CORNER="CORNER",e.WHITE_CORNER="WHITE_CORNER",e.FULLWIDTH="FULLWIDTH",e}(o||{}),i=function(e){return e[e.USER_INPUT=0]="USER_INPUT",e[e.AI_OUTPUT=1]="AI_OUTPUT",e[e.SLASH_COMMAND=2]="SLASH_COMMAND",e[e.WORLD_INFO=3]="WORLD_INFO",e[e.AUTHOR_NOTE=4]="AUTHOR_NOTE",e[e.INSTRUCT=5]="INSTRUCT",e[e.RAW_INPUT=6]="RAW_INPUT",e[e.REPLACEMENT=7]="REPLACEMENT",e[e.REASONING=8]="REASONING",e}({});class c{setVariable(e,t){this.environment[e]=t}addRegexRule(e){this.regexRules.push(e)}format(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return"";let r=this.substituteVariables(e);if(r=this.applyRegexRules(r,1,t),r=this.processQuotes(r),!1!==t.isMarkdown&&(r=this.convertMarkdown(r)),r=this.encodeStyleTags(r),!t.skipSanitize){let e={ALLOWED_TAGS:["div","span","a","p","br","strong","em","b","i","ul","ol","li","code","pre","blockquote","q","img","h1","h2","h3","h4","h5","h6","table","thead","tbody","tr","th","td","hr","del","ins","mark","custom-style","sup","sub"],ALLOWED_ATTR:["href","src","class","style","title","alt","target","rel","id","width","height"],ADD_TAGS:["custom-style"],ADD_ATTR:["target","rel"],FORBID_TAGS:["style","script"],FORBID_ATTR:["onerror","onload","onclick"]};t.allowUnsafeHTML&&(e.ALLOW_UNKNOWN_PROTOCOLS=!0,e.ALLOW_ARIA_ATTR=!0);let s=l.A.sanitize(r,e);r="string"==typeof s?s:String(s)}return this.decodeStyleTags(r)}substituteVariables(e){var t,r;if(!e)return"";let s=e;for(let e in this.environment)if(Object.prototype.hasOwnProperty.call(this.environment,e)){let t=this.environment[e],r=RegExp("{{".concat(this.escapeRegex(e),"}}"),"gi");s=s.replace(r,"function"==typeof t?t():t.toString())}return(s=s.replace(/<USER>/gi,(null==(t=this.environment.user)?void 0:t.toString())||"")).replace(/<CHAR>/gi,(null==(r=this.environment.char)?void 0:r.toString())||"")}applyRegexRules(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e||0===this.regexRules.length)return e;let s=e;for(let e of this.regexRules.filter(e=>!e.disabled&&e.placement.includes(t)&&(!e.markdownOnly&&!e.promptOnly||e.markdownOnly&&r.isMarkdown||e.promptOnly&&r.isPrompt)&&(!r.isEdit||!1!==e.runOnEdit)&&(void 0===r.depth||void 0===e.minDepth||r.depth>=e.minDepth)&&(void 0===r.depth||void 0===e.maxDepth||r.depth<=e.maxDepth)))try{let t=RegExp(e.find,"g");s="string"==typeof e.replace?s.replace(t,e.replace):s.replace(t,function(t){for(var r=arguments.length,s=Array(r>1?r-1:0),l=1;l<r;l++)s[l-1]=arguments[l];return(0,e.replace)(t,...s)})}catch(t){console.error('正则表达式规则 "'.concat(e.name,'" 应用失败:'),t)}return s}processQuotes(e){return e?e=(e=(e=e.replace(/<([^>]+)>/g,(e,t)=>"<"+t.replace(/"/g,"￾")+">")).replace(/```[\s\S]*?```|``[\s\S]*?``|`[\s\S]*?`|(".*?")|(\u201C.*?\u201D)|(\u00AB.*?\u00BB)|(\u300C.*?\u300D)|(\u300E.*?\u300F)|(\uFF02.*?\uFF02)/gm,(e,t,r,s,l,n,a)=>{if(t)return'<q>"'.concat(t.slice(1,-1),'"</q>');if(r)return'<q>"'.concat(r.slice(1,-1),'"</q>');if(s)return"<q>\xab".concat(s.slice(1,-1),"\xbb</q>");if(l)return"<q>「".concat(l.slice(1,-1),"」</q>");if(n)return"<q>『".concat(n.slice(1,-1),"』</q>");else if(a)return"<q>＂".concat(a.slice(1,-1),"＂</q>");else return e})).replace(/\ufffe/g,'"'):""}convertMarkdown(e){if(!e)return"";e=(e=e.replaceAll("\\begin{align*}","$$")).replaceAll("\\end{align*}","$$");let t=this.converter.makeHtml(e);return(t=(t=(t=(t=t.replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/\n/gm,"\0"))).replace(/\u0000/g,"\n")).replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/&amp;/g,"&"))).replace(/<pre><code(.*?)>([\s\S]*?)<\/code><\/pre>/g,(e,t,r)=>'<pre style="overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code'.concat(t,">").concat(r,"</code></pre>"))).trim()}encodeStyleTags(e){return e?e.replace(/<style>([^]*?)<\/style>/g,(e,t)=>"<custom-style>".concat(escape(t),"</custom-style>")):""}decodeStyleTags(e){return e?e.replace(/<custom-style>([^]*?)<\/custom-style>/g,(e,t)=>{try{let e=unescape(t).replace(/<br\/>/g,"");return"<style>".concat(e,"</style>")}catch(e){return"CSS ERROR: ".concat(e)}}):""}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}formatWithRegexOnly(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.applyRegexRules(e,t,r)}substituteOnly(e){return this.substituteVariables(e)}processQuotesOnly(e){return this.processQuotes(e)}markdownOnly(e){return this.convertMarkdown(e)}constructor(e={},t=[]){this.regexRules=[],this.environment={},this.environment=e,this.regexRules=t,this.converter=new(a()).Converter({tables:!0,simpleLineBreaks:!0,strikethrough:!0,literalMidWordUnderscores:!0,tasklists:!0,smoothLivePreview:!0,smartIndentationFix:!0}),this.converter.setOption("openLinksInNewWindow",!0),this.converter.setOption("ghMentions",!1),this.converter.setOption("emoji",!0)}}new c;let d=new c;function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))d.setVariable(e,r);return d.format(e)}d.addRegexRule({name:"表情符号替换",find:":(smile|grin|laugh|wink|heart|cry|sob|angry):",replace:(e,t)=>({smile:"\uD83D\uDE0A",grin:"\uD83D\uDE01",laugh:"\uD83D\uDE02",wink:"\uD83D\uDE09",heart:"❤️",cry:"\uD83D\uDE22",sob:"\uD83D\uDE2D",angry:"\uD83D\uDE20"})[t]||e,placement:[i.AI_OUTPUT,i.USER_INPUT]}),d.addRegexRule({name:"强调内容",find:"\\*\\*([^*]+)\\*\\*",replace:"<strong>$1</strong>",placement:[i.AI_OUTPUT,i.USER_INPUT]}),d.addRegexRule({name:"斜体内容",find:"\\*([^*]+)\\*",replace:"<em>$1</em>",placement:[i.AI_OUTPUT,i.USER_INPUT]});var m=r(2045);function x(){let e=(0,m.G)(e=>e.user.currentUser),t=(null==e?void 0:e.username)||"User",r=(0,s.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u(e,t)},[]),l=(0,s.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))d.setVariable(e,r);return d.substituteOnly(e)}(e,t)},[]);return{format:r,substitute:l,formatChat:(0,s.useCallback)(function(e,r){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return u(e,{user:t,char:r,...s})}(e,t,r,s)},[t]),formatWithDateTime:(0,s.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u(e,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString(),...t})},[])}}},4149:function(e,t,r){e.exports=function(e,t){"use strict";let r=[{key:"title",getter:e=>e.getTitle()},{key:"html",getter:e=>e.getHtmlContainer()},{key:"confirmButtonText",getter:e=>e.getConfirmButton()},{key:"denyButtonText",getter:e=>e.getDenyButton()},{key:"cancelButtonText",getter:e=>e.getCancelButton()},{key:"footer",getter:e=>e.getFooter()},{key:"closeButtonHtml",getter:e=>e.getCloseButton()},{key:"iconHtml",getter:e=>e.getIconContent()},{key:"loaderHtml",getter:e=>e.getLoader()}],s=()=>{};return function(l){function n(t){let s={},l={},n=r.map(e=>e.key);return Object.entries(t).forEach(t=>{let[r,a]=t;n.includes(r)&&e.isValidElement(a)?(s[r]=a,l[r]=" "):l[r]=a}),[s,l]}function a(e,s){Object.entries(s).forEach(s=>{let[n,a]=s,o=r.find(e=>e.key===n).getter(l),i=t.createRoot(o);i.render(a),e.__roots.push(i)})}function o(e){e.__roots.forEach(e=>{e.unmount()}),e.__roots=[]}return class extends l{static argsToParams(t){if(!(e.isValidElement(t[0])||e.isValidElement(t[1])))return l.argsToParams(t);{let e={};return["title","html","icon"].forEach((r,s)=>{void 0!==t[s]&&(e[r]=t[s])}),e}}_main(e,t){this.__roots=[],this.__params=Object.assign({},t,e);let[r,l]=n(this.__params),i=l.willOpen||s,c=l.didOpen||s,d=l.didDestroy||s;return super._main(Object.assign({},l,{willOpen:e=>{a(this,r),i(e)},didOpen:e=>{setTimeout(()=>{c(e)})},didDestroy:e=>{d(e),o(this)}}))}update(e){Object.assign(this.__params,e),o(this);let[t,r]=n(this.__params);super.update(r),a(this,t)}}}}(r(2115),r(2669))},5844:(e,t,r)=>{"use strict";r.d(t,{Ay:()=>p,ZC:()=>m,xH:()=>g});var s=r(6439),l=r(9249),n=r(6168),a=r(3299);class o{async getModels(){try{return(await n.o.models.getModels()).data}catch(e){throw console.error("Failed to get models:",e),e}}}let i=new(o=(0,l.Cg)([a.A.Singleton],o)),c={max:{title:"Max系列: 极限性能，极致体验",description:"",sortOrder:1},xl:{title:"XL系列: 均衡性价比，优良体验",description:"",sortOrder:2},turbo:{title:"Turbo: 快速响应，经久耐用",description:"",sortOrder:3},medium:{title:"Medium: 稳定可靠，性价比优",description:"",sortOrder:4},legacy:{title:"Legacy: 经典模型，休闲首选",description:"",sortOrder:5}},d=e=>e.includes("max")?"max":e.includes("xl")?"xl":e.includes("turbo")?"turbo":e.includes("medium")?"medium":"legacy",u=e=>e.includes("max")||e.includes("xl")?"bg-primary":e.includes("turbo")?"bg-secondary":(e.includes("medium"),"bg-accent"),m=(0,s.zD)("model/fetchModels",async()=>(await i.getModels()).models),x=e=>{let t={};return Object.keys(c).forEach(e=>{t[e]=[]}),e.forEach(e=>{let r=d(e.id);t[r]&&t[r].push({id:e.id,name:e.name,description:"string"==typeof e.description?e.description:"适合各种AI对话场景",icon:u(e.id),price:e.pricings&&e.pricings.length>0?"".concat(e.pricings[0].outputPricePerK,"规范/1K tokens"):"价格待定",contextLength:e.contextLength,freeQuota:e.pointsPerMessage?50:void 0})}),Object.entries(t).filter(e=>{let[t,r]=e;return r.length>0}).map(e=>{let[t,r]=e;return{title:c[t].title,description:c[t].description,sortOrder:c[t].sortOrder,models:r}}).sort((e,t)=>e.sortOrder-t.sortOrder)},h=(0,s.Z0)({name:"model",initialState:{models:[],modelGroups:[],selectedModel:null,status:"idle",error:null},reducers:{setSelectedModel:(e,t)=>{e.selectedModel=t.payload}},extraReducers:e=>{e.addCase(m.pending,e=>{e.status="loading"}).addCase(m.fulfilled,(e,t)=>{if(e.status="succeeded",e.models=t.payload,e.modelGroups=x(t.payload),!e.selectedModel&&e.modelGroups.length>0){let t=e.modelGroups.find(e=>e.title.includes("XL"));t&&t.models.length>0?e.selectedModel=t.models[t.models.length-1]:e.modelGroups[0].models.length>0&&(e.selectedModel=e.modelGroups[0].models[0])}}).addCase(m.rejected,(e,t)=>{e.status="failed",e.error=t.error.message||null})}}),{setSelectedModel:g}=h.actions,p=h.reducer},6525:(e,t,r)=>{"use strict";r.d(t,{OD:()=>n,rN:()=>a,st:()=>o});var s=r(8924);let l=e=>e.app.model,n=e=>l(e).modelGroups,a=e=>l(e).selectedModel,o=e=>l(e).status;(0,s.Mz)([e=>l(e).models,(e,t)=>t],(e,t)=>e.find(e=>e.id===t)||null)},6773:(e,t,r)=>{Promise.resolve().then(r.bind(r,3183))}},e=>{var t=t=>e(e.s=t);e.O(0,[951,320,105,428,116,500,476,838,613,118,917,441,684,358],()=>t(6773)),_N_E=e.O()}]);