(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{176:(e,t,r)=>{"use strict";r.d(t,{default:()=>Y});var s=r(5155),a=r(2115),l=r(5695),n=r(8663),o=r(285),i=r(7374),c=r(6766);let d=[{id:"1",name:"1",image:"/voice-actors/actor1.jpg",gender:"女",type:"公有",code:"11"},{id:"1188",name:"1188",image:"/voice-actors/actor2.jpg",gender:"女",type:"公有",code:"8"},{id:"1.1",name:"1.1 dy霸总萧炎",image:"/voice-actors/actor3.jpg",gender:"男",type:"公有",code:"中气十足男声"},{id:"1314",name:"1314",image:"/voice-actors/actor1.jpg",gender:"女",type:"公有",code:"1314"},{id:"2",name:"2",image:"/voice-actors/actor2.jpg",gender:"女",type:"公有",code:"自用"},{id:"2211",name:"2211",image:"/voice-actors/actor3.jpg",gender:"女",type:"公有",code:"1122"}];function u(e){let{isOpen:t,onClose:r,onSelect:l}=e,[n,i]=(0,a.useState)("全部"),[u,x]=(0,a.useState)(""),[m,h]=(0,a.useState)(!1),g=(0,a.useRef)(null);(0,a.useEffect)(()=>{let e=e=>{g.current&&!g.current.contains(e.target)&&r()};return t&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[t,r]);let f=d.filter(e=>{let t="全部"===n||"男声"===n&&"男"===e.gender||"女声"===n&&"女"===e.gender,r=""===u||e.name.toLowerCase().includes(u.toLowerCase())||e.code.toLowerCase().includes(u.toLowerCase());return t&&r});return t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-50",onClick:r}),(0,s.jsx)("div",{className:"fixed inset-0 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{ref:g,className:"bg-[var(--bg-primary)] rounded-lg w-[900px] max-w-[90%] max-h-[90vh] shadow-xl overflow-hidden",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center p-4 border-b border-border",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-foreground",children:"选择声优"}),(0,s.jsx)(o.$,{onClick:r,variant:"ghost",size:"icon",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)("input",{type:"text",placeholder:"搜索声优...",value:u,onChange:e=>x(e.target.value),className:"w-full bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md p-3 text-[var(--text-primary)] focus:outline-none input-focus"})}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>h(!m),className:"min-w-[120px] flex items-center justify-between",children:[(0,s.jsx)("span",{children:n}),(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M6 9l6 6 6-6"})})]}),m&&(0,s.jsx)("div",{className:"absolute right-0 top-full mt-1 w-full bg-card rounded-md shadow-lg overflow-hidden z-60",children:(0,s.jsxs)("div",{className:"p-1",children:[(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{i("全部"),h(!1)},children:["全部"===n&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"全部"]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{i("男声"),h(!1)},children:["男声"===n&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"男声"]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{i("女声"),h(!1)},children:["女声"===n&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"女声"]})]})})]})]}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-4 overflow-y-auto max-h-[500px] pr-2",children:f.map(e=>(0,s.jsx)("div",{className:"bg-card rounded-lg overflow-hidden",children:(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsx)("div",{className:"flex justify-center mb-3",children:(0,s.jsx)("div",{className:"relative h-16 w-16 rounded-full overflow-hidden",children:(0,s.jsx)(c.default,{src:e.image,alt:e.name,fill:!0,className:"object-cover"})})}),(0,s.jsxs)("div",{className:"flex items-center justify-center gap-2 mb-2",children:[(0,s.jsx)("h3",{className:"text-foreground font-medium",children:e.name}),(0,s.jsx)("span",{className:"bg-accent text-xs text-accent-foreground px-1 py-0.5 rounded",children:e.type})]}),(0,s.jsx)("div",{className:"text-center text-sm text-muted-foreground mb-3",children:e.code}),(0,s.jsxs)("div",{className:"text-center text-sm text-muted-foreground mb-3",children:["性别: ",e.gender]}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)(o.$,{className:"flex-1",variant:"outline",onClick:()=>l(e),children:"选择"}),(0,s.jsx)(o.$,{variant:"outline",size:"icon",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"}),(0,s.jsx)("path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"})]})})]})]})},e.id))})]})]})})]}):null}var x=r(4752),m=r.n(x),h=r(4149),g=r.n(h);let f=g()(m()),v=[{id:"standard",name:"标准",description:"对话内容清晰流畅，表达平实"},{id:"creative",name:"创意",description:"对话内容富有创意，表达活泼生动"}];function p(e){let{selectedStyle:t,onStyleSelect:r}=e;return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"风格"}),(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>{f.fire({title:"选择对话风格",html:(0,s.jsx)("div",{className:"style-selector-container mt-4",children:v.map(e=>(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-start h-auto py-3 mb-2",onClick:()=>{r(e.name),f.close()},children:[(0,s.jsxs)("div",{className:"flex-1 text-left",children:[(0,s.jsx)("div",{className:"text-sm font-medium",children:e.name}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.description})]}),t===e.name&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]},e.id))}),showConfirmButton:!1,showCloseButton:!0,customClass:{container:"style-dialog-container",popup:"model-dialog-popup",htmlContainer:"model-dialog-html-container p-0"},width:"400px"})},className:"w-full justify-between",children:[(0,s.jsx)("span",{children:t}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]})]})}var j=r(2523),b=r(4540),w=r(6525),y=r(3500);let N=["/backgrounds/bg1.jpg","/backgrounds/bg2.jpg","/backgrounds/bg3.jpg","/backgrounds/bg4.jpg","/backgrounds/bg5.jpg","/backgrounds/bg6.jpg","/backgrounds/bg7.jpg","/backgrounds/bg8.jpg","/backgrounds/bg9.jpg"];function k(e){let{isOpen:t=!0,onClose:r,onBackgroundChange:l,chatTitle:n="故事",onChatTitleChange:d}=e;(0,b.wA)();let{deleteStory:x,currentStoryId:m}=(0,y.R7)();(0,b.d4)(w.st);let[h,g]=(0,a.useState)("1000"),[f,v]=(0,a.useState)(null),[k,C]=(0,a.useState)(!1),[L,S]=(0,a.useState)(null),[E,M]=(0,a.useState)("标准"),[B,T]=(0,a.useState)(n);(0,a.useEffect)(()=>{T(n)},[n]);let z=e=>{v(e),l&&l(e)},R=async()=>{m?(await (0,i.lJ)({title:'"'.concat(B,'"'),text:"确定要删除吗？",confirmButtonText:"删除",cancelButtonText:"取消"})).isConfirmed&&(x(m),null==r||r()):console.error("无法删除故事：未找到当前故事ID")};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"\n          ".concat(t?"translate-x-0":"translate-x-full","\n          fixed md:relative md:translate-x-0\n          w-80 md:w-80 h-screen bg-[var(--bg-primary)] shadow-lg border-l border-[var(--border-color)]\n          transition-transform duration-300 ease-in-out z-30 text-foreground p-4 md:pt-12 settings-panel\n          top-0 md:top-0 right-0\n        "),onKeyDown:e=>{e.stopPropagation()},children:[(0,s.jsxs)("div",{className:"flex justify-between pt-3 items-center mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"设置"}),(0,s.jsxs)("div",{className:"flex space-x-4",children:[(0,s.jsx)(o.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"}),(0,s.jsx)("polyline",{points:"16 6 12 2 8 6"}),(0,s.jsx)("line",{x1:"12",y1:"2",x2:"12",y2:"15"})]})}),(0,s.jsx)(o.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})})}),(0,s.jsx)(o.$,{variant:"ghost",size:"icon",onClick:()=>{B!==n&&d&&d(B),null==r||r()},className:"text-muted-foreground hover:text-foreground md:hidden",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"故事标题"}),(0,s.jsx)(j.p,{type:"text",value:B,onChange:e=>{T(e.target.value)}})]}),(0,s.jsxs)("div",{className:"pt-1",children:[(0,s.jsxs)(o.$,{variant:"outline",className:"w-full flex items-center justify-center",onClick:R,children:[(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,s.jsx)("polyline",{points:"3 6 5 6 21 6"}),(0,s.jsx)("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),"删除故事"]}),(0,s.jsx)("div",{className:"mt-6 border-t border-border"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"最大回复Token数量"}),(0,s.jsx)(j.p,{type:"text",value:h,onChange:e=>g(e.target.value)})]}),(0,s.jsx)(p,{selectedStyle:E,onStyleSelect:e=>{M(e)}}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("label",{className:"text-sm block",children:"背景图片"}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-2",children:N.map((e,t)=>(0,s.jsx)("div",{className:"relative h-20 w-full rounded-md overflow-hidden cursor-pointer border-2 ".concat(f===e?"border-primary":"border-transparent"),onClick:()=>z(e),children:(0,s.jsx)(c.default,{src:e,alt:"背景".concat(t+1),fill:!0,className:"object-cover"})},t))})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"自定义背景"}),(0,s.jsxs)("label",{className:"flex items-center justify-center p-2 bg-muted border border-border rounded-md cursor-pointer hover:bg-border",children:[(0,s.jsx)("span",{className:"text-foreground",children:"选择文件"}),(0,s.jsx)("input",{type:"file",className:"hidden",accept:"image/*",onChange:e=>{e.target.files&&e.target.files[0]&&z(URL.createObjectURL(e.target.files[0]))},onKeyDown:e=>{"Escape"===e.key&&e.stopPropagation()}})]})]})]})]}),t&&(0,s.jsx)("div",{className:"fixed inset-0 bg-background/70 z-20 md:hidden",onClick:r,"aria-hidden":"true"}),(0,s.jsx)(u,{isOpen:k,onClose:()=>C(!1),onSelect:e=>{S(e),C(!1)}})]})}var C=r(6874),L=r.n(C),S=r(1394);function E(e){let{activeStoryId:t,isOpen:r=!0,onClose:l,searchMode:n=!1}=e,[o,i]=(0,a.useState)(""),[c,d]=(0,a.useState)(!1),[u,x]=(0,a.useState)(!1),m=(0,a.useRef)(null),[h,g]=(0,a.useState)(!0),{stories:f,isLoading:v,error:p,fetchStories:j}=(0,y.R7)();(0,a.useEffect)(()=>{f.length>0&&g(!1)},[f]),(0,a.useEffect)(()=>{let e=setTimeout(()=>{h&&0===f.length&&(console.log("StorySidebar: loading timeout, forcing end of loading state"),g(!1))},3e3);return()=>clearTimeout(e)},[h,f.length]),(0,a.useEffect)(()=>{},[j]);let b=e=>{if(!e)return{date:"",time:""};let t=new Date(e);return{date:"".concat(t.getMonth()+1,"-").concat(t.getDate()),time:t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}},w=o?f.filter(e=>{var t;let r=e.title;if(r&&"string"==typeof r&&r.toLowerCase().includes(o.toLowerCase()))return!0;let s="string"==typeof e.lastMessage?e.lastMessage:null==(t=e.lastMessage)?void 0:t.content;return!!(s&&s.toLowerCase().includes(o.toLowerCase()))}):f,N=()=>{l&&l()},k=()=>{i(""),x(!1),m.current&&m.current.focus()};(0,a.useEffect)(()=>{if(r&&window.innerWidth<768||r&&n){let e=setTimeout(()=>{var e;null==(e=m.current)||e.focus()},300);return()=>clearTimeout(e)}},[r,n]);let C=e=>{let{story:r}=e,{avatarUrl:a,characterName:l,createdAt:n,lastMessageAt:o,title:i}=r,c=b(n?new Date(n):Date.now());return(0,s.jsxs)(L(),{href:"/chat?storyId=".concat(r.id),onClick:N,className:"flex items-center p-4 hover:bg-muted ".concat(r.id===t?"bg-muted":""),children:[(0,s.jsx)("div",{className:"relative h-10 w-10 rounded-full overflow-hidden mr-3",children:(0,s.jsxs)(S.eu,{className:"h-full w-full",children:[(0,s.jsx)(S.BK,{src:a||"",alt:i||"",className:"object-cover"}),(0,s.jsx)(S.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==i?void 0:i.charAt(0).toUpperCase())||"S"})]})}),(0,s.jsx)("div",{className:"flex-1 min-w-0",children:(0,s.jsx)("div",{className:"text-foreground font-medium truncate",children:i||"未命名"})}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground whitespace-nowrap flex-shrink-0 ml-2",children:c.date})]})};return(0,s.jsxs)("div",{className:"\n        ".concat(r?"translate-x-0":"-translate-x-full","\n        fixed md:relative md:translate-x-0\n        w-[280px] md:w-72 h-screen pt-12 bg-[var(--bg-primary)] border-r border-[var(--border-color)] flex flex-col\n        transition-transform duration-300 ease-in-out z-30\n      "),children:[(0,s.jsxs)("div",{className:"p-1 sm:p-2  flex items-center ".concat(n?"bg-muted/50":""),children:[(0,s.jsxs)("div",{className:"relative flex-1 ".concat(c||n?"ring-1 ring-border rounded-md":""),children:[(0,s.jsx)("input",{ref:m,type:"text",value:o,onChange:e=>{let t=e.target.value;i(t),t?(x(!0),setTimeout(()=>{x(!1)},300)):x(!1),t.length},onFocus:()=>d(!0),onBlur:()=>d(!1),placeholder:n?"搜索聊天...":"搜索",className:"w-full bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md h-9 pl-9 pr-2 text-[var(--text-primary)] focus:outline-none input-focus","aria-label":"搜索聊天"}),(0,s.jsx)("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 text-muted-foreground",children:u?(0,s.jsxs)("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),o&&(0,s.jsx)("button",{onClick:k,className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground","aria-label":"清除搜索",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),(0,s.jsx)("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]})})]}),(0,s.jsx)("button",{onClick:l,className:"ml-2 text-muted-foreground hover:text-foreground p-2 md:hidden","aria-label":"关闭侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar scrollbar-thin scrollbar-track-background scrollbar-thumb-border hover:scrollbar-thumb-border/80",children:h?(0,s.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,s.jsxs)("svg",{className:"animate-spin h-8 w-8 text-foreground",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):o&&0===w.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"未找到结果"}),(0,s.jsxs)("p",{className:"text-muted-foreground mt-2 mb-4",children:['没有找到与"',o,'"相关的聊天']}),(0,s.jsx)("button",{onClick:k,className:"px-4 py-2 bg-primary text-foreground rounded-md transition-colors",children:"清除搜索"})]}):0===w.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),(0,s.jsx)("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"暂无聊天记录"}),(0,s.jsx)("p",{className:"text-muted-foreground mt-2",children:"开始与角色聊天创建新的故事"})]}):w.map(e=>(0,s.jsx)(C,{story:e},e.id))}),r&&(0,s.jsx)("div",{className:"fixed inset-0 bg-background/70 z-20 md:hidden",onClick:l,"aria-hidden":"true"})]})}var M=r(2045),B=r(1795),T=r(4421),z=r(8578),R=r(3315),I=r(3096),D=r(4165),_=r(795),W=r(3655),O=a.forwardRef((e,t)=>(0,s.jsx)(W.sG.label,{...e,ref:t,onMouseDown:t=>{var r;t.target.closest("button, input, select, textarea")||(null==(r=e.onMouseDown)||r.call(e,t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}}));O.displayName="Label";var $=r(2085),V=r(9434);let A=(0,$.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),F=a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)(O,{ref:t,className:(0,V.cn)(A(),r),...a})});function H(e){let{isOpen:t,onClose:r,storyId:l,onShareStory:n}=e,[i,c]=(0,a.useState)(""),[d,u]=(0,a.useState)(""),[x,m]=(0,a.useState)(!0),[h,g]=(0,a.useState)(!0),[f,v]=(0,a.useState)(!1),[p,b]=(0,a.useState)(null),[w,y]=(0,a.useState)(!1),N=async()=>{v(!0);try{let e={originalStoryId:l,title:i||void 0,description:d||void 0,visibility:x?T.gu.PUBLIC:T.gu.UNLISTED,allowForking:h},t=await n(e);if(t&&t.slug){let e=window.location.origin,r="".concat(e,"/character/dialogue/?slug=").concat(t.slug);b(r)}}catch(e){console.error("Failed to share story:",e)}finally{v(!1)}},k=()=>{f||(b(null),c(""),u(""),m(!0),g(!0),y(!1),r())};return(0,s.jsx)(D.lG,{open:t,onOpenChange:k,children:(0,s.jsxs)(D.Cf,{className:"bg-opacity-90 bg-background backdrop-blur-sm z-150",children:[(0,s.jsx)(D.c7,{children:(0,s.jsx)(D.L3,{children:"分享故事"})}),p?(0,s.jsxs)("div",{className:"py-4 space-y-4",children:[(0,s.jsx)("p",{className:"text-sm text-[var(--text-secondary)]",children:"故事已成功分享! 您可以复制以下链接分享给他人:"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(j.p,{value:p,readOnly:!0,className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus flex-1"}),(0,s.jsxs)(o.$,{onClick:()=>{p&&navigator.clipboard.writeText(p).then(()=>{y(!0),setTimeout(()=>y(!1),2e3)}).catch(e=>{console.error("无法复制到剪贴板:",e)})},variant:"outline",className:"flex items-center gap-2 bg-[var(--bg-secondary)] border-[var(--border-color)]",children:[(0,s.jsx)(I.DDb,{className:"h-4 w-4"}),w?(0,s.jsx)("span",{className:"text-xs",children:"已复制"}):null]})]}),(0,s.jsx)(D.Es,{children:(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:k,children:"关闭"})})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"py-4 space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(F,{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"故事标题 (可选)"}),(0,s.jsx)(j.p,{value:i,onChange:e=>c(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"保持为空以使用原始故事标题"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)(F,{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"描述 (可选)"}),(0,s.jsx)(j.p,{value:d,onChange:e=>u(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"添加故事描述"})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)(F,{className:"text-sm font-medium text-[var(--text-secondary)]",children:"公开分享"}),(0,s.jsx)(_.d,{checked:x,onCheckedChange:m})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)(F,{className:"text-sm font-medium text-[var(--text-secondary)]",children:"允许其他用户衍生"}),(0,s.jsx)(_.d,{checked:h,onCheckedChange:g})]})]}),(0,s.jsxs)(D.Es,{children:[(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:k,children:"取消"}),(0,s.jsx)(o.$,{onClick:N,variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:f,children:f?"分享中...":"分享故事"})]})]})]})})}F.displayName=O.displayName;var P=r(9371),U=r(298),G=r(8613),K=r(5844);let Z=g()(m());function q(){let e=(0,b.wA)(),t=(0,b.d4)(w.z7),r=(0,b.d4)(w.rN),l=(0,b.d4)(w.st);(0,a.useEffect)(()=>{"idle"===l&&e((0,K.ZC)())},[e,l]);let n=t=>{e((0,K.xH)(t))};return(0,s.jsx)("div",{className:"space-y-2",children:(0,s.jsxs)(o.$,{variant:"ghost",onClick:()=>{Z.fire({title:"选择模型",html:(0,s.jsx)("div",{className:"model-selector-container max-h-[400px] overflow-y-auto mt-4",children:"loading"===l?(0,s.jsx)("div",{className:"flex items-center justify-center w-full p-4",children:(0,s.jsx)("span",{className:"animate-pulse",children:"加载中..."})}):"succeeded"===l?(0,s.jsx)("div",{className:"space-y-2",children:t.map((e,t)=>(0,s.jsx)(o.$,{variant:"ghost",className:"w-full justify-start h-auto py-3 px-4",onClick:()=>{n(e),Z.close()},children:(0,s.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-foreground",children:e.name}),r&&r.id===e.id&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground mt-1",children:e.description}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground mt-1",children:e.price}),e.isDefault&&(0,s.jsx)("div",{className:"text-xs text-primary mt-1",children:"默认模型"})]})},t))}):(0,s.jsx)("div",{className:"text-center p-4",children:(0,s.jsx)("p",{children:"加载模型失败"})})}),showConfirmButton:!1,showCloseButton:!0,customClass:{container:"model-dialog-container",popup:"model-dialog-popup",htmlContainer:"model-dialog-html-container p-0"},width:"500px"})},className:"w-full justify-start text-xs",disabled:"succeeded"!==l,children:["loading"===l?(0,s.jsx)("div",{className:"flex items-center justify-center w-full",children:(0,s.jsx)("span",{className:"animate-pulse",children:"加载中..."})}):r?(0,s.jsx)("div",{className:"flex items-center",children:(0,s.jsx)("div",{className:"flex-1 text-left",children:(0,s.jsx)("div",{className:"text-xs",children:r.name})})}):(0,s.jsx)("span",{children:"选择模型"}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]})})}var J=r(5175);function X(e){var t;let{character:r,error:n,clearError:c}=e,d=(0,l.useRouter)(),[u,x]=(0,a.useState)(""),[m,h]=(0,a.useState)(!1),g=(0,M.G)(B.xu),f=(0,M.G)(B.vc),[v,p]=(0,a.useState)(!1),[j,b]=(0,a.useState)(null),[w,N]=(0,a.useState)(!1),[C,L]=(0,a.useState)(!1),[D,_]=(0,a.useState)(!0),[W,O]=(0,a.useState)("fade-in-up"),$=(0,a.useRef)(null),V=(0,a.useRef)(null),[A,F]=(0,a.useState)(0),K=(0,M.j)(),[Z,X]=(0,a.useState)(!1),[Q,Y]=(0,a.useState)(null),{currentStoryId:ee,currentCharacterId:et,messages:er,isLoading:es,isSending:ea,error:el,sendMessage:en,addMessage:eo,sendStreamMessage:ei,fetchCurStoryHistory:ec}=(0,y.Z3)(),{createStory:ed,fetchStories:eu,updateStoryTitle:ex}=(0,y.R7)(),{tempContext:em,initTempContext:eh,updateTempTitle:eg}=(0,y.ki)(),{formatChat:ef}=(0,R.L)(),ev=(0,M.G)(U.jQ),[ep,ej]=(0,a.useState)(""),{getAssetBalanceByCode:eb,fetchWallet:ew}=(0,G.vT)();(0,a.useEffect)(()=>{ev&&ev.title&&"string"==typeof ev.title?ej(ev.title):m&&em&&em.title&&"string"==typeof em.title?ej(em.title):ej("")},[ev,m,em]);let ey=m&&em?em.messages:er,eN=async e=>{if(e!==ep){ej(e);try{ee?await ex(ee,e)||console.error("Failed to update story title"):m&&em&&eg(e)}catch(e){console.error("Error updating story title:",e)}}},ek=(0,a.useCallback)(e=>{let t=window.innerWidth<768;if(Z||v&&window.innerWidth<768)return;let r=e.target;r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement||r instanceof HTMLSelectElement||r.isContentEditable||"BUTTON"===r.tagName||("/"===e.key||e.ctrlKey&&"f"===e.key?(e.preventDefault(),t?eS():N(!0)):"Escape"===e.key&&w&&(e.preventDefault(),eE()))},[w,v,Z]);(0,a.useEffect)(()=>(window.addEventListener("keydown",ek),()=>{window.removeEventListener("keydown",ek)}),[ek]),(0,a.useEffect)(()=>{r&&!ee&&(eh(r),F(0))},[eu,r,ee,eh]),(0,a.useEffect)(()=>{ew()},[ew]),(0,a.useEffect)(()=>{!ee&&et?h(!0):ee&&et?h(!1):(console.error("currentStoryId",ee),console.error("currentCharacterId",et))},[ee,et]),(0,a.useEffect)(()=>{$.current&&$.current.scrollIntoView({behavior:"smooth"})},[er,ey]),(0,a.useEffect)(()=>{if(console.log("isSending 滚动到最新消息",ea),ea){$.current&&$.current.scrollIntoView({behavior:"smooth"});let e=setTimeout(()=>{$.current&&($.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 延迟500ms"))},500),t=setTimeout(()=>{$.current&&($.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 延迟1500ms"))},1500);return()=>{clearTimeout(e),clearTimeout(t)}}if(!1===ea){let e=setTimeout(()=>{$.current&&($.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 发送完成"))},300);return()=>clearTimeout(e)}},[ea]),(0,a.useEffect)(()=>{if(D){let e=setTimeout(()=>{O("fade-out-down"),setTimeout(()=>{_(!1)},300)},5e3);return()=>clearTimeout(e)}},[D]),(0,a.useEffect)(()=>{let e=()=>{O("fade-out-down"),setTimeout(()=>{_(!1)},300)};return window.addEventListener("click",e),window.addEventListener("touchstart",e),()=>{window.removeEventListener("click",e),window.removeEventListener("touchstart",e)}},[]),(0,a.useEffect)(()=>{if(n){let e=setTimeout(()=>{c()},5e3);return()=>clearTimeout(e)}},[n,c]);let eC=()=>{if(u.trim()&&r&&!(u.length>1e3)){if(10>eb("SCORE"))return void(0,i.lJ)({title:"余额不足",text:"您的SCORE余额不足，需要至少10分才能发送消息。是否前往充值？",confirmButtonText:"去充值",cancelButtonText:"取消"}).then(e=>{e.isConfirmed&&d.push("/profile")});$.current&&$.current.scrollIntoView({behavior:"smooth"}),eo({storyId:ee,characterId:r.id,contentType:T._8.TEXT,content:u}).then(e=>{e&&(en(e),x(""),setTimeout(()=>{$.current&&$.current.scrollIntoView({behavior:"smooth"})},100))}).catch(e=>{ew(),i.oR.error((null==e?void 0:e.message)||"发送消息失败，请稍后再试")})}},eL=async()=>{if(r){if(!m)return void console.error("isCharaterMode",m);try{let e=ey.map((e,t)=>({content:e.content,contentType:e.contentType,index:t,metadata:e.metadata||{}})),t={characterId:r.id,title:r.name,initialMessages:e};await ed(t)&&(eu(),x(""))}catch(e){console.error("Failed to create story:",e)}}},eS=()=>{N(!0),L(!0)},eE=()=>{N(!1),L(!1)},eM=async e=>{try{return{slug:(await P.a.createShareStory(e)).slug}}catch(e){throw console.error("Failed to share story:",e),e}};return r?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"flex h-screen overflow-hidden",children:[(0,s.jsx)(E,{activeStoryId:ee||"",isOpen:w,onClose:eE,searchMode:C}),(0,s.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden relative w-full z-0 pt-12",children:[(0,s.jsxs)("div",{className:"bg-card p-1 sm:p-2 flex items-center ",children:[(0,s.jsx)("button",{onClick:()=>N(!0),className:"mr-3 text-foreground p-1 md:hidden","aria-label":"打开侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),(0,s.jsx)("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),(0,s.jsx)("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),(0,s.jsx)("div",{className:"flex-1 min-w-0",children:(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)(q,{}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:eS,className:"text-foreground p-2 rounded-full hover:bg-muted transition-colors md:hidden","aria-label":"搜索聊天",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),(0,s.jsx)("button",{onClick:()=>p(!0),className:"text-foreground p-2 rounded-full hover:bg-muted transition-colors md:hidden","aria-label":"设置",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})]})]})})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4 bg-background relative z-5 scrollbar scrollbar-thin scrollbar-track-background scrollbar-thumb-border hover:scrollbar-thumb-border/80",style:j?{backgroundImage:"url(".concat(j,")"),backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:{},children:[j&&(0,s.jsx)("div",{className:"absolute inset-0 bg-background z-0"}),(0,s.jsx)("div",{className:"mx-auto w-full relative z-5",style:{maxWidth:"1200px"},children:(0,s.jsxs)("div",{className:"space-y-3 sm:space-y-4 relative z-5",children:[ey.map((e,t)=>(0,s.jsx)(J.q,{message:e,isUserMessage:e.role===T.hE.USER,storyId:ee||"",characterAppearance:{name:r.name,avatarUrl:r.avatarUrl,shouldBlurAvatar:r.shouldBlurAvatar,greetings:r.greetings},userAppearance:{name:null==g?void 0:g.nickname,avatarUrl:f},formatChatContent:ef,hoveredMessageId:Q,onHover:Y,isTempContext:m&&!!em&&0===t&&e.role===T.hE.ASSISTANT,selectedGreetingIndex:A,onGreetingChange:e=>{F(e),K((0,z.XB)({newGreeting:r.greetings[e]}))}},e.id)),ea&&(0,s.jsxs)("div",{className:"flex justify-start",children:[(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(S.eu,{className:"h-full w-full",children:[(0,s.jsx)(S.BK,{src:r.avatarUrl,alt:r.name,className:"object-cover",shouldBlur:r.shouldBlurAvatar}),(0,s.jsx)(S.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(t=r.name)?void 0:t.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsx)("div",{className:"bg-card text-foreground rounded-lg p-2 sm:p-3 max-w-[80%] sm:max-w-[70%]",children:(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.2s"}}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.4s"}})]})})]}),(0,s.jsx)("div",{ref:$})]})})]}),(0,s.jsx)("div",{className:"bg-background relative z-20",children:(0,s.jsxs)("div",{className:"mx-auto w-full",style:{maxWidth:"1200px"},children:[n&&(0,s.jsx)("div",{className:"px-3 py-2 bg-destructive/50 text-destructive-foreground rounded-md text-sm mx-2 sm:mx-4 mt-2 sm:mt-3",children:(0,s.jsx)("p",{children:n})}),(0,s.jsx)("div",{className:"flex justify-center items-center p-2 sm:p-4",children:(0,s.jsxs)("div",{className:"relative flex items-center w-full",children:[(0,s.jsx)("button",{className:"absolute left-3 sm:left-4 text-primary/70 hidden sm:block",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{d:"M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"})})}),!ee&&(null==r?void 0:r.id)?(0,s.jsx)("button",{onClick:eL,className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 sm:pl-12 pr-12 sm:pr-16 py-2 sm:py-3 text-sm sm:text-base text-[var(--text-primary)] focus:outline-none hover:bg-[var(--bg-tertiary)]/90 transition-colors",children:"创建故事"}):(0,s.jsx)("textarea",{ref:V,value:u,onChange:e=>{x(e.target.value),e.target.value.length>1e3||n&&e.target.value.length<=1e3&&c()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eC())},placeholder:"输入消息 (Shift+Enter 换行)",className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 sm:pl-12 pr-24 sm:pr-28 py-2 sm:py-3 text-sm sm:text-base text-[var(--text-primary)] focus:outline-none input-focus resize-none scrollbar scrollbar-thin scrollbar-track-[var(--bg-secondary)] scrollbar-thumb-[var(--primary)]/20 hover:scrollbar-thumb-[var(--primary)]/40",rows:1}),ee&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{className:"absolute right-12 sm:right-14 bg-[var(--primary)] h-7 w-7 sm:h-8 sm:w-8 rounded-full flex items-center justify-center hover:bg-[var(--primary-hover)]",onClick:eC,disabled:ea||u.length>1e3||""===u.trim(),children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-primary-foreground",children:[(0,s.jsx)("path",{d:"M22 2L11 13"}),(0,s.jsx)("path",{d:"M22 2L15 22L11 13L2 9L22 2Z"})]})}),(0,s.jsx)("button",{className:"absolute right-3 sm:right-4 bg-[var(--bg-tertiary)] h-7 w-7 sm:h-8 sm:w-8 rounded-full flex items-center justify-center border border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]/90",onClick:()=>X(!0),disabled:ea,"aria-label":"分享故事",children:(0,s.jsx)(I.qfV,{className:"h-4 w-4 text-[var(--text-primary)]"})})]})]})})]})})]}),(0,s.jsx)(k,{isOpen:v,onClose:()=>p(!1),onBackgroundChange:e=>{b(e)},chatTitle:ep,onChatTitleChange:eN})]}),Z&&ee&&(0,s.jsx)(H,{isOpen:Z,onClose:()=>X(!1),storyId:ee,onShareStory:eM})]}):(0,s.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"角色不存在"}),(0,s.jsx)("p",{className:"mb-8",children:"无法找到该角色，请返回角色库选择其他角色。"}),(0,s.jsx)(o.$,{className:"bg-primary text-foreground",onClick:()=>d.push("/characters"),children:"返回角色库"})]})}var Q=r(2847);function Y(){return(0,s.jsxs)("main",{className:"min-h-screen bg-background relative",children:[(0,s.jsx)(n.default,{}),(0,s.jsx)("div",{className:"pt-2",children:(0,s.jsx)(a.Suspense,{fallback:(0,s.jsx)(ee,{}),children:(0,s.jsx)(et,{})})})]})}function ee(){return(0,s.jsxs)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:[(0,s.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-primary motion-reduce:animate-[spin_1.5s_linear_infinite]",children:(0,s.jsx)("span",{className:"sr-only",children:"Loading..."})}),(0,s.jsx)("p",{className:"ml-3 text-foreground",children:"正在加载聊天数据..."})]})}function et(){let e=(0,l.useRouter)(),t=(0,l.useSearchParams)(),r=null==t?void 0:t.get("characterId"),n=null==t?void 0:t.get("storyId"),[o,i]=(0,a.useState)(null),{clearCurrentStoryContext:c}=(0,y.w0)(),{currentUser:d}=(0,G.Jd)(),{currentCharacter:u,isLoading:x,error:m}=(0,Q.OE)(),{fetchCharacterById:h}=(0,Q.MM)(),{fetchStoryToCurStoryContext:g,isLoading:f,fetchStories:v,currentStoryId:p}=(0,y.R7)(),{error:j,clearErrors:b,isLoading:w,currentStory:N,fetchCurStoryHistory:k}=(0,y.Z3)();return((0,a.useEffect)(()=>{console.log("Effect: Fetch stories triggered"),d&&v()},[d,v]),(0,a.useEffect)(()=>{console.log("Effect: Fetch story context triggered, storyId:",n),n?g(n):c()},[n,g,c]),(0,a.useEffect)(()=>{let e=null==N?void 0:N.characterId;console.log("Effect: Fetch character and history for story triggered, charId:",e),e&&(h(e),k(0,30))},[null==N?void 0:N.characterId,h,k]),(0,a.useEffect)(()=>{console.log("Effect: Fetch character by URL ID triggered, characterId:",r,"storyId:",n),r&&!n&&h(r)},[r,n,h]),w||x||f)?(0,s.jsx)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:(0,s.jsx)("span",{className:"text-foreground",children:"正在加载聊天数据..."})}):u?(0,s.jsx)(X,{character:u,error:o||m||j,clearError:b}):(0,s.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"正在加载角色..."}),(0,s.jsx)("p",{className:"mb-8",children:"请稍候，如果长时间未响应或角色不存在，请返回角色库选择其他角色。"}),(0,s.jsx)("button",{className:"bg-primary/20 hover:bg-primary/30 px-4 py-2 rounded",onClick:()=>e.push("/characters"),children:"返回角色库"})]})}},795:(e,t,r)=>{"use strict";r.d(t,{d:()=>y});var s=r(5155),a=r(2115),l=r(5185),n=r(6101),o=r(6081),i=r(5845),c=r(1275),d=r(3655),u="Switch",[x,m]=(0,o.A)(u),[h,g]=x(u),f=a.forwardRef((e,t)=>{let{__scopeSwitch:r,name:o,checked:c,defaultChecked:x,required:m,disabled:g,value:f="on",onCheckedChange:v,form:p,...w}=e,[y,N]=a.useState(null),k=(0,n.s)(t,e=>N(e)),C=a.useRef(!1),L=!y||p||!!y.closest("form"),[S,E]=(0,i.i)({prop:c,defaultProp:null!=x&&x,onChange:v,caller:u});return(0,s.jsxs)(h,{scope:r,checked:S,disabled:g,children:[(0,s.jsx)(d.sG.button,{type:"button",role:"switch","aria-checked":S,"aria-required":m,"data-state":b(S),"data-disabled":g?"":void 0,disabled:g,value:f,...w,ref:k,onClick:(0,l.m)(e.onClick,e=>{E(e=>!e),L&&(C.current=e.isPropagationStopped(),C.current||e.stopPropagation())})}),L&&(0,s.jsx)(j,{control:y,bubbles:!C.current,name:o,value:f,checked:S,required:m,disabled:g,form:p,style:{transform:"translateX(-100%)"}})]})});f.displayName=u;var v="SwitchThumb",p=a.forwardRef((e,t)=>{let{__scopeSwitch:r,...a}=e,l=g(v,r);return(0,s.jsx)(d.sG.span,{"data-state":b(l.checked),"data-disabled":l.disabled?"":void 0,...a,ref:t})});p.displayName=v;var j=a.forwardRef((e,t)=>{let{__scopeSwitch:r,control:l,checked:o,bubbles:i=!0,...d}=e,u=a.useRef(null),x=(0,n.s)(u,t),m=function(e){let t=a.useRef({value:e,previous:e});return a.useMemo(()=>(t.current.value!==e&&(t.current.previous=t.current.value,t.current.value=e),t.current.previous),[e])}(o),h=(0,c.X)(l);return a.useEffect(()=>{let e=u.current;if(!e)return;let t=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"checked").set;if(m!==o&&t){let r=new Event("click",{bubbles:i});t.call(e,o),e.dispatchEvent(r)}},[m,o,i]),(0,s.jsx)("input",{type:"checkbox","aria-hidden":!0,defaultChecked:o,...d,tabIndex:-1,ref:x,style:{...d.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});function b(e){return e?"checked":"unchecked"}j.displayName="SwitchBubbleInput";var w=r(9434);let y=a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)(f,{className:(0,w.cn)("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-[var(--switch-checked-bg)] data-[state=unchecked]:bg-[var(--switch-unchecked-bg)]",r),...a,ref:t,children:(0,s.jsx)(p,{className:(0,w.cn)("pointer-events-none block h-4 w-4 rounded-full bg-[var(--switch-thumb-bg)] shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})})});y.displayName=f.displayName},2523:(e,t,r)=>{"use strict";r.d(t,{p:()=>n});var s=r(5155),a=r(2115),l=r(9434);let n=a.forwardRef((e,t)=>{let{className:r,type:a,...n}=e;return(0,s.jsx)("input",{type:a,className:(0,l.cn)("flex h-10 w-full rounded-md border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",r),ref:t,...n})});n.displayName="Input"},4149:function(e,t,r){e.exports=function(e,t){"use strict";let r=[{key:"title",getter:e=>e.getTitle()},{key:"html",getter:e=>e.getHtmlContainer()},{key:"confirmButtonText",getter:e=>e.getConfirmButton()},{key:"denyButtonText",getter:e=>e.getDenyButton()},{key:"cancelButtonText",getter:e=>e.getCancelButton()},{key:"footer",getter:e=>e.getFooter()},{key:"closeButtonHtml",getter:e=>e.getCloseButton()},{key:"iconHtml",getter:e=>e.getIconContent()},{key:"loaderHtml",getter:e=>e.getLoader()}],s=()=>{};return function(a){function l(t){let s={},a={},l=r.map(e=>e.key);return Object.entries(t).forEach(t=>{let[r,n]=t;l.includes(r)&&e.isValidElement(n)?(s[r]=n,a[r]=" "):a[r]=n}),[s,a]}function n(e,s){Object.entries(s).forEach(s=>{let[l,n]=s,o=r.find(e=>e.key===l).getter(a),i=t.createRoot(o);i.render(n),e.__roots.push(i)})}function o(e){e.__roots.forEach(e=>{e.unmount()}),e.__roots=[]}return class extends a{static argsToParams(t){if(!(e.isValidElement(t[0])||e.isValidElement(t[1])))return a.argsToParams(t);{let e={};return["title","html","icon"].forEach((r,s)=>{void 0!==t[s]&&(e[r]=t[s])}),e}}_main(e,t){this.__roots=[],this.__params=Object.assign({},t,e);let[r,a]=l(this.__params),i=a.willOpen||s,c=a.didOpen||s,d=a.didDestroy||s;return super._main(Object.assign({},a,{willOpen:e=>{n(this,r),i(e)},didOpen:e=>{setTimeout(()=>{c(e)})},didDestroy:e=>{d(e),o(this)}}))}update(e){Object.assign(this.__params,e),o(this);let[t,r]=l(this.__params);super.update(r),n(this,t)}}}}(r(2115),r(2669))},5844:(e,t,r)=>{"use strict";r.d(t,{Ay:()=>m,ZC:()=>c,xH:()=>x});var s=r(6439),a=r(9249),l=r(6168),n=r(3299);class o{async getVirtualModels(){try{return(await l.o.models.getVirtualModels()).data}catch(e){throw console.error("Failed to get virtual models:",e),e}}}let i=new(o=(0,a.Cg)([n.A.Singleton],o)),c=(0,s.zD)("model/fetchModels",async()=>(await i.getVirtualModels()).models),d=e=>e.map(e=>({id:e.id,name:e.name,description:e.description||"暂无描述",price:e.pricePerK?"".concat(JSON.stringify(e.pricePerK),"/1K tokens"):"价格待定",isDefault:e.isDefault})),u=(0,s.Z0)({name:"model",initialState:{models:[],uiModels:[],selectedModel:null,status:"idle",error:null},reducers:{setSelectedModel:(e,t)=>{e.selectedModel=t.payload}},extraReducers:e=>{e.addCase(c.pending,e=>{e.status="loading"}).addCase(c.fulfilled,(e,t)=>{if(e.status="succeeded",e.models=t.payload,e.uiModels=d(t.payload),!e.selectedModel&&e.uiModels.length>0){let t=e.uiModels.find(e=>e.isDefault);e.selectedModel=t||e.uiModels[0]}}).addCase(c.rejected,(e,t)=>{e.status="failed",e.error=t.error.message||null})}}),{setSelectedModel:x}=u.actions,m=u.reducer},6773:(e,t,r)=>{Promise.resolve().then(r.bind(r,176))}},e=>{var t=t=>e(e.s=t);e.O(0,[951,320,105,428,116,455,476,985,613,127,663,561,441,684,358],()=>t(6773)),_N_E=e.O()}]);