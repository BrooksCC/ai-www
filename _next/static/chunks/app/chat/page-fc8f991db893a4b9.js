(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{41:(e,t,r)=>{"use strict";r.d(t,{Mw:()=>s.Mw,po:()=>s.po});var s=r(5939)},2138:(e,t,r)=>{"use strict";r.d(t,{default:()=>er});var s=r(5155),a=r(2115),n=r(7694),l=r(5695),i=r(2045),o=r(1795),d=r(41),c=r(6439),u=r(9249),m=r(770),x=r(3299);class h{async getStory(e){return m.m.getStory(e)}async createStory(e){return m.m.createStory(e)}async updateTitle(e,t){return m.m.updateStory(e,t)}async deleteStory(e){return m.m.deleteStory(e)}async getUserStories(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;return m.m.getUserStories(e,t,r)}}let g=new(h=(0,u.Cg)([x.A.Singleton],h));var p=r(4087),f=r(5939),v=r(4421);let j=(e,t)=>({id:e.id,storyId:e.storyId,characterId:e.role===v.hE.ASSISTANT?t:"",role:e.role===v.hE.USER?"USER":"ASSISTANT",contentType:e.contentType===v._8.TEXT?"TEXT":"IMAGE",content:e.content,metadata:e.metadata,createdAt:e.createdAt}),y=(0,c.zD)("story/loadStorySession",async(e,t)=>{let{dispatch:r}=t;try{var s;let t=await g.getStory(e),a=await p.j.getCharacterDetail(t.characterId),n=await m.m.getHistory({storyId:e,characterId:t.characterId,limit:50}),l={id:t.id,characterId:t.characterId,character:a,title:null!=(s=t.title)?s:"Untitled Story",mode:"story",messages:n.messages.map(e=>j(e,t.characterId)),isLoading:!1,isSending:!1};r((0,f.Nq)(l))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,f.Nh)(e))}}),w=(0,c.zD)("story/loadCharacterSession",async(e,t)=>{let{dispatch:r}=t;try{var s;let t=await p.j.getCharacterDetail(e),a={id:"temp-".concat(Date.now()),characterId:t.id,character:t,title:"与".concat(t.name,"的临时对话"),mode:"character",messages:(null==(s=t.greetings)?void 0:s.length)?[{id:"greeting-".concat(Date.now()),storyId:"temp",characterId:t.id,role:"ASSISTANT",contentType:"TEXT",content:t.greetings[0],createdAt:new Date().toISOString()}]:[],isLoading:!1,isSending:!1};r((0,f.Nq)(a))}catch(t){let e=t instanceof Error?t.message:String(t);r((0,f.Nh)(e))}}),b=(0,c.zD)("story/sendMessage",async(e,t)=>{let{content:r}=e,{getState:s,dispatch:a}=t,{current:n}=s().story;if(!n||!n.characterId)throw Error("无法在没有会话的情况下发送消息。");a((0,f.$c)(!0));try{let e=n.id;if("character"===n.mode){let e=n.messages.filter(e=>"ASSISTANT"!==e.role).map((e,t)=>({content:e.content,contentType:"TEXT"===e.contentType?"TEXT":"IMAGE",index:t}));e.push({content:r,contentType:"TEXT",index:e.length});let t={characterId:n.characterId,title:n.title,initialMessages:e},s=await g.createStory(t);await a(y(s.id))}else{let t={id:"local-user-".concat(Date.now()),storyId:e,characterId:"",role:"USER",contentType:"TEXT",content:r,createdAt:new Date().toISOString()};a((0,f.tj)(t));let s=await m.m.sendMessage({storyId:e,content:r});a((0,f.tj)(j(s,n.characterId)))}}catch(t){let e=t instanceof Error?t.message:String(t);a((0,f.Nh)(e))}finally{a((0,f.$c)(!1))}}),N=(0,c.zD)("story/deleteMessage",async(e,t)=>{let{messageId:r}=e,{getState:s,dispatch:a}=t,{current:n}=s().story;if(!n||"story"!==n.mode)return void a((0,f.Nh)("只能删除已保存故事中的消息。"));let l=n.id;try{await m.m.deleteMessage(l,r),a((0,f.RC)(r))}catch(t){let e=t instanceof Error?t.message:String(t);throw a((0,f.Nh)(e)),t}finally{a((0,f.xb)(null))}}),k=(0,c.zD)("story/updateMessage",async(e,t)=>{let{messageId:r,content:s}=e,{getState:a,dispatch:n}=t,{current:l}=a().story;if(!l||"story"!==l.mode)return void n((0,f.Nh)("只能更新已保存故事中的消息。"));let i=l.id;try{await m.m.updateMessage(i,r,s),await n(y(i))}catch(t){let e=t instanceof Error?t.message:String(t);throw n((0,f.Nh)(e)),t}}),S=(0,c.zD)("story/regenerateMessage",async(e,t)=>{let{messageId:r}=e,{getState:s,dispatch:a}=t,{current:n}=s().story;if(!n||"story"!==n.mode)return void a((0,f.Nh)("只能在已保存的故事中重新生成消息。"));let l=n.id;a((0,f.G0)(r));try{await m.m.regenerateResponse(l,r,"some-default-model-id"),await a(y(l))}catch(t){let e=t instanceof Error?t.message:String(t);throw a((0,f.Nh)(e)),t}finally{a((0,f.G0)(null))}});function C(){let e=(0,l.useSearchParams)(),t=(0,i.j)(),r=(0,i.G)(e=>e.story.current),s=(0,i.G)(e=>e.story.sidebarOpen),n=null==e?void 0:e.get("storyId"),o=null==e?void 0:e.get("characterId");(0,a.useEffect)(()=>{n?t(y(n)):o&&t(w(o))},[n,o,t]);let c=(0,a.useCallback)(e=>{t((0,d.po)(e))},[t]),u=(0,a.useCallback)(e=>{t(b({content:e}))},[t]),m=(0,a.useCallback)(e=>{t(N({messageId:e}))},[t]),x=(0,a.useCallback)((e,r)=>{t(k({messageId:e,content:r}))},[t]),h=(0,a.useCallback)(e=>{t(S({messageId:e}))},[t]);return{session:r,character:null==r?void 0:r.character,isLoading:null==r?void 0:r.isLoading,sidebarOpen:s,setSidebarOpen:c,sendMessage:u,deleteMessage:m,updateMessage:x,regenerateMessage:h}}var M=r(6874),T=r.n(M),E=r(3500),I=r(1394);function L(e){let{activeStoryId:t,isOpen:r=!0,onClose:n}=e,[l,i]=(0,a.useState)(!0),{stories:o,isLoading:d,error:c,fetchStories:u}=(0,E.R7)();(0,a.useEffect)(()=>{o.length>0&&i(!1)},[o]),(0,a.useEffect)(()=>{let e=setTimeout(()=>{l&&0===o.length&&(console.log("StorySidebar: loading timeout, forcing end of loading state"),i(!1))},3e3);return()=>clearTimeout(e)},[l,o.length]),(0,a.useEffect)(()=>{},[u]);let m=e=>{if(!e)return{date:"",time:""};let t=new Date(e);return{date:"".concat(t.getMonth()+1,"-").concat(t.getDate()),time:t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}},x=()=>{n&&n()},h=e=>{let{story:r}=e,{avatarUrl:a,characterName:n,createdAt:l,lastMessageAt:i,title:o}=r,d=m(l?new Date(l):Date.now());return(0,s.jsxs)(T(),{href:"/chat?storyId=".concat(r.id),onClick:x,className:"flex items-center p-4 hover:bg-muted ".concat(r.id===t?"bg-muted":""),children:[(0,s.jsx)("div",{className:"relative h-10 w-10 rounded-full overflow-hidden mr-3",children:(0,s.jsxs)(I.eu,{className:"h-full w-full",children:[(0,s.jsx)(I.BK,{src:a||"",alt:o||"",className:"object-cover"}),(0,s.jsx)(I.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==o?void 0:o.charAt(0).toUpperCase())||"S"})]})}),(0,s.jsx)("div",{className:"flex-1 min-w-0",children:(0,s.jsx)("div",{className:"text-foreground font-medium truncate",children:o||"未命名"})}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground whitespace-nowrap flex-shrink-0 ml-2",children:d.date})]})};return(0,s.jsxs)("div",{className:"\n        ".concat(r?"translate-x-0":"-translate-x-full","\n        fixed md:relative md:translate-x-0\n        w-[280px] md:w-72 h-screen pt-12 bg-[var(--bg-primary)] border-r border-[var(--border-color)] flex flex-col\n        transition-transform duration-300 ease-in-out z-30\n      "),children:[(0,s.jsx)("div",{className:"p-1 sm:p-2 flex items-center justify-end",children:(0,s.jsx)("button",{onClick:n,className:"text-muted-foreground hover:text-foreground p-2 md:hidden","aria-label":"关闭侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar scrollbar-thin scrollbar-track-background scrollbar-thumb-border hover:scrollbar-thumb-border/80",children:l?(0,s.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,s.jsxs)("svg",{className:"animate-spin h-8 w-8 text-foreground",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):0===o.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),(0,s.jsx)("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"暂无聊天记录"}),(0,s.jsx)("p",{className:"text-muted-foreground mt-2",children:"开始与角色聊天创建新的故事"})]}):o.map(e=>(0,s.jsx)(h,{story:e},e.id))}),r&&(0,s.jsx)("div",{className:"fixed inset-0 bg-background/70 z-20 md:hidden",onClick:n,"aria-hidden":"true"})]})}var D=r(6766),B=r(285),A=r(4752),_=r.n(A),z=r(4149),O=r.n(z);let R=O()(_()),U=[{id:"standard",name:"标准",description:"对话内容清晰流畅，表达平实"},{id:"creative",name:"创意",description:"对话内容富有创意，表达活泼生动"}];function W(e){let{selectedStyle:t,onStyleSelect:r}=e;return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"风格"}),(0,s.jsxs)(B.$,{variant:"outline",onClick:()=>{R.fire({title:"选择对话风格",html:(0,s.jsx)("div",{className:"style-selector-container mt-4",children:U.map(e=>(0,s.jsxs)(B.$,{variant:"ghost",className:"w-full justify-start h-auto py-3 mb-2",onClick:()=>{r(e.name),R.close()},children:[(0,s.jsxs)("div",{className:"flex-1 text-left",children:[(0,s.jsx)("div",{className:"text-sm font-medium",children:e.name}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.description})]}),t===e.name&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]},e.id))}),showConfirmButton:!1,showCloseButton:!0,customClass:{container:"style-dialog-container",popup:"model-dialog-popup",htmlContainer:"model-dialog-html-container p-0"},width:"400px"})},className:"w-full justify-between",children:[(0,s.jsx)("span",{children:t}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]})]})}var $=r(2523),H=r(4540),K=r(6525),V=r(7374);let G=["/backgrounds/bg1.jpg","/backgrounds/bg2.jpg","/backgrounds/bg3.jpg","/backgrounds/bg4.jpg","/backgrounds/bg5.jpg","/backgrounds/bg6.jpg","/backgrounds/bg7.jpg","/backgrounds/bg8.jpg","/backgrounds/bg9.jpg"];function P(e){let{isOpen:t=!0,onClose:r,onBackgroundChange:n,chatTitle:l="故事",onChatTitleChange:i}=e;(0,H.wA)();let{deleteStory:o,currentStoryId:d}=(0,E.R7)();(0,H.d4)(K.st);let[c,u]=(0,a.useState)("1000"),[m,x]=(0,a.useState)(null),[h,g]=(0,a.useState)("标准"),[p,f]=(0,a.useState)(l);(0,a.useEffect)(()=>{f(l)},[l]);let v=e=>{x(e),n&&n(e)},j=async()=>{d?(await (0,V.lJ)({title:'"'.concat(p,'"'),text:"确定要删除吗？",confirmButtonText:"删除",cancelButtonText:"取消"})).isConfirmed&&(o(d),null==r||r()):console.error("无法删除故事：未找到当前故事ID")};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"\n          ".concat(t?"translate-x-0":"translate-x-full","\n          fixed md:relative md:translate-x-0\n          w-80 md:w-80 h-screen bg-[var(--bg-primary)] shadow-lg border-l border-[var(--border-color)]\n          transition-transform duration-300 ease-in-out z-30 text-foreground p-4 md:pt-12 settings-panel\n          top-0 md:top-0 right-0\n        "),onKeyDown:e=>{e.stopPropagation()},children:[(0,s.jsxs)("div",{className:"flex justify-between pt-3 items-center mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"设置"}),(0,s.jsxs)("div",{className:"flex space-x-4",children:[(0,s.jsx)(B.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"}),(0,s.jsx)("polyline",{points:"16 6 12 2 8 6"}),(0,s.jsx)("line",{x1:"12",y1:"2",x2:"12",y2:"15"})]})}),(0,s.jsx)(B.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})})}),(0,s.jsx)(B.$,{variant:"ghost",size:"icon",onClick:()=>{p!==l&&i&&i(p),null==r||r()},className:"text-muted-foreground hover:text-foreground md:hidden",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"故事标题"}),(0,s.jsx)($.p,{type:"text",value:p,onChange:e=>{f(e.target.value)}})]}),(0,s.jsxs)("div",{className:"pt-1",children:[(0,s.jsxs)(B.$,{variant:"outline",className:"w-full flex items-center justify-center",onClick:j,children:[(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,s.jsx)("polyline",{points:"3 6 5 6 21 6"}),(0,s.jsx)("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),"删除故事"]}),(0,s.jsx)("div",{className:"mt-6 border-t border-border"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"最大回复Token数量"}),(0,s.jsx)($.p,{type:"text",value:c,onChange:e=>u(e.target.value)})]}),(0,s.jsx)(W,{selectedStyle:h,onStyleSelect:e=>{g(e)}}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("label",{className:"text-sm block",children:"背景图片"}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-2",children:G.map((e,t)=>(0,s.jsx)("div",{className:"relative h-20 w-full rounded-md overflow-hidden cursor-pointer border-2 ".concat(m===e?"border-primary":"border-transparent"),onClick:()=>v(e),children:(0,s.jsx)(D.default,{src:e,alt:"背景".concat(t+1),fill:!0,className:"object-cover"})},t))})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"自定义背景"}),(0,s.jsxs)("label",{className:"flex items-center justify-center p-2 bg-muted border border-border rounded-md cursor-pointer hover:bg-border",children:[(0,s.jsx)("span",{className:"text-foreground",children:"选择文件"}),(0,s.jsx)("input",{type:"file",className:"hidden",accept:"image/*",onChange:e=>{e.target.files&&e.target.files[0]&&v(URL.createObjectURL(e.target.files[0]))},onKeyDown:e=>{"Escape"===e.key&&e.stopPropagation()}})]})]})]})]}),t&&(0,s.jsx)("div",{className:"fixed inset-0 bg-background/70 z-20 md:hidden",onClick:r,"aria-hidden":"true"})]})}var q=r(3315),X=r(5175);function F(e){var t;let{messages:r,character:n,user:l,isSending:i,isTempContext:o,onDeleteMessage:d,onUpdateMessage:c,onRegenerateMessage:u}=e,[m,x]=(0,a.useState)(null),{formatChat:h}=(0,q.L)();return(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[r.map(e=>{var t;return(0,s.jsx)(X.q,{message:{...e,createdAt:null!=(t=e.createdAt)?t:new Date},isUserMessage:"USER"===e.role,storyId:e.storyId,characterAppearance:n,userAppearance:{name:l.nickname,avatarUrl:l.avatarUrl},formatChatContent:h,hoveredMessageId:m,onHover:x,isTempContext:o,onDelete:d,onUpdate:c,onRegenerate:u},e.id)}),i&&(0,s.jsxs)("div",{className:"flex justify-start",children:[(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(I.eu,{className:"h-full w-full",children:[(0,s.jsx)(I.BK,{src:n.avatarUrl,alt:n.name,className:"object-cover",shouldBlur:n.shouldBlurAvatar}),(0,s.jsx)(I.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(t=n.name)?void 0:t.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsx)("div",{className:"bg-card text-foreground rounded-lg p-2 sm:p-3 max-w-[80%]",children:(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.2s"}}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.4s"}})]})})]})]})}function Z(e){let{isSending:t,onSendMessage:r,isStoryMode:n}=e,[l,i]=(0,a.useState)(""),o=()=>{l.trim()&&!t&&(r(l),i(""))};return n?(0,s.jsx)("div",{className:"p-4",children:(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("textarea",{value:l,onChange:e=>i(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),o())},placeholder:"输入消息...",className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 pr-12 py-3 text-sm resize-none",rows:1,maxLength:1e3}),(0,s.jsx)("button",{onClick:o,disabled:t||!l.trim(),className:"absolute right-3 top-1/2 -translate-y-1/2 bg-primary h-8 w-8 rounded-full flex items-center justify-center"})]})}):(0,s.jsx)("div",{className:"p-4",children:(0,s.jsx)("button",{onClick:()=>r(""),className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full py-3 text-sm sm:text-base text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]/90 transition-colors",children:"开启新故事"})})}var J=r(5844);let Q=O()(_());function Y(){let e=(0,H.wA)(),t=(0,H.d4)(K.z7),r=(0,H.d4)(K.rN),n=(0,H.d4)(K.st);(0,a.useEffect)(()=>{"idle"===n&&e((0,J.ZC)())},[e,n]);let l=t=>{e((0,J.xH)(t))};return(0,s.jsx)("div",{className:"space-y-2",children:(0,s.jsxs)(B.$,{variant:"ghost",onClick:()=>{Q.fire({title:"选择模型",html:(0,s.jsx)("div",{className:"model-selector-container max-h-[400px] overflow-y-auto mt-4",children:"loading"===n?(0,s.jsx)("div",{className:"flex items-center justify-center w-full p-4",children:(0,s.jsx)("span",{className:"animate-pulse",children:"加载中..."})}):"succeeded"===n?(0,s.jsx)("div",{className:"space-y-2",children:t.map((e,t)=>(0,s.jsx)(B.$,{variant:"ghost",className:"w-full justify-start h-auto py-3 px-4",onClick:()=>{l(e),Q.close()},children:(0,s.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-foreground",children:e.name}),r&&r.id===e.id&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground mt-1",children:e.description}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground mt-1",children:e.price}),e.isDefault&&(0,s.jsx)("div",{className:"text-xs text-primary mt-1",children:"默认模型"})]})},t))}):(0,s.jsx)("div",{className:"text-center p-4",children:(0,s.jsx)("p",{children:"加载模型失败"})})}),showConfirmButton:!1,showCloseButton:!0,customClass:{container:"model-dialog-container",popup:"model-dialog-popup",htmlContainer:"model-dialog-html-container p-0"},width:"500px"})},className:"w-full justify-start text-xs",disabled:"succeeded"!==n,children:["loading"===n?(0,s.jsx)("div",{className:"flex items-center justify-center w-full",children:(0,s.jsx)("span",{className:"animate-pulse",children:"加载中..."})}):r?(0,s.jsx)("div",{className:"flex items-center",children:(0,s.jsx)("div",{className:"flex-1 text-left",children:(0,s.jsx)("div",{className:"text-xs",children:r.name})})}):(0,s.jsx)("span",{children:"选择模型"}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]})})}function ee(e){var t;let{character:r,onOpenSidebar:a,onOpenSettings:n}=e;return(0,s.jsxs)("div",{className:"bg-card p-2 flex items-center border-b shrink-0",children:[(0,s.jsx)("button",{onClick:a,className:"mr-3 text-foreground p-1 md:hidden","aria-label":"打开侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),(0,s.jsx)("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),(0,s.jsx)("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),(0,s.jsx)("div",{className:"relative h-10 w-10 rounded-full overflow-hidden mr-3 flex-shrink-0",children:(0,s.jsxs)(I.eu,{className:"h-full w-full",children:[(0,s.jsx)(I.BK,{src:r.avatarUrl,alt:r.name,className:"object-cover"}),(0,s.jsx)(I.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(t=r.name)?void 0:t.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsx)("div",{className:"flex-1 min-w-0",children:(0,s.jsx)("h2",{className:"font-semibold truncate",children:r.name})}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(Y,{}),(0,s.jsx)("button",{onClick:n,className:"text-foreground p-2 rounded-full hover:bg-muted","aria-label":"设置",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})]})]})}function et(e){let{character:t}=e;(0,l.useRouter)();let{session:r,sidebarOpen:n,setSidebarOpen:d,sendMessage:c,deleteMessage:u,updateMessage:m,regenerateMessage:x}=C(),h=(0,i.G)(o.xu),g=(0,i.G)(o.vc),[p,f]=(0,a.useState)(!1),[v,j]=(0,a.useState)(null),y=(0,a.useRef)(null);return((0,a.useEffect)(()=>{var e;null==(e=y.current)||e.scrollIntoView({behavior:"smooth"})},[null==r?void 0:r.messages,null==r?void 0:r.isSending]),r)?(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)("div",{className:"flex h-[calc(100vh-4rem)] overflow-hidden",children:[(0,s.jsx)(L,{activeStoryId:"story"===r.mode?r.id:"",isOpen:n,onClose:()=>d(!1)}),(0,s.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden",children:[(0,s.jsx)(ee,{character:t,onOpenSidebar:()=>d(!0),onOpenSettings:()=>f(!0)}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto relative",style:v?{backgroundImage:"url(".concat(v,")"),backgroundSize:"cover"}:{},children:[v&&(0,s.jsx)("div",{className:"absolute inset-0 bg-background z-0"}),(0,s.jsxs)("div",{className:"relative z-10",children:[(0,s.jsx)(F,{messages:r.messages,character:t,user:{nickname:null==h?void 0:h.nickname,avatarUrl:g},isSending:r.isSending,isTempContext:"character"===r.mode,onDeleteMessage:u,onUpdateMessage:m,onRegenerateMessage:x}),(0,s.jsx)("div",{ref:y})]})]}),(0,s.jsx)(Z,{isSending:r.isSending,onSendMessage:c,isStoryMode:"story"===r.mode})]}),(0,s.jsx)(P,{isOpen:p,onClose:()=>f(!1),onBackgroundChange:j,chatTitle:r.title,onChatTitleChange:e=>{console.log("Update title to:",e)}})]})}):(0,s.jsx)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"正在加载会话..."})})}function er(){return(0,s.jsxs)("main",{className:"min-h-screen bg-background relative",children:[(0,s.jsx)(n.default,{}),(0,s.jsx)("div",{className:"pt-16",children:(0,s.jsx)(a.Suspense,{fallback:(0,s.jsx)(es,{}),children:(0,s.jsx)(ea,{})})})]})}function es(){return(0,s.jsxs)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:[(0,s.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-primary motion-reduce:animate-[spin_1.5s_linear_infinite]",children:(0,s.jsx)("span",{className:"sr-only",children:"Loading..."})}),(0,s.jsx)("p",{className:"ml-3 text-foreground",children:"正在加载聊天数据..."})]})}function ea(){var e;let{character:t,session:r,isLoading:a}=C();return!a&&r&&t?(0,s.jsx)(et,{character:t,error:null!=(e=r.error)?e:null,clearError:()=>{}}):(0,s.jsx)(es,{})}},2523:(e,t,r)=>{"use strict";r.d(t,{p:()=>l});var s=r(5155),a=r(2115),n=r(9434);let l=a.forwardRef((e,t)=>{let{className:r,type:a,...l}=e;return(0,s.jsx)("input",{type:a,className:(0,n.cn)("flex h-10 w-full rounded-md border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",r),ref:t,...l})});l.displayName="Input"},4149:function(e,t,r){e.exports=function(e,t){"use strict";let r=[{key:"title",getter:e=>e.getTitle()},{key:"html",getter:e=>e.getHtmlContainer()},{key:"confirmButtonText",getter:e=>e.getConfirmButton()},{key:"denyButtonText",getter:e=>e.getDenyButton()},{key:"cancelButtonText",getter:e=>e.getCancelButton()},{key:"footer",getter:e=>e.getFooter()},{key:"closeButtonHtml",getter:e=>e.getCloseButton()},{key:"iconHtml",getter:e=>e.getIconContent()},{key:"loaderHtml",getter:e=>e.getLoader()}],s=()=>{};return function(a){function n(t){let s={},a={},n=r.map(e=>e.key);return Object.entries(t).forEach(t=>{let[r,l]=t;n.includes(r)&&e.isValidElement(l)?(s[r]=l,a[r]=" "):a[r]=l}),[s,a]}function l(e,s){Object.entries(s).forEach(s=>{let[n,l]=s,i=r.find(e=>e.key===n).getter(a),o=t.createRoot(i);o.render(l),e.__roots.push(o)})}function i(e){e.__roots.forEach(e=>{e.unmount()}),e.__roots=[]}return class extends a{static argsToParams(t){if(!(e.isValidElement(t[0])||e.isValidElement(t[1])))return a.argsToParams(t);{let e={};return["title","html","icon"].forEach((r,s)=>{void 0!==t[s]&&(e[r]=t[s])}),e}}_main(e,t){this.__roots=[],this.__params=Object.assign({},t,e);let[r,a]=n(this.__params),o=a.willOpen||s,d=a.didOpen||s,c=a.didDestroy||s;return super._main(Object.assign({},a,{willOpen:e=>{l(this,r),o(e)},didOpen:e=>{setTimeout(()=>{d(e)})},didDestroy:e=>{c(e),i(this)}}))}update(e){Object.assign(this.__params,e),i(this);let[t,r]=n(this.__params);super.update(r),l(this,t)}}}}(r(2115),r(2669))},5844:(e,t,r)=>{"use strict";r.d(t,{Ay:()=>x,ZC:()=>d,xH:()=>m});var s=r(6439),a=r(9249),n=r(6168),l=r(3299);class i{async getVirtualModels(){try{return(await n.o.models.getVirtualModels()).data}catch(e){throw console.error("Failed to get virtual models:",e),e}}}let o=new(i=(0,a.Cg)([l.A.Singleton],i)),d=(0,s.zD)("model/fetchModels",async()=>(await o.getVirtualModels()).models),c=e=>e.map(e=>({id:e.id,name:e.name,description:e.description||"暂无描述",price:e.pricePerK?"".concat(JSON.stringify(e.pricePerK),"/1K tokens"):"价格待定",isDefault:e.isDefault})),u=(0,s.Z0)({name:"model",initialState:{models:[],uiModels:[],selectedModel:null,status:"idle",error:null},reducers:{setSelectedModel:(e,t)=>{e.selectedModel=t.payload}},extraReducers:e=>{e.addCase(d.pending,e=>{e.status="loading"}).addCase(d.fulfilled,(e,t)=>{if(e.status="succeeded",e.models=t.payload,e.uiModels=c(t.payload),!e.selectedModel&&e.uiModels.length>0){let t=e.uiModels.find(e=>e.isDefault);e.selectedModel=t||e.uiModels[0]}}).addCase(d.rejected,(e,t)=>{e.status="failed",e.error=t.error.message||null})}}),{setSelectedModel:m}=u.actions,x=u.reducer},5939:(e,t,r)=>{"use strict";r.d(t,{$c:()=>i,G0:()=>c,Mw:()=>m,Nh:()=>o,Nq:()=>a,RC:()=>l,po:()=>d,tj:()=>n,xb:()=>u});let s=(0,r(6439).Z0)({name:"story",initialState:{current:null,sidebarOpen:!1},reducers:{setSession(e,t){e.current=t.payload},addMessage(e,t){e.current&&e.current.messages.push(t.payload)},deleteMessage(e,t){e.current&&(e.current.messages=e.current.messages.filter(e=>e.id!==t.payload))},setSending(e,t){e.current&&(e.current.isSending=t.payload)},setError(e,t){e.current&&(e.current.error=t.payload)},setSidebarOpen(e,t){e.sidebarOpen=t.payload},setRegeneratingMessageId(e,t){e.current&&(e.current.regeneratingMessageId=t.payload)},setDeletingMessageId(e,t){e.current&&(e.current.deletingMessageId=t.payload)}}}),{setSession:a,addMessage:n,deleteMessage:l,setSending:i,setError:o,setSidebarOpen:d,setRegeneratingMessageId:c,setDeletingMessageId:u}=s.actions,m=s.reducer},6773:(e,t,r)=>{Promise.resolve().then(r.bind(r,2138))}},e=>{var t=t=>e(e.s=t);e.O(0,[951,320,105,428,116,455,476,907,613,127,694,561,441,684,358],()=>t(6773)),_N_E=e.O()}]);