(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[457],{795:(e,t,r)=>{"use strict";r.d(t,{d:()=>y});var s=r(5155),l=r(2115),a=r(5185),n=r(6101),o=r(6081),i=r(5845),c=r(1275),d=r(3655),u="Switch",[m,x]=(0,o.A)(u),[h,g]=m(u),f=l.forwardRef((e,t)=>{let{__scopeSwitch:r,name:o,checked:c,defaultChecked:m,required:x,disabled:g,value:f="on",onCheckedChange:p,form:v,...w}=e,[y,N]=l.useState(null),k=(0,n.s)(t,e=>N(e)),C=l.useRef(!1),L=!y||v||!!y.closest("form"),[S,E]=(0,i.i)({prop:c,defaultProp:null!=m&&m,onChange:p,caller:u});return(0,s.jsxs)(h,{scope:r,checked:S,disabled:g,children:[(0,s.jsx)(d.sG.button,{type:"button",role:"switch","aria-checked":S,"aria-required":x,"data-state":j(S),"data-disabled":g?"":void 0,disabled:g,value:f,...w,ref:k,onClick:(0,a.m)(e.onClick,e=>{E(e=>!e),L&&(C.current=e.isPropagationStopped(),C.current||e.stopPropagation())})}),L&&(0,s.jsx)(b,{control:y,bubbles:!C.current,name:o,value:f,checked:S,required:x,disabled:g,form:v,style:{transform:"translateX(-100%)"}})]})});f.displayName=u;var p="SwitchThumb",v=l.forwardRef((e,t)=>{let{__scopeSwitch:r,...l}=e,a=g(p,r);return(0,s.jsx)(d.sG.span,{"data-state":j(a.checked),"data-disabled":a.disabled?"":void 0,...l,ref:t})});v.displayName=p;var b=l.forwardRef((e,t)=>{let{__scopeSwitch:r,control:a,checked:o,bubbles:i=!0,...d}=e,u=l.useRef(null),m=(0,n.s)(u,t),x=function(e){let t=l.useRef({value:e,previous:e});return l.useMemo(()=>(t.current.value!==e&&(t.current.previous=t.current.value,t.current.value=e),t.current.previous),[e])}(o),h=(0,c.X)(a);return l.useEffect(()=>{let e=u.current;if(!e)return;let t=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"checked").set;if(x!==o&&t){let r=new Event("click",{bubbles:i});t.call(e,o),e.dispatchEvent(r)}},[x,o,i]),(0,s.jsx)("input",{type:"checkbox","aria-hidden":!0,defaultChecked:o,...d,tabIndex:-1,ref:m,style:{...d.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});function j(e){return e?"checked":"unchecked"}b.displayName="SwitchBubbleInput";var w=r(9434);let y=l.forwardRef((e,t)=>{let{className:r,...l}=e;return(0,s.jsx)(f,{className:(0,w.cn)("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-[var(--switch-checked-bg)] data-[state=unchecked]:bg-[var(--switch-unchecked-bg)]",r),...l,ref:t,children:(0,s.jsx)(v,{className:(0,w.cn)("pointer-events-none block h-4 w-4 rounded-full bg-[var(--switch-thumb-bg)] shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})})});y.displayName=f.displayName},2523:(e,t,r)=>{"use strict";r.d(t,{p:()=>n});var s=r(5155),l=r(2115),a=r(9434);let n=l.forwardRef((e,t)=>{let{className:r,type:l,...n}=e;return(0,s.jsx)("input",{type:l,className:(0,a.cn)("flex h-10 w-full rounded-md border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",r),ref:t,...n})});n.displayName="Input"},3315:(e,t,r)=>{"use strict";r.d(t,{L:()=>x});var s=r(2115),l=r(822),a=r(9161),n=r.n(a),o=function(e){return e.ENGLISH="ENGLISH",e.CURLY="CURLY",e.GUILLEMETS="GUILLEMETS",e.CORNER="CORNER",e.WHITE_CORNER="WHITE_CORNER",e.FULLWIDTH="FULLWIDTH",e}(o||{}),i=function(e){return e[e.USER_INPUT=0]="USER_INPUT",e[e.AI_OUTPUT=1]="AI_OUTPUT",e[e.SLASH_COMMAND=2]="SLASH_COMMAND",e[e.WORLD_INFO=3]="WORLD_INFO",e[e.AUTHOR_NOTE=4]="AUTHOR_NOTE",e[e.INSTRUCT=5]="INSTRUCT",e[e.RAW_INPUT=6]="RAW_INPUT",e[e.REPLACEMENT=7]="REPLACEMENT",e[e.REASONING=8]="REASONING",e}({});class c{setVariable(e,t){this.environment[e]=t}addRegexRule(e){this.regexRules.push(e)}format(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return"";let r=this.substituteVariables(e);if(r=this.applyRegexRules(r,1,t),r=this.processQuotes(r),!1!==t.isMarkdown&&(r=this.convertMarkdown(r)),r=this.encodeStyleTags(r),!t.skipSanitize){let e={ALLOWED_TAGS:["div","span","a","p","br","strong","em","b","i","ul","ol","li","code","pre","blockquote","q","img","h1","h2","h3","h4","h5","h6","table","thead","tbody","tr","th","td","hr","del","ins","mark","custom-style","sup","sub"],ALLOWED_ATTR:["href","src","class","style","title","alt","target","rel","id","width","height"],ADD_TAGS:["custom-style"],ADD_ATTR:["target","rel"],FORBID_TAGS:["style","script"],FORBID_ATTR:["onerror","onload","onclick"]};t.allowUnsafeHTML&&(e.ALLOW_UNKNOWN_PROTOCOLS=!0,e.ALLOW_ARIA_ATTR=!0);let s=l.A.sanitize(r,e);r="string"==typeof s?s:String(s)}return this.decodeStyleTags(r)}substituteVariables(e){var t,r;if(!e)return"";let s=e;for(let e in this.environment)if(Object.prototype.hasOwnProperty.call(this.environment,e)){let t=this.environment[e],r=RegExp("{{".concat(this.escapeRegex(e),"}}"),"gi");s=s.replace(r,"function"==typeof t?t():t.toString())}return(s=s.replace(/<USER>/gi,(null==(t=this.environment.user)?void 0:t.toString())||"")).replace(/<CHAR>/gi,(null==(r=this.environment.char)?void 0:r.toString())||"")}applyRegexRules(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!e||0===this.regexRules.length)return e;let s=e;for(let e of this.regexRules.filter(e=>!e.disabled&&e.placement.includes(t)&&(!e.markdownOnly&&!e.promptOnly||e.markdownOnly&&r.isMarkdown||e.promptOnly&&r.isPrompt)&&(!r.isEdit||!1!==e.runOnEdit)&&(void 0===r.depth||void 0===e.minDepth||r.depth>=e.minDepth)&&(void 0===r.depth||void 0===e.maxDepth||r.depth<=e.maxDepth)))try{let t=RegExp(e.find,"g");s="string"==typeof e.replace?s.replace(t,e.replace):s.replace(t,function(t){for(var r=arguments.length,s=Array(r>1?r-1:0),l=1;l<r;l++)s[l-1]=arguments[l];return(0,e.replace)(t,...s)})}catch(t){console.error('正则表达式规则 "'.concat(e.name,'" 应用失败:'),t)}return s}processQuotes(e){return e?e=(e=(e=e.replace(/<([^>]+)>/g,(e,t)=>"<"+t.replace(/"/g,"￾")+">")).replace(/```[\s\S]*?```|``[\s\S]*?``|`[\s\S]*?`|(".*?")|(\u201C.*?\u201D)|(\u00AB.*?\u00BB)|(\u300C.*?\u300D)|(\u300E.*?\u300F)|(\uFF02.*?\uFF02)/gm,(e,t,r,s,l,a,n)=>{if(t)return'<q>"'.concat(t.slice(1,-1),'"</q>');if(r)return'<q>"'.concat(r.slice(1,-1),'"</q>');if(s)return"<q>\xab".concat(s.slice(1,-1),"\xbb</q>");if(l)return"<q>「".concat(l.slice(1,-1),"」</q>");if(a)return"<q>『".concat(a.slice(1,-1),"』</q>");else if(n)return"<q>＂".concat(n.slice(1,-1),"＂</q>");else return e})).replace(/\ufffe/g,'"'):""}convertMarkdown(e){if(!e)return"";e=(e=e.replaceAll("\\begin{align*}","$$")).replaceAll("\\end{align*}","$$");let t=this.converter.makeHtml(e);return(t=(t=(t=(t=t.replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/\n/gm,"\0"))).replace(/\u0000/g,"\n")).replace(/<code(.*)>[\s\S]*?<\/code>/g,e=>e.replace(/&amp;/g,"&"))).replace(/<pre><code(.*?)>([\s\S]*?)<\/code><\/pre>/g,(e,t,r)=>'<pre style="overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code'.concat(t,">").concat(r,"</code></pre>"))).trim()}encodeStyleTags(e){return e?e.replace(/<style>([^]*?)<\/style>/g,(e,t)=>"<custom-style>".concat(escape(t),"</custom-style>")):""}decodeStyleTags(e){return e?e.replace(/<custom-style>([^]*?)<\/custom-style>/g,(e,t)=>{try{let e=unescape(t).replace(/<br\/>/g,"");return"<style>".concat(e,"</style>")}catch(e){return"CSS ERROR: ".concat(e)}}):""}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}formatWithRegexOnly(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.applyRegexRules(e,t,r)}substituteOnly(e){return this.substituteVariables(e)}processQuotesOnly(e){return this.processQuotes(e)}markdownOnly(e){return this.convertMarkdown(e)}constructor(e={},t=[]){this.regexRules=[],this.environment={},this.environment=e,this.regexRules=t,this.converter=new(n()).Converter({tables:!0,simpleLineBreaks:!0,strikethrough:!0,literalMidWordUnderscores:!0,tasklists:!0,smoothLivePreview:!0,smartIndentationFix:!0}),this.converter.setOption("openLinksInNewWindow",!0),this.converter.setOption("ghMentions",!1),this.converter.setOption("emoji",!0)}}new c;let d=new c;function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))d.setVariable(e,r);return d.format(e)}d.addRegexRule({name:"表情符号替换",find:":(smile|grin|laugh|wink|heart|cry|sob|angry):",replace:(e,t)=>({smile:"\uD83D\uDE0A",grin:"\uD83D\uDE01",laugh:"\uD83D\uDE02",wink:"\uD83D\uDE09",heart:"❤️",cry:"\uD83D\uDE22",sob:"\uD83D\uDE2D",angry:"\uD83D\uDE20"})[t]||e,placement:[i.AI_OUTPUT,i.USER_INPUT]}),d.addRegexRule({name:"强调内容",find:"\\*\\*([^*]+)\\*\\*",replace:"<strong>$1</strong>",placement:[i.AI_OUTPUT,i.USER_INPUT]}),d.addRegexRule({name:"斜体内容",find:"\\*([^*]+)\\*",replace:"<em>$1</em>",placement:[i.AI_OUTPUT,i.USER_INPUT]});var m=r(2045);function x(){let e=(0,m.G)(e=>e.user.currentUser),t=(null==e?void 0:e.username)||"User",r=(0,s.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u(e,t)},[]),l=(0,s.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(let[e,r]of Object.entries(t))d.setVariable(e,r);return d.substituteOnly(e)}(e,t)},[]);return{format:r,substitute:l,formatChat:(0,s.useCallback)(function(e,r){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return u(e,{user:t,char:r,...s})}(e,t,r,s)},[t]),formatWithDateTime:(0,s.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u(e,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString(),...t})},[])}}},5844:(e,t,r)=>{"use strict";r.d(t,{A:()=>h,Z:()=>m});var s=r(6439),l=r(9249),a=r(6168),n=r(3299);class o{async getModels(){try{return(await a.o.models.getModels()).data}catch(e){throw console.error("Failed to get models:",e),e}}}let i=new(o=(0,l.Cg)([n.A.Singleton],o)),c={max:{title:"Max系列: 极限性能，极致体验",description:"",sortOrder:1},xl:{title:"XL系列: 均衡性价比，优良体验",description:"",sortOrder:2},turbo:{title:"Turbo: 快速响应，经久耐用",description:"",sortOrder:3},medium:{title:"Medium: 稳定可靠，性价比优",description:"",sortOrder:4},legacy:{title:"Legacy: 经典模型，休闲首选",description:"",sortOrder:5}},d=e=>e.includes("max")?"max":e.includes("xl")?"xl":e.includes("turbo")?"turbo":e.includes("medium")?"medium":"legacy",u=e=>e.includes("max")||e.includes("xl")?"bg-primary":e.includes("turbo")?"bg-secondary":(e.includes("medium"),"bg-accent"),m=(0,s.zD)("model/fetchModels",async()=>(await i.getModels()).models),x=e=>{let t={};return Object.keys(c).forEach(e=>{t[e]=[]}),e.forEach(e=>{let r=d(e.id);t[r]&&t[r].push({id:e.id,name:e.name,description:"string"==typeof e.description?e.description:"适合各种AI对话场景",icon:u(e.id),price:"".concat(e.outputPricePerK,"规范/1K tokens"),contextLength:e.contextLength,freeQuota:e.pointsPerMessage?50:void 0})}),Object.entries(t).filter(e=>{let[t,r]=e;return r.length>0}).map(e=>{let[t,r]=e;return{title:c[t].title,description:c[t].description,sortOrder:c[t].sortOrder,models:r}}).sort((e,t)=>e.sortOrder-t.sortOrder)},h=(0,s.Z0)({name:"model",initialState:{models:[],modelGroups:[],status:"idle",error:null},reducers:{},extraReducers:e=>{e.addCase(m.pending,e=>{e.status="loading"}).addCase(m.fulfilled,(e,t)=>{e.status="succeeded",e.models=t.payload,e.modelGroups=x(t.payload)}).addCase(m.rejected,(e,t)=>{e.status="failed",e.error=t.error.message||null})}}).reducer},6525:(e,t,r)=>{"use strict";r.d(t,{OD:()=>a,st:()=>n});var s=r(8924);let l=e=>e.app.model,a=e=>l(e).modelGroups,n=e=>l(e).status;(0,s.Mz)([e=>l(e).models,(e,t)=>t],(e,t)=>e.find(e=>e.id===t)||null)},6773:(e,t,r)=>{Promise.resolve().then(r.bind(r,7624))},7624:(e,t,r)=>{"use strict";r.d(t,{default:()=>Z});var s=r(5155),l=r(2115),a=r(5695),n=r(5298),o=r(285),i=r(6766);let c=[{id:"1",name:"1",image:"/voice-actors/actor1.jpg",gender:"女",type:"公有",code:"11"},{id:"1188",name:"1188",image:"/voice-actors/actor2.jpg",gender:"女",type:"公有",code:"8"},{id:"1.1",name:"1.1 dy霸总萧炎",image:"/voice-actors/actor3.jpg",gender:"男",type:"公有",code:"中气十足男声"},{id:"1314",name:"1314",image:"/voice-actors/actor1.jpg",gender:"女",type:"公有",code:"1314"},{id:"2",name:"2",image:"/voice-actors/actor2.jpg",gender:"女",type:"公有",code:"自用"},{id:"2211",name:"2211",image:"/voice-actors/actor3.jpg",gender:"女",type:"公有",code:"1122"}];function d(e){let{isOpen:t,onClose:r,onSelect:a}=e,[n,d]=(0,l.useState)("全部"),[u,m]=(0,l.useState)(""),[x,h]=(0,l.useState)(!1),g=(0,l.useRef)(null);(0,l.useEffect)(()=>{let e=e=>{g.current&&!g.current.contains(e.target)&&r()};return t&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[t,r]);let f=c.filter(e=>{let t="全部"===n||"男声"===n&&"男"===e.gender||"女声"===n&&"女"===e.gender,r=""===u||e.name.toLowerCase().includes(u.toLowerCase())||e.code.toLowerCase().includes(u.toLowerCase());return t&&r});return t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-50",onClick:r}),(0,s.jsx)("div",{className:"fixed inset-0 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{ref:g,className:"bg-[var(--bg-primary)] rounded-lg w-[900px] max-w-[90%] max-h-[90vh] shadow-xl overflow-hidden",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center p-4 border-b border-border",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-foreground",children:"选择声优"}),(0,s.jsx)(o.$,{onClick:r,variant:"ghost",size:"icon",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)("input",{type:"text",placeholder:"搜索声优...",value:u,onChange:e=>m(e.target.value),className:"w-full bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md p-3 text-[var(--text-primary)] focus:outline-none input-focus"})}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>h(!x),className:"min-w-[120px] flex items-center justify-between",children:[(0,s.jsx)("span",{children:n}),(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M6 9l6 6 6-6"})})]}),x&&(0,s.jsx)("div",{className:"absolute right-0 top-full mt-1 w-full bg-card rounded-md shadow-lg overflow-hidden z-60",children:(0,s.jsxs)("div",{className:"p-1",children:[(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{d("全部"),h(!1)},children:["全部"===n&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"全部"]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{d("男声"),h(!1)},children:["男声"===n&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"男声"]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"flex items-center w-full justify-start",onClick:()=>{d("女声"),h(!1)},children:["女声"===n&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"女声"]})]})})]})]}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-4 overflow-y-auto max-h-[500px] pr-2",children:f.map(e=>(0,s.jsx)("div",{className:"bg-card rounded-lg overflow-hidden",children:(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsx)("div",{className:"flex justify-center mb-3",children:(0,s.jsx)("div",{className:"relative h-16 w-16 rounded-full overflow-hidden",children:(0,s.jsx)(i.default,{src:e.image,alt:e.name,fill:!0,className:"object-cover"})})}),(0,s.jsxs)("div",{className:"flex items-center justify-center gap-2 mb-2",children:[(0,s.jsx)("h3",{className:"text-foreground font-medium",children:e.name}),(0,s.jsx)("span",{className:"bg-accent text-xs text-accent-foreground px-1 py-0.5 rounded",children:e.type})]}),(0,s.jsx)("div",{className:"text-center text-sm text-muted-foreground mb-3",children:e.code}),(0,s.jsxs)("div",{className:"text-center text-sm text-muted-foreground mb-3",children:["性别: ",e.gender]}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)(o.$,{className:"flex-1",variant:"outline",onClick:()=>a(e),children:"选择"}),(0,s.jsx)(o.$,{variant:"outline",size:"icon",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5"}),(0,s.jsx)("path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"})]})})]})]})},e.id))})]})]})})]}):null}var u=r(2523),m=r(4540),x=r(6525),h=r(5844),g=r(3500),f=r(7374);let p=["/backgrounds/bg1.jpg","/backgrounds/bg2.jpg","/backgrounds/bg3.jpg","/backgrounds/bg4.jpg","/backgrounds/bg5.jpg","/backgrounds/bg6.jpg","/backgrounds/bg7.jpg","/backgrounds/bg8.jpg","/backgrounds/bg9.jpg"];function v(e){let{isOpen:t,onClose:r,onBackgroundChange:a,chatTitle:n="故事",onChatTitleChange:c}=e,v=(0,m.wA)(),{deleteStory:b,currentStoryId:j}=(0,g.R7)(),w=(0,m.d4)(x.OD),y=(0,m.d4)(x.st),[N,k]=(0,l.useState)("1000"),[C,L]=(0,l.useState)(null),[S,E]=(0,l.useState)(!1),[R,T]=(0,l.useState)(null),[O,I]=(0,l.useState)(!1),[M,A]=(0,l.useState)(null),[U,B]=(0,l.useState)(!1),[D,z]=(0,l.useState)("标准"),[_,W]=(0,l.useState)(n);(0,l.useEffect)(()=>{"idle"===y&&v((0,h.Z)())},[v,y]),(0,l.useEffect)(()=>{if("succeeded"===y&&w.length>0&&!M){let e=w.find(e=>e.title.includes("XL"));e&&e.models.length>0?A(e.models[e.models.length-1]):w[0].models.length>0&&A(w[0].models[0])}},[w,y,M]),(0,l.useEffect)(()=>{W(n)},[n]);let P=()=>{_!==n&&c&&c(_),r()},$=e=>{L(e),a&&a(e)},F=e=>{A(e),I(!1)},V=async()=>{j?(await (0,f.lJ)({title:'"'.concat(_,'"'),text:"确定要删除吗？",confirmButtonText:"删除",cancelButtonText:"取消"})).isConfirmed&&(b(j),r()):console.error("无法删除故事：未找到当前故事ID")};return t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-50",onClick:P}),(0,s.jsxs)("div",{className:"fixed top-0 right-0 w-80 h-full bg-[var(--bg-primary)] shadow-lg border-l border-border overflow-y-auto z-50 text-foreground p-4 settings-panel",onKeyDown:e=>{e.stopPropagation(),"Escape"===e.key&&(O?(I(!1),e.preventDefault()):U&&(B(!1),e.preventDefault()))},children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"设置"}),(0,s.jsxs)("div",{className:"flex space-x-4",children:[(0,s.jsx)(o.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"}),(0,s.jsx)("polyline",{points:"16 6 12 2 8 6"}),(0,s.jsx)("line",{x1:"12",y1:"2",x2:"12",y2:"15"})]})}),(0,s.jsx)(o.$,{variant:"ghost",size:"icon",className:"text-muted-foreground hover:text-foreground",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})})}),(0,s.jsx)(o.$,{variant:"ghost",size:"icon",onClick:P,className:"text-muted-foreground hover:text-foreground",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"故事标题"}),(0,s.jsx)(u.p,{type:"text",value:_,onChange:e=>{W(e.target.value)}})]}),(0,s.jsxs)("div",{className:"pt-1",children:[(0,s.jsxs)(o.$,{variant:"outline",className:"w-full flex items-center justify-center",onClick:V,children:[(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"mr-2",children:[(0,s.jsx)("polyline",{points:"3 6 5 6 21 6"}),(0,s.jsx)("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),"删除故事"]}),(0,s.jsx)("div",{className:"mt-6 border-t border-border"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"最大回复Token数量"}),(0,s.jsx)(u.p,{type:"text",value:N,onChange:e=>k(e.target.value)})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"模型"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>I(!O),className:"w-full justify-between",disabled:"succeeded"!==y,children:["loading"===y?(0,s.jsx)("div",{className:"flex items-center justify-center w-full",children:(0,s.jsx)("span",{className:"animate-pulse",children:"加载中..."})}):M?(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"w-8 h-8 ".concat(M.icon," rounded-md flex items-center justify-center mr-2"),children:(0,s.jsx)("span",{className:"text-foreground text-xs",children:"AI"})}),(0,s.jsxs)("div",{className:"flex-1 text-left",children:[(0,s.jsx)("div",{className:"text-sm",children:M.name}),(0,s.jsxs)("div",{className:"flex justify-between text-xs text-muted-foreground",children:[(0,s.jsx)("span",{children:M.description}),(0,s.jsx)("span",{children:M.price})]})]})]}):(0,s.jsx)("span",{children:"选择模型"}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),O&&"succeeded"===y&&(0,s.jsx)("div",{className:"absolute z-50 w-full mt-1 bg-[var(--bg-primary)] border border-border rounded shadow-lg max-h-[400px] overflow-y-auto",children:w.map((e,t)=>(0,s.jsxs)("div",{className:"border-b border-border last:border-b-0",children:[e.title&&(0,s.jsx)("div",{className:"text-xs text-muted-foreground p-2 bg-card",children:e.title}),(0,s.jsx)("div",{className:"p-1",children:e.models.map((e,r)=>(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-start h-auto py-2",onClick:()=>F(e),children:[(0,s.jsx)("div",{className:"w-8 h-8 ".concat(e.icon," rounded-md flex items-center justify-center mr-2 flex-shrink-0"),children:(0,s.jsx)("span",{className:"text-foreground text-xs",children:"AI"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0 text-left",children:[(0,s.jsx)("div",{className:"text-sm text-foreground",children:e.name}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:e.description}),(0,s.jsxs)("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[(0,s.jsx)("span",{children:e.price}),e.freeQuota&&(0,s.jsxs)("span",{className:"text-accent-foreground",children:["剩余免费次数: ",e.freeQuota]})]})]}),M&&M.id===e.id&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]},"".concat(t,"-").concat(r)))})]},t))})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"风格"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(o.$,{variant:"outline",onClick:()=>B(!U),className:"w-full justify-between",children:[(0,s.jsx)("span",{children:D}),(0,s.jsx)("svg",{className:"w-4 h-4 text-muted-foreground",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),U&&(0,s.jsx)("div",{className:"absolute z-50 w-full mt-1 bg-[var(--bg-primary)] border border-border rounded shadow-lg",children:(0,s.jsxs)("div",{className:"p-1",children:[(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-between",onClick:()=>{z("标准"),B(!1)},children:[(0,s.jsx)("span",{className:"flex-1 text-left",children:"标准"}),"标准"===D&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]}),(0,s.jsxs)(o.$,{variant:"ghost",className:"w-full justify-between",onClick:()=>{z("创意"),B(!1)},children:[(0,s.jsx)("span",{className:"flex-1 text-left",children:"创意"}),"创意"===D&&(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-primary",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})]})]})})]})]}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("label",{className:"text-sm block",children:"背景图片"}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-2",children:p.map((e,t)=>(0,s.jsx)("div",{className:"relative h-20 w-full rounded-md overflow-hidden cursor-pointer border-2 ".concat(C===e?"border-primary":"border-transparent"),onClick:()=>$(e),children:(0,s.jsx)(i.default,{src:e,alt:"背景".concat(t+1),fill:!0,className:"object-cover"})},t))})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm block",children:"自定义背景"}),(0,s.jsxs)("label",{className:"flex items-center justify-center p-2 bg-muted border border-border rounded-md cursor-pointer hover:bg-border",children:[(0,s.jsx)("span",{className:"text-foreground",children:"选择文件"}),(0,s.jsx)("input",{type:"file",className:"hidden",accept:"image/*",onChange:e=>{e.target.files&&e.target.files[0]&&$(URL.createObjectURL(e.target.files[0]))},onKeyDown:e=>{"Escape"===e.key&&e.stopPropagation()}})]})]})]})]}),(0,s.jsx)(d,{isOpen:S,onClose:()=>E(!1),onSelect:e=>{T(e),E(!1)}})]}):null}var b=r(6874),j=r.n(b),w=r(1394);function y(e){let{activeStoryId:t,isOpen:r=!0,onClose:a,searchMode:n=!1}=e,[o,i]=(0,l.useState)(""),[c,d]=(0,l.useState)(!1),[u,m]=(0,l.useState)(!1),x=(0,l.useRef)(null),[h,f]=(0,l.useState)(!0),{stories:p,isLoading:v,error:b,fetchStories:y}=(0,g.R7)();(0,l.useEffect)(()=>{p.length>0&&f(!1)},[p]),(0,l.useEffect)(()=>{let e=setTimeout(()=>{h&&0===p.length&&(console.log("StorySidebar: loading timeout, forcing end of loading state"),f(!1))},3e3);return()=>clearTimeout(e)},[h,p.length]),(0,l.useEffect)(()=>{},[y]);let N=e=>{if(!e)return{date:"",time:""};let t=new Date(e);return{date:"".concat(t.getMonth()+1,"-").concat(t.getDate()),time:t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}},k=o?p.filter(e=>{var t;if(e.title&&e.title.toLowerCase().includes(o.toLowerCase()))return!0;let r="string"==typeof e.lastMessage?e.lastMessage:null==(t=e.lastMessage)?void 0:t.content;return!!(r&&r.toLowerCase().includes(o.toLowerCase()))}):p,C=()=>{a&&a()},L=()=>{i(""),m(!1),x.current&&x.current.focus()};(0,l.useEffect)(()=>{if(r&&window.innerWidth<768||r&&n){let e=setTimeout(()=>{var e;null==(e=x.current)||e.focus()},300);return()=>clearTimeout(e)}},[r,n]);let S=e=>{let{story:r}=e,{avatarUrl:l,characterName:a,lastMessage:n,lastMessageAt:o,title:i}=r,c=N(o?new Date(o):Date.now());return(0,s.jsxs)(j(),{href:"/chat?storyId=".concat(r.id),onClick:C,className:"flex items-center p-4 hover:bg-muted ".concat(r.id===t?"bg-muted":""),children:[(0,s.jsx)("div",{className:"relative h-10 w-10 rounded-full overflow-hidden mr-3",children:(0,s.jsxs)(w.eu,{className:"h-full w-full",children:[(0,s.jsx)(w.BK,{src:l,alt:i||"",className:"object-cover"}),(0,s.jsx)(w.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==i?void 0:i.charAt(0).toUpperCase())||"S"})]})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("div",{className:"text-foreground font-medium truncate",children:i||"未命名"}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:c.time})]}),(0,s.jsx)("div",{className:"text-sm text-muted-foreground truncate",children:"string"==typeof n?n:(null==n?void 0:n.content)||"无消息"}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:c.date})]})]})};return(0,s.jsxs)("div",{className:"\n        ".concat(r?"translate-x-0":"-translate-x-full","\n        fixed md:relative md:translate-x-0\n        w-[280px] md:w-72 h-full bg-[var(--bg-primary)] border-r border-border flex flex-col\n        transition-transform duration-300 ease-in-out z-30\n      "),children:[(0,s.jsxs)("div",{className:"p-4 border-b border-border flex items-center ".concat(n?"bg-muted/50":""),children:[(0,s.jsxs)("div",{className:"relative flex-1 ".concat(c||n?"ring-1 ring-border rounded-md":""),children:[(0,s.jsx)("input",{ref:x,type:"text",value:o,onChange:e=>{let t=e.target.value;i(t),t?(m(!0),setTimeout(()=>{m(!1)},300)):m(!1),t.length},onFocus:()=>d(!0),onBlur:()=>d(!1),placeholder:n?"搜索聊天...":"搜索",className:"w-full bg-[var(--bg-tertiary)] border-[var(--border-color)] rounded-md p-2 pl-9 text-[var(--text-primary)] focus:outline-none input-focus","aria-label":"搜索聊天"}),(0,s.jsx)("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 text-muted-foreground",children:u?(0,s.jsxs)("svg",{className:"animate-spin h-5 w-5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),o&&(0,s.jsx)("button",{onClick:L,className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground","aria-label":"清除搜索",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"15",y1:"9",x2:"9",y2:"15"}),(0,s.jsx)("line",{x1:"9",y1:"9",x2:"15",y2:"15"})]})})]}),(0,s.jsx)("button",{onClick:a,className:"ml-2 text-muted-foreground hover:text-foreground p-2 md:hidden","aria-label":"关闭侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,s.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar scrollbar-thin scrollbar-track-background scrollbar-thumb-border hover:scrollbar-thumb-border/80",children:h?(0,s.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,s.jsxs)("svg",{className:"animate-spin h-8 w-8 text-foreground",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,s.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,s.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):o&&0===k.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"未找到结果"}),(0,s.jsxs)("p",{className:"text-muted-foreground mt-2 mb-4",children:['没有找到与"',o,'"相关的聊天']}),(0,s.jsx)("button",{onClick:L,className:"px-4 py-2 bg-primary text-foreground rounded-md transition-colors",children:"清除搜索"})]}):0===k.length?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-64 p-4 text-center",children:[(0,s.jsx)("div",{className:"text-muted-foreground mb-4",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,s.jsx)("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),(0,s.jsx)("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),(0,s.jsx)("h3",{className:"text-foreground text-lg font-medium",children:"暂无聊天记录"}),(0,s.jsx)("p",{className:"text-muted-foreground mt-2",children:"开始与角色聊天创建新的故事"})]}):k.map(e=>(0,s.jsx)(S,{story:e},e.id))}),r&&(0,s.jsx)("div",{className:"fixed inset-0 bg-background/70 z-20 md:hidden",onClick:a,"aria-hidden":"true"})]})}var N=r(4165);function k(e){let{isOpen:t,onClose:r,title:l,onTitleChange:a,onStoryCreated:n,isCreating:i}=e;return(0,s.jsx)(N.lG,{open:t,onOpenChange:r,children:(0,s.jsxs)(N.Cf,{className:"bg-opacity-90 bg-[var(--bg-primary)] backdrop-blur-sm z-150",children:[(0,s.jsx)(N.c7,{children:(0,s.jsx)(N.L3,{children:"创建新故事"})}),(0,s.jsxs)("div",{className:"py-4",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"故事标题"}),(0,s.jsx)(u.p,{value:l,onChange:e=>a(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"输入故事标题",autoFocus:!0})]}),(0,s.jsxs)(N.Es,{children:[(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:r,children:"取消"}),(0,s.jsx)(o.$,{onClick:n,variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:i||!l.trim(),children:i?"创建中...":"创建故事"})]})]})})}var C=r(2045),L=r(1795),S=r(4421),E=r(8578),R=r(3315);let T=l.forwardRef(function(e,t){let{title:r,titleId:s,...a}=e;return l.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":s},a),r?l.createElement("title",{id:s},r):null,l.createElement("path",{fillRule:"evenodd",d:"M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z",clipRule:"evenodd"}))}),O=l.forwardRef(function(e,t){let{title:r,titleId:s,...a}=e;return l.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:t,"aria-labelledby":s},a),r?l.createElement("title",{id:s},r):null,l.createElement("path",{fillRule:"evenodd",d:"M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z",clipRule:"evenodd"}))});var I=r(3096),M=r(795);r(7650);var A=r(6101),U=Symbol("radix.slottable");function B(e){return l.isValidElement(e)&&"function"==typeof e.type&&"__radixId"in e.type&&e.type.__radixId===U}var D=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"].reduce((e,t)=>{let r=function(e){let t=function(e){let t=l.forwardRef((e,t)=>{var r,s,a;let n,o,{children:i,...c}=e,d=l.isValidElement(i)?(o=(n=null==(s=Object.getOwnPropertyDescriptor((r=i).props,"ref"))?void 0:s.get)&&"isReactWarning"in n&&n.isReactWarning)?r.ref:(o=(n=null==(a=Object.getOwnPropertyDescriptor(r,"ref"))?void 0:a.get)&&"isReactWarning"in n&&n.isReactWarning)?r.props.ref:r.props.ref||r.ref:void 0,u=(0,A.s)(d,t);if(l.isValidElement(i)){let e=function(e,t){let r={...t};for(let s in t){let l=e[s],a=t[s];/^on[A-Z]/.test(s)?l&&a?r[s]=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let s=a(...t);return l(...t),s}:l&&(r[s]=l):"style"===s?r[s]={...l,...a}:"className"===s&&(r[s]=[l,a].filter(Boolean).join(" "))}return{...e,...r}}(c,i.props);return i.type!==l.Fragment&&(e.ref=u),l.cloneElement(i,e)}return l.Children.count(i)>1?l.Children.only(null):null});return t.displayName="".concat(e,".SlotClone"),t}(e),r=l.forwardRef((e,r)=>{let{children:a,...n}=e,o=l.Children.toArray(a),i=o.find(B);if(i){let e=i.props.children,a=o.map(t=>t!==i?t:l.Children.count(e)>1?l.Children.only(null):l.isValidElement(e)?e.props.children:null);return(0,s.jsx)(t,{...n,ref:r,children:l.isValidElement(e)?l.cloneElement(e,void 0,a):null})}return(0,s.jsx)(t,{...n,ref:r,children:a})});return r.displayName="".concat(e,".Slot"),r}(`Primitive.${t}`),a=l.forwardRef((e,l)=>{let{asChild:a,...n}=e;return"undefined"!=typeof window&&(window[Symbol.for("radix-ui")]=!0),(0,s.jsx)(a?r:t,{...n,ref:l})});return a.displayName=`Primitive.${t}`,{...e,[t]:a}},{}),z=l.forwardRef((e,t)=>(0,s.jsx)(D.label,{...e,ref:t,onMouseDown:t=>{var r;t.target.closest("button, input, select, textarea")||(null==(r=e.onMouseDown)||r.call(e,t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}}));z.displayName="Label";var _=r(2085),W=r(9434);let P=(0,_.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),$=l.forwardRef((e,t)=>{let{className:r,...l}=e;return(0,s.jsx)(z,{ref:t,className:(0,W.cn)(P(),r),...l})});function F(e){let{isOpen:t,onClose:r,storyId:a,onShareStory:n}=e,[i,c]=(0,l.useState)(""),[d,m]=(0,l.useState)(""),[x,h]=(0,l.useState)(!0),[g,f]=(0,l.useState)(!0),[p,v]=(0,l.useState)(!1),[b,j]=(0,l.useState)(null),[w,y]=(0,l.useState)(!1),k=async()=>{v(!0);try{let e={originalStoryId:a,title:i||void 0,description:d||void 0,visibility:x?S.gu.PUBLIC:S.gu.UNLISTED,allowForking:g},t=await n(e);if(t&&t.slug){let e=window.location.origin,r="".concat(e,"/character/dialogue/?slug=").concat(t.slug);j(r)}}catch(e){console.error("Failed to share story:",e)}finally{v(!1)}},C=()=>{p||(j(null),c(""),m(""),h(!0),f(!0),y(!1),r())};return(0,s.jsx)(N.lG,{open:t,onOpenChange:C,children:(0,s.jsxs)(N.Cf,{className:"bg-opacity-90 bg-background backdrop-blur-sm z-150",children:[(0,s.jsx)(N.c7,{children:(0,s.jsx)(N.L3,{children:"分享故事"})}),b?(0,s.jsxs)("div",{className:"py-4 space-y-4",children:[(0,s.jsx)("p",{className:"text-sm text-[var(--text-secondary)]",children:"故事已成功分享! 您可以复制以下链接分享给他人:"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(u.p,{value:b,readOnly:!0,className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus flex-1"}),(0,s.jsx)(o.$,{onClick:()=>{b&&navigator.clipboard.writeText(b).then(()=>{y(!0),setTimeout(()=>y(!1),2e3)}).catch(e=>{console.error("无法复制到剪贴板:",e)})},variant:"outline",size:"icon",className:"".concat(w?"bg-green-500 text-white":"bg-[var(--bg-secondary)] border-[var(--border-color)]"),children:(0,s.jsx)(I.DDb,{className:"h-4 w-4"})})]}),w&&(0,s.jsx)("p",{className:"text-xs text-green-500",children:"已复制到剪贴板"}),(0,s.jsx)(N.Es,{children:(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:C,children:"关闭"})})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"py-4 space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)($,{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"故事标题 (可选)"}),(0,s.jsx)(u.p,{value:i,onChange:e=>c(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"保持为空以使用原始故事标题"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)($,{className:"block text-sm font-medium text-[var(--text-secondary)] mb-1",children:"描述 (可选)"}),(0,s.jsx)(u.p,{value:d,onChange:e=>m(e.target.value),className:"bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)] input-focus",placeholder:"添加故事描述"})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)($,{className:"text-sm font-medium text-[var(--text-secondary)]",children:"公开分享"}),(0,s.jsx)(M.d,{checked:x,onCheckedChange:h})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)($,{className:"text-sm font-medium text-[var(--text-secondary)]",children:"允许其他用户衍生"}),(0,s.jsx)(M.d,{checked:g,onCheckedChange:f})]})]}),(0,s.jsxs)(N.Es,{children:[(0,s.jsx)(o.$,{variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:C,children:"取消"}),(0,s.jsx)(o.$,{onClick:k,variant:"outline",className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",disabled:p,children:p?"分享中...":"分享故事"})]})]})]})})}$.displayName=z.displayName;var V=r(9371),G=r(298);function H(e){var t,r;let{character:n,error:i,clearError:c}=e,d=(0,a.useRouter)(),[u,m]=(0,l.useState)(""),[x,h]=(0,l.useState)(!1),[f,p]=(0,l.useState)(""),[b,j]=(0,l.useState)(!1),[N,M]=(0,l.useState)(!1),A=(0,C.G)(L.xu),U=(0,C.G)(L.vc),[B,D]=(0,l.useState)(!1),[z,_]=(0,l.useState)(null),[W,P]=(0,l.useState)(!1),[$,H]=(0,l.useState)(!1),[q,K]=(0,l.useState)(!0),[Z,Q]=(0,l.useState)("fade-in-up"),X=(0,l.useRef)(null),J=(0,l.useRef)(null),[Y,ee]=(0,l.useState)(0),et=(0,C.j)(),[er,es]=(0,l.useState)(!1),{currentStoryId:el,currentCharacterId:ea,messages:en,isLoading:eo,isSending:ei,error:ec,sendMessage:ed,addMessage:eu,sendStreamMessage:em,fetchCurStoryHistory:ex}=(0,g.Z3)(),{createStory:eh,fetchStories:eg,updateStoryTitle:ef}=(0,g.R7)(),{tempContext:ep,initTempContext:ev,updateTempTitle:eb}=(0,g.ki)(),{formatChat:ej}=(0,R.L)(),ew=(0,C.G)(G.jQ),[ey,eN]=(0,l.useState)("");(0,l.useEffect)(()=>{ew&&ew.title?eN(ew.title):N&&ep&&ep.title?eN(ep.title):eN("")},[ew,N,ep]);let ek=N&&ep?ep.messages:en,eC=async e=>{if(e!==ey){eN(e);try{el?await ef(el,e)||console.error("Failed to update story title"):N&&ep&&eb(e)}catch(e){console.error("Error updating story title:",e)}}},eL=(0,l.useCallback)(e=>{let t=window.innerWidth<768;if(B||x||er)return;let r=e.target;r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement||r instanceof HTMLSelectElement||r.isContentEditable||"BUTTON"===r.tagName||("/"===e.key||e.ctrlKey&&"f"===e.key?(e.preventDefault(),t?eR():P(!0)):"Escape"===e.key&&W&&(e.preventDefault(),eT()))},[W,B,x,er]);(0,l.useEffect)(()=>(window.addEventListener("keydown",eL),()=>{window.removeEventListener("keydown",eL)}),[eL]),(0,l.useEffect)(()=>{n&&!el&&(ev(n),ee(0))},[eg,n,el,ev]),(0,l.useEffect)(()=>{!el&&ea?M(!0):el&&ea?M(!1):(console.error("currentStoryId",el),console.error("currentCharacterId",ea))},[el,ea]),(0,l.useEffect)(()=>{X.current&&X.current.scrollIntoView({behavior:"smooth"})},[en,ek]),(0,l.useEffect)(()=>{if(console.log("isSending 滚动到最新消息",ei),ei){X.current&&X.current.scrollIntoView({behavior:"smooth"});let e=setTimeout(()=>{X.current&&(X.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 延迟500ms"))},500),t=setTimeout(()=>{X.current&&(X.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 延迟1500ms"))},1500);return()=>{clearTimeout(e),clearTimeout(t)}}if(!1===ei){let e=setTimeout(()=>{X.current&&(X.current.scrollIntoView({behavior:"smooth"}),console.log("滚动到最新消息 - 发送完成"))},300);return()=>clearTimeout(e)}},[ei]),(0,l.useEffect)(()=>{if(q){let e=setTimeout(()=>{Q("fade-out-down"),setTimeout(()=>{K(!1)},300)},5e3);return()=>clearTimeout(e)}},[q]),(0,l.useEffect)(()=>{let e=()=>{Q("fade-out-down"),setTimeout(()=>{K(!1)},300)};return window.addEventListener("click",e),window.addEventListener("touchstart",e),()=>{window.removeEventListener("click",e),window.removeEventListener("touchstart",e)}},[]),(0,l.useEffect)(()=>{if(x&&n){let e=(null==A?void 0:A.username)||"用户";p("".concat(e,"和").concat(n.name,"的浪漫故事"))}},[x,A,n]),(0,l.useEffect)(()=>{if(i){let e=setTimeout(()=>{c()},5e3);return()=>clearTimeout(e)}},[i,c]);let eS=()=>{u.trim()&&n&&(u.length>1e3||(X.current&&X.current.scrollIntoView({behavior:"smooth"}),eu({storyId:el,characterId:n.id,contentType:S._8.TEXT,content:u}).then(e=>{e&&(ed(e),m(""),setTimeout(()=>{X.current&&X.current.scrollIntoView({behavior:"smooth"})},100))})))},eE=async()=>{if(f.trim()&&n){if(!N)return void console.error("isCharaterMode",N);j(!0);try{let e=ek.map((e,t)=>({content:e.content,contentType:e.contentType,index:t,metadata:e.metadata||{}})),t={characterId:n.id,title:f,initialMessages:e};await eh(t)&&(eg(),m(""))}catch(e){console.error("Failed to create story:",e)}finally{j(!1),h(!1)}}},eR=()=>{P(!0),H(!0)},eT=()=>{P(!1),H(!1)},eO=async e=>{try{return{slug:(await V.a.createShareStory(e)).slug}}catch(e){throw console.error("Failed to share story:",e),e}};return n?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"pt-16 flex h-[calc(100vh-4rem)]",children:[(0,s.jsx)(y,{activeStoryId:el||"",isOpen:W,onClose:eT,searchMode:$}),(0,s.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden relative w-full z-0",children:[(0,s.jsxs)("div",{className:"bg-card p-3 sm:p-4 flex items-center border-b border-border",children:[(0,s.jsx)("button",{onClick:()=>P(!0),className:"mr-3 text-foreground p-1 md:hidden","aria-label":"打开侧边栏",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),(0,s.jsx)("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),(0,s.jsx)("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),(0,s.jsx)("div",{className:"relative h-10 w-10 sm:h-12 sm:w-12 rounded-full overflow-hidden mr-3 sm:mr-4 flex-shrink-0",children:(0,s.jsxs)(w.eu,{className:"h-full w-full",children:[(0,s.jsx)(w.BK,{src:n.avatarUrl,alt:n.name,className:"object-cover",shouldBlur:n.shouldBlurAvatar}),(0,s.jsx)(w.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(t=n.name)?void 0:t.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("h2",{className:"text-lg sm:text-xl font-bold text-foreground truncate",children:n.name}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:eR,className:"text-foreground p-2 rounded-full hover:bg-muted transition-colors md:hidden","aria-label":"搜索聊天",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]})}),(0,s.jsx)("button",{onClick:()=>D(!0),className:"text-foreground p-2 rounded-full hover:bg-muted transition-colors","aria-label":"设置",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})})]})]}),(0,s.jsx)("p",{className:"text-muted-foreground text-xs sm:text-sm truncate",children:n.description})]})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto p-3 sm:p-4 bg-background relative z-5",style:z?{backgroundImage:"url(".concat(z,")"),backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"}:{},children:[z&&(0,s.jsx)("div",{className:"absolute inset-0 bg-background z-0"}),(0,s.jsx)("div",{className:"mx-auto w-full relative z-5",style:{maxWidth:"1800px"},children:(0,s.jsxs)("div",{className:"space-y-3 sm:space-y-4 relative z-5",children:[ek.map((e,t)=>{var r,l;return(0,s.jsxs)("div",{className:"flex ".concat(e.role===S.hE.USER?"justify-end":"justify-start"),children:[e.role!==S.hE.USER&&(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(w.eu,{className:"h-full w-full",children:[(0,s.jsx)(w.BK,{src:n.avatarUrl,alt:n.name,className:"object-cover",shouldBlur:n.shouldBlurAvatar}),(0,s.jsx)(w.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(r=n.name)?void 0:r.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsxs)("div",{className:"max-w-[80%] sm:max-w-[70%] rounded-lg p-2 sm:p-3 flex flex-col ".concat(e.role===S.hE.USER?"border bg-[var(--bg-tertiary)] border-[var(--border-color)] text-[var(--text-primary)]":"bg-card text-foreground"),children:[(0,s.jsx)("div",{className:"whitespace-pre-wrap text-sm sm:text-base [&_pre]:overflow-x-auto [&_pre]:whitespace-pre-wrap [&_pre]:word-wrap-break-word [&_code]:break-words",dangerouslySetInnerHTML:{__html:ej(e.content,n.name,{date:new Date().toLocaleDateString(),time:new Date().toLocaleTimeString()})}}),(0,s.jsx)("p",{className:"text-[10px] sm:text-xs opacity-70 mt-1 self-end",children:new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),N&&ep&&0===t&&e.role===S.hE.ASSISTANT&&n.greetings&&n.greetings.length>1&&(0,s.jsxs)("div",{className:"flex items-center mt-2 self-center space-x-1",children:[(0,s.jsx)("button",{onClick:()=>{let e=0===Y?n.greetings.length-1:Y-1;ee(e),et((0,E.XB)({newGreeting:n.greetings[e]}))},className:"p-1 rounded-full hover:bg-muted transition-colors","aria-label":"Previous greeting",children:(0,s.jsx)(T,{className:"h-4 w-4 text-foreground"})}),(0,s.jsx)("span",{className:"text-xs text-muted-foreground",children:"".concat(Y+1," / ").concat(n.greetings.length)},"greeting-counter-".concat(Y)),(0,s.jsx)("button",{onClick:()=>{let e=Y===n.greetings.length-1?0:Y+1;ee(e),et((0,E.XB)({newGreeting:n.greetings[e]}))},className:"p-1 rounded-full hover:bg-muted transition-colors","aria-label":"Next greeting",children:(0,s.jsx)(O,{className:"h-4 w-4 text-foreground"})})]})]}),e.role===S.hE.USER&&(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 ml-2",children:(0,s.jsxs)(w.eu,{className:"h-full w-full",children:[(0,s.jsx)(w.BK,{src:U,alt:(null==A?void 0:A.username)||"用户",className:"object-cover"}),(0,s.jsx)(w.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==A||null==(l=A.username)?void 0:l.charAt(0).toUpperCase())||"U"})]})})]},e.id)}),ei&&(0,s.jsxs)("div",{className:"flex justify-start",children:[(0,s.jsx)("div",{className:"h-7 w-7 sm:h-8 sm:w-8 rounded-full overflow-hidden flex-shrink-0 mr-2",children:(0,s.jsxs)(w.eu,{className:"h-full w-full",children:[(0,s.jsx)(w.BK,{src:n.avatarUrl,alt:n.name,className:"object-cover",shouldBlur:n.shouldBlurAvatar}),(0,s.jsx)(w.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(r=n.name)?void 0:r.charAt(0).toUpperCase())||"C"})]})}),(0,s.jsx)("div",{className:"bg-card text-foreground rounded-lg p-2 sm:p-3 max-w-[80%] sm:max-w-[70%]",children:(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.2s"}}),(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse",style:{animationDelay:"0.4s"}})]})})]}),(0,s.jsx)("div",{ref:X})]})})]}),(0,s.jsx)("div",{className:"bg-background relative z-20",children:(0,s.jsxs)("div",{className:"mx-auto w-full",style:{maxWidth:"1800px"},children:[i&&(0,s.jsx)("div",{className:"px-3 py-2 bg-destructive/50 text-destructive-foreground rounded-md text-sm mx-2 sm:mx-4 mt-2 sm:mt-3",children:(0,s.jsx)("p",{children:i})}),(0,s.jsx)("div",{className:"flex justify-center items-center p-2 sm:p-4",children:(0,s.jsxs)("div",{className:"relative flex items-center w-full",children:[(0,s.jsx)("button",{className:"absolute left-3 sm:left-4 text-primary/70 hidden sm:block",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,s.jsx)("path",{d:"M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z"})})}),!el&&(null==n?void 0:n.id)?(0,s.jsx)("button",{onClick:()=>{h(!0)},className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 sm:pl-12 pr-12 sm:pr-16 py-2 sm:py-3 text-sm sm:text-base text-[var(--text-primary)] focus:outline-none hover:bg-[var(--bg-tertiary)]/90 transition-colors",children:"创建故事"}):(0,s.jsx)("textarea",{ref:J,value:u,onChange:e=>{m(e.target.value),e.target.value.length>1e3||i&&e.target.value.length<=1e3&&c()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eS())},placeholder:"输入消息 (Shift+Enter 换行)",className:"w-full bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-full pl-4 sm:pl-12 pr-24 sm:pr-28 py-2 sm:py-3 text-sm sm:text-base text-[var(--text-primary)] focus:outline-none input-focus resize-none scrollbar scrollbar-thin scrollbar-track-[var(--bg-secondary)] scrollbar-thumb-[var(--primary)]/20 hover:scrollbar-thumb-[var(--primary)]/40",rows:1}),el&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{className:"absolute right-12 sm:right-14 bg-[var(--primary)] h-7 w-7 sm:h-8 sm:w-8 rounded-full flex items-center justify-center hover:bg-[var(--primary-hover)]",onClick:eS,disabled:ei||u.length>1e3||""===u.trim(),children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"text-primary-foreground",children:[(0,s.jsx)("path",{d:"M22 2L11 13"}),(0,s.jsx)("path",{d:"M22 2L15 22L11 13L2 9L22 2Z"})]})}),(0,s.jsx)("button",{className:"absolute right-3 sm:right-4 bg-[var(--bg-tertiary)] h-7 w-7 sm:h-8 sm:w-8 rounded-full flex items-center justify-center border border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]/90",onClick:()=>es(!0),disabled:ei,"aria-label":"分享故事",children:(0,s.jsx)(I.qfV,{className:"h-4 w-4 text-[var(--text-primary)]"})})]})]})})]})})]}),q&&!W&&!B&&(0,s.jsx)("div",{className:"fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-card text-foreground px-4 py-2 rounded-lg shadow-lg text-sm md:hidden z-10 ".concat("fade-in-up"===Z?"animate-fade-in-up":"animate-fade-out-down"),children:(0,s.jsx)("p",{children:'提示: 按 "/" 键快速搜索'})}),(0,s.jsx)(v,{isOpen:B,onClose:()=>D(!1),onBackgroundChange:e=>{_(e)},chatTitle:ey,onChatTitleChange:eC})]}),x&&(0,s.jsx)(k,{isOpen:x,onClose:()=>h(!1),title:f,onTitleChange:p,onStoryCreated:eE,isCreating:b}),er&&el&&(0,s.jsx)(F,{isOpen:er,onClose:()=>es(!1),storyId:el,onShareStory:eO})]}):(0,s.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"角色不存在"}),(0,s.jsx)("p",{className:"mb-8",children:"无法找到该角色，请返回角色库选择其他角色。"}),(0,s.jsx)(o.$,{className:"bg-primary text-foreground",onClick:()=>d.push("/characters"),children:"返回角色库"})]})}var q=r(2847),K=r(8613);function Z(){return(0,s.jsxs)("main",{className:"min-h-screen bg-background relative",children:[(0,s.jsx)(n.default,{}),(0,s.jsx)(l.Suspense,{fallback:(0,s.jsx)(Q,{}),children:(0,s.jsx)(X,{})})]})}function Q(){return(0,s.jsxs)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:[(0,s.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-primary motion-reduce:animate-[spin_1.5s_linear_infinite]",children:(0,s.jsx)("span",{className:"sr-only",children:"Loading..."})}),(0,s.jsx)("p",{className:"ml-3 text-foreground",children:"正在加载聊天数据..."})]})}function X(){let e=(0,a.useRouter)(),t=(0,a.useSearchParams)(),r=null==t?void 0:t.get("characterId"),n=null==t?void 0:t.get("storyId"),[o,i]=(0,l.useState)(null),{clearCurrentStoryContext:c}=(0,g.w0)(),{currentUser:d}=(0,K.Jd)(),{currentCharacter:u,isLoading:m,error:x}=(0,q.OE)(),{fetchCharacterById:h}=(0,q.MM)(),{fetchStoryToCurStoryContext:f,isLoading:p,fetchStories:v,currentStoryId:b}=(0,g.R7)(),{error:j,clearErrors:w,isLoading:y,currentStory:N,fetchCurStoryHistory:k}=(0,g.Z3)();return((0,l.useEffect)(()=>{console.log("Effect: Fetch stories triggered"),d&&v()},[d,v]),(0,l.useEffect)(()=>{console.log("Effect: Fetch story context triggered, storyId:",n),n?f(n):c()},[n,f,c]),(0,l.useEffect)(()=>{let e=null==N?void 0:N.characterId;console.log("Effect: Fetch character and history for story triggered, charId:",e),e&&(h(e),k(0,30))},[null==N?void 0:N.characterId,h,k]),(0,l.useEffect)(()=>{console.log("Effect: Fetch character by URL ID triggered, characterId:",r,"storyId:",n),r&&!n&&h(r)},[r,n,h]),y||m||p)?(0,s.jsx)("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:(0,s.jsx)("span",{className:"text-foreground",children:"正在加载聊天数据..."})}):u?(0,s.jsx)(H,{character:u,error:o||x||j,clearError:w}):(0,s.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"正在加载角色..."}),(0,s.jsx)("p",{className:"mb-8",children:"请稍候，如果长时间未响应或角色不存在，请返回角色库选择其他角色。"}),(0,s.jsx)("button",{className:"bg-primary/20 hover:bg-primary/30 px-4 py-2 rounded",onClick:()=>e.push("/characters"),children:"返回角色库"})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[951,320,105,428,702,500,698,838,613,917,441,684,358],()=>t(6773)),_N_E=e.O()}]);