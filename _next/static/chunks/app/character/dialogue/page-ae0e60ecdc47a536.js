(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[193],{3141:(e,r,a)=>{"use strict";a.d(r,{default:()=>p});var t=a(5155),s=a(2115),l=a(5695),c=a(7694),n=a(6821),d=a(285),i=a(7374),o=a(9371),x=a(2045),h=a(1795),m=a(3315),v=a(1394),g=a(3500),u=a(5175);function b(){var e;(0,l.useParams)();let r=(0,l.useRouter)(),a=(0,l.useSearchParams)(),c=(0,x.G)(h.xu),{forkSharedStory:n}=(0,g.R7)(),{formatChat:b}=(0,m.L)(),p=a.get("slug"),[f,j]=(0,s.useState)(null),[N,y]=(0,s.useState)([]),[w,k]=(0,s.useState)(!0),[S,A]=(0,s.useState)(!1),[U,C]=(0,s.useState)(!1);(0,s.useEffect)(()=>{(async()=>{if(!p)return k(!1);try{let e=await o.a.getSharedStoryBySlug(p);if(console.log("storyData.messagesSnapshot",JSON.stringify(e.messagesSnapshot)),j(e),e.messagesSnapshot&&e.messagesSnapshot.length>0){let r=e.messagesSnapshot.map((e,r)=>{let a="string"==typeof e.createdAt?new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"未知时间",t="USER"===e.role?"user":"character";return{id:r.toString(),sender:t,content:e.content,timestamp:a}});y(r)}k(!1)}catch(e){console.error("Failed to fetch shared story:",e),i.oR.error("无法加载共享对话"),k(!1)}})()},[p]);let R=()=>{if(!c)return void document.dispatchEvent(new CustomEvent("open-login-modal",{detail:{tab:"login"}}));try{if(C(!0),!(null==f?void 0:f.characterId))return void i.oR.error("无法找到角色信息");r.push("/chat?characterId=".concat(f.characterId))}catch(e){console.error("导航错误:",e),i.oR.error("跳转失败，请重试"),C(!1)}},D=async()=>{if(!c)return void document.dispatchEvent(new CustomEvent("open-login-modal",{detail:{tab:"login"}}));try{if(C(!0),!p)return void i.oR.error("无法找到故事信息");let e=await n(p);e?r.push("/chat?storyId=".concat(e)):(i.oR.error("创建对话失败，请重试"),C(!1))}catch(e){console.error("分享故事衍生失败:",e),i.oR.error("跳转失败，请重试"),C(!1)}};if(w)return(0,t.jsx)("div",{className:"pt-24 pb-16 px-4 text-center",children:(0,t.jsx)("p",{className:"text-foreground",children:"加载中..."})});if(!f)return(0,t.jsxs)("div",{className:"pt-24 pb-16 px-4 text-foreground text-center",children:[(0,t.jsx)("h1",{className:"text-3xl font-bold mb-4",children:"对话不存在"}),(0,t.jsx)("p",{className:"mb-8",children:"无法找到该对话，请返回角色库选择其他角色。"}),(0,t.jsx)(d.$,{className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:()=>r.push("/characters"),children:"返回角色库"})]});let E=f.characterSnapshot||{name:"未知角色",description:"",avatarUrl:"/backgrounds/default-avatar.jpg"},I=(e=>{let r=new Date,a=new Date(e),t=r.getTime()-a.getTime(),s=Math.floor(t/36e5);if(s<1){let e=Math.floor(t/6e4);return"".concat(e," 分钟前")}{if(s<24)return"大约 ".concat(s," 小时前");let e=Math.floor(s/24);return"".concat(e," 天前")}})(f.sharedAt);return(0,t.jsxs)("div",{className:"flex-grow overflow-y-auto",children:[(0,t.jsxs)("div",{className:"max-w-4xl mx-auto pt-24 pb-16 px-4",children:[(0,t.jsxs)("div",{className:"bg-card rounded-lg shadow-md p-6 mb-8",children:[(0,t.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:f.title}),(0,t.jsxs)("div",{className:"flex items-center mt-2",children:[(0,t.jsx)("span",{className:"text-muted-foreground text-sm",children:I}),(0,t.jsx)("span",{className:"mx-2 text-muted-foreground/60",children:"•"}),(0,t.jsx)("span",{className:"text-muted-foreground text-sm",children:"分享"})]})]}),(0,t.jsx)(d.$,{className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:()=>A(!0),disabled:U,children:"开始对话"})]}),(0,t.jsxs)("div",{className:"flex items-center mt-4 p-3 bg-[var(--bg-secondary)] rounded-lg",children:[(0,t.jsx)("div",{className:"h-10 w-10 rounded-full overflow-hidden mr-3 flex-shrink-0",children:(0,t.jsxs)(v.eu,{className:"h-full w-full",children:[(0,t.jsx)(v.BK,{src:f.sharingUserAvatarUrl||"/backgrounds/default-avatar.jpg",alt:f.sharingUserNickname,className:"object-cover"}),(0,t.jsx)(v.q5,{className:"bg-[var(--bg-tertiary)] text-[var(--text-primary)]",children:(null==(e=f.sharingUserNickname)?void 0:e.charAt(0).toUpperCase())||"U"})]})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-foreground font-medium",children:f.sharingUserNickname}),(0,t.jsx)("p",{className:"text-muted-foreground text-xs",children:"分享者"})]})]})]}),(0,t.jsx)("div",{className:"bg-card rounded-lg shadow-md p-4 mb-8",children:(0,t.jsx)("div",{className:"space-y-4",children:f.messagesSnapshot&&f.messagesSnapshot.map((e,r)=>{let a,s="USER"===e.role;return e.createdAt instanceof Date?a=e.createdAt:"string"==typeof e.createdAt||"number"==typeof e.createdAt?a=new Date(e.createdAt):(console.warn("Unexpected createdAt type, using current time as fallback:",e.createdAt),a=new Date),isNaN(a.getTime())&&(console.warn("Resulting createdAtDate is invalid, using current time as fallback."),a=new Date),(0,t.jsx)(u.q,{message:{id:r.toString(),storyId:"",content:e.content,createdAt:a,role:e.role},isUserMessage:s,characterAppearance:{name:E.name,avatarUrl:E.avatarUrl},userAppearance:{name:f.sharingUserNickname,avatarUrl:f.sharingUserAvatarUrl},formatChatContent:b,storyId:f.id||"",onDelete:()=>{},onUpdate:()=>{},onRegenerate:()=>{}},r.toString())})})}),(0,t.jsxs)("div",{className:"flex justify-center gap-4",children:[(0,t.jsx)(d.$,{className:"bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:R,disabled:U,children:"全新对话"}),(0,t.jsx)(d.$,{className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:D,disabled:U,children:U?"跳转中...":"基于此继续"})]})]}),S&&(0,t.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:(0,t.jsxs)("div",{className:"bg-card rounded-lg shadow-xl p-6 max-w-md w-full",children:[(0,t.jsx)("h3",{className:"text-xl font-bold text-foreground mb-4",children:"选择对话方式"}),(0,t.jsx)("p",{className:"text-muted-foreground mb-6",children:"你可以选择开始一个全新的对话，或者基于当前对话继续聊天。"}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)(d.$,{className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:R,disabled:U,children:U?"跳转中...":"全新对话"}),(0,t.jsx)(d.$,{className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:D,disabled:U,children:U?"跳转中...":"基于此继续"}),(0,t.jsx)(d.$,{className:"w-full bg-[var(--bg-secondary)] border-[var(--border-color)] hover:bg-[var(--bg-tertiary)]",onClick:()=>A(!1),disabled:U,children:"取消"})]})]})})]})}function p(){return(0,t.jsxs)("main",{className:"h-screen bg-background overflow-hidden flex flex-col",children:[(0,t.jsx)(c.default,{}),(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)(f,{}),children:(0,t.jsx)(b,{})}),(0,t.jsx)(n.default,{})]})}function f(){return(0,t.jsxs)("div",{className:"pt-24 pb-16 px-4 text-center",children:[(0,t.jsx)("div",{className:"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent text-primary motion-reduce:animate-[spin_1.5s_linear_infinite]",children:(0,t.jsx)("span",{className:"sr-only",children:"Loading..."})}),(0,t.jsx)("p",{className:"mt-2 text-foreground",children:"正在加载对话内容..."})]})}},4515:(e,r,a)=>{Promise.resolve().then(a.bind(a,3141))},6821:(e,r,a)=>{"use strict";a.d(r,{default:()=>n});var t=a(5155),s=a(6874),l=a.n(s),c=a(6766);function n(){return(0,t.jsx)("footer",{className:"bg-[var(--bg-primary)] text-[var(--text-primary)] py-16 px-4",children:(0,t.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-8",children:[(0,t.jsxs)("div",{className:"col-span-1 md:col-span-1",children:[(0,t.jsx)(l(),{href:"/",className:"inline-block mb-4",children:(0,t.jsx)(c.default,{src:"https://ext.same-assets.com/715601384/683049629.png",alt:"QuackAI",width:120,height:30,className:"mb-4"})}),(0,t.jsx)("p",{className:"text-sm text-[var(--text-secondary)] mb-4",children:"基于酒馆(SillyTavern)的AI角色扮演平台，提供免搭建酒馆，同时提供轻享版角色互动"}),(0,t.jsx)("div",{className:"flex space-x-4",children:(0,t.jsx)(l(),{href:"https://discord.gg/RBDVwJdFh3",target:"_blank",rel:"noopener noreferrer",className:"text-[var(--text-primary)] hover:text-[var(--text-secondary)]",children:(0,t.jsx)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",children:(0,t.jsx)("path",{d:"M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z"})})})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-bold text-lg mb-4",children:"产品"}),(0,t.jsxs)("ul",{className:"space-y-2",children:[(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"#",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"酒馆 | STUDIO"})}),(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"#",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"聊天 | CHAT"})}),(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"#",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"酒馆 | SILLYTAVERN"})})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-bold text-lg mb-4",children:"资源"}),(0,t.jsxs)("ul",{className:"space-y-2",children:[(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"#",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"API KEY"})}),(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"#",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"使用说明"})}),(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"#",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"教程计划"})})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-bold text-lg mb-4",children:"关于"}),(0,t.jsxs)("ul",{className:"space-y-2",children:[(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"https://discord.gg/RBDVwJdFh3",target:"_blank",rel:"noopener noreferrer",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"加入社区"})}),(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"#",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"在线地址"})}),(0,t.jsx)("li",{children:(0,t.jsx)(l(),{href:"#",className:"text-[var(--text-secondary)] hover:text-[var(--text-primary)]",children:"福利领取"})})]})]})]}),(0,t.jsx)("div",{className:"border-t border-[var(--border-color)] mt-12 pt-8 text-center text-sm text-[var(--text-secondary)]",children:(0,t.jsxs)("p",{children:["\xa9 ",new Date().getFullYear()," QuackAI. All rights reserved."]})})]})})}}},e=>{var r=r=>e(e.s=r);e.O(0,[951,320,105,428,116,455,476,907,613,127,694,561,441,684,358],()=>r(4515)),_N_E=e.O()}]);